<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midsummer's Bird</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg-color: #ffffff;
            --text-color: #1a1a1d;
            --text-secondary-color: #65676b;
            --border-color: #dcdfe3;
            --primary-color: #5E5B9D;
            --primary-hover-color: #7875b3;
            --input-bg-color: #e4e6eb;
            --user-bubble-color: #5E5B9D;
            --ai-bubble-color: #FFFFFF;
            --bubble-opacity: 0.95;
            --bubble-text-color: #1a1a1d;
            --user-bubble-text-color: #FFFFFF;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        
        #app-wrapper {
            transition: padding-left 0.3s ease;
        }

        .card {
            background-color: var(--card-bg-color);
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background-color: var(--card-bg-color);
            box-shadow: 2px 0 12px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transform: translateX(0);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .nav-link {
            color: var(--text-secondary-color);
        }
        .nav-link:hover, .nav-link.active {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }

        .primary-gradient-text {
            background: linear-gradient(135deg, var(--primary-color), #a3a1d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.2s ease;
        }
        .btn-primary:hover { background-color: var(--primary-hover-color); }
        .btn-primary:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: var(--input-bg-color);
            color: var(--text-color);
        }
        .btn-secondary:hover { background-color: #d8dbe0; }
        .btn-secondary:disabled {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
        }


        .modal-overlay {
            position: fixed; inset: 0;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .modal-overlay.active { display: flex; }
        .sub-modal { z-index: 60; }
        .super-sub-modal { z-index: 70; }

        /* ç§»åŠ¨ç«¯æ¨¡æ€æ¡†é€‚é… */
        @media (max-width: 768px) {
            .modal-overlay {
                padding: 0.5rem;
            }
            .sub-modal .modal-content {
                max-width: 100% !important;
                max-height: 95vh !important;
                overflow-y: auto !important;
                width: auto !important;
                height: auto !important;
            }
            .sub-modal .modal-content .card {
                padding: 1rem !important;
            }
            .sub-modal h2 {
                font-size: 1.25rem !important;
            }
            .sub-modal input, .sub-modal textarea, .sub-modal select {
                font-size: 16px !important; /* é˜²æ­¢iOSç¼©æ”¾ */
            }
        }

        /* ä¿å­˜æç¤ºtoast */
        .save-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            border-left: 4px solid #10b981;
        }
        .save-toast.show {
            transform: translateX(0);
        }
        .save-toast .icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #10b981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .save-toast .message {
            color: var(--text-color);
            font-weight: 500;
        }
        @media (max-width: 768px) {
            .save-toast {
                right: 10px;
                left: 10px;
                top: 10px;
                padding: 12px 16px;
            }
        }
        
        .light-input {
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .light-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(94, 91, 157, 0.2);
        }

        ::-webkit-scrollbar { width: 0; height: 0; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background-color: transparent;
        }
        ::-webkit-scrollbar-thumb:hover { background-color: transparent; }

        /* å®Œå…¨éšè—æ‰€æœ‰æ»šåŠ¨æ¡ */
        * {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        *::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 6px;
            background: #e4e6eb;
            border-radius: 5px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px;
            background: var(--primary-color);
            cursor: pointer; border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        input[type="checkbox"].switch {
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            width: 38px;
            height: 22px;
            border-radius: 11px;
            background-color: #ccc;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        input[type="checkbox"].switch::before {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 18px; height: 18px;
            border-radius: 50%;
            background-color: white;
            transition: transform 0.2s;
        }
        input[type="checkbox"].switch:checked {
            background-color: var(--primary-color);
        }
        input[type="checkbox"].switch:checked::before {
            transform: translateX(16px);
        }

        .prompt-entry:hover, .regex-script-item:hover, .char-item:hover { background-color: var(--bg-color); }
        .drag-handle { cursor: grab; }
        .sortable-ghost { opacity: 0.5; background: #e4e6eb; }

        .wi-entry-item.active, .char-item.active {
            background-color: var(--primary-color) !important;
            color: white;
        }
         .wi-entry-item.active .text-gray-500, .char-item.active .text-gray-500 {
            color: rgba(255,255,255,0.8);
         }
        .fa-star.favorited { color: #facc15; }

        /* Chat styles */
        .message-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .chat-message-group:hover .message-actions {
            opacity: 1;
        }
        .rendered-html-iframe {
            width: 100%;
            height: 80vh;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .chat-bubble {
            color: var(--bubble-text-color);
            opacity: var(--bubble-opacity);
            cursor: pointer;
        }
        .chat-bubble.user-bubble {
            background-color: var(--user-bubble-color);
            color: var(--user-bubble-text-color);
        }
        .chat-bubble.ai-bubble {
            background-color: var(--ai-bubble-color);
        }
        .chat-bubble.selected {
             border: 2px solid var(--primary-color) !important;
        }
        
        /* Message Menu */
        .msg-menu {
            position: absolute;
            background: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 0;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 120px;
            --arrow-position: 50%;
        }
        .msg-menu::before {
            content: '';
            position: absolute;
            bottom: -7px;
            left: var(--arrow-position, 50%);
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 7px solid var(--card-bg-color);
        }
        .msg-menu-item { padding: 10px 16px; color: var(--text-color); cursor: pointer; white-space: nowrap; font-size: 14px; }
        .msg-menu-item:hover { background: var(--bg-color); }
        .msg-menu-item.danger { color: #e74c3c; }

        /* Message Editing */
        .message-editing-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 150;
            padding: 1rem;
        }
        .message-editing-modal.active {
            display: flex;
        }
        .message-editing-modal .modal-content {
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transition: max-width 0.3s ease, max-height 0.3s ease;
        }
        .message-editing-modal.expanded .modal-content {
            max-width: 95vw;
            max-height: 95vh;
        }
        .message-editing-modal.expanded .message-edit-textarea {
            min-height: 400px;
        }
        .message-edit-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            background: var(--card-bg-color);
            color: var(--text-color);
        }
        .message-edit-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(94, 91, 157, 0.2);
        }
        .message-action-btn {
            padding: 4px 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border-radius: 6px;
            background: var(--input-bg-color);
            color: var(--text-color);
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            font-size: 12px;
        }
        .message-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .message-action-btn.danger {
            background: #fee;
            color: #e74c3c;
            border-color: #fcc;
        }
        .message-action-btn.danger:hover {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        /* Multi-select Mode - æ ·å¼ä¿ç•™ä½†åŠŸèƒ½å·²ç§»é™¤ */
        .multi-select-mode .chat-message-group { cursor: pointer; }
        .multi-select-mode .chat-message-group:hover { background: rgba(94, 91, 157, 0.05); }
        .multi-select-mode .msg-menu { display: none !important; }

        /* Character Select with Avatar */
        .char-select-wrapper {
            position: relative;
        }
        .char-select-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--input-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
        }
        .char-select-preview img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .char-select-preview:hover {
            border-color: var(--primary-color);
        }
        #char-select {
            position: relative;
            background-image: none;
            padding-left: 44px;
        }
        .char-avatar-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Reply Message */
        .reply-reference { 
            background: rgba(0,0,0,0.05); 
            border-left: 3px solid var(--primary-color);
            padding: 8px 12px; 
            margin-bottom: 8px; 
            border-radius: 4px; 
            font-size: 13px; 
            color: var(--text-secondary-color);
            max-height: 60px; overflow: hidden; 
        }
        .reply-reference .reply-from { color: var(--primary-color); font-weight: bold; margin-bottom: 2px; }

        /* Image Styles */
        .image-bubble {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
        }
        .image-message img {
            max-width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
        }

        /* Theme Modal Styles */
        .theme-preset-btn {
            border: 2px solid var(--border-color);
        }
        .theme-preset-btn:hover, .theme-preset-btn.active {
            border-color: var(--primary-color);
        }
        .theme-preset-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        .color-input {
            width: 40px;
            height: 40px;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 8px;
        }
        .color-text {
            font-family: monospace;
        }

        /* Advanced API Modal Styles */
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; }
        .status-ready { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-testing { background: #ffc107; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }


        /* Markdownå’ŒHTMLæ¸²æŸ“æ ·å¼ */
        .message-content code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content strong {
            font-weight: 700;
        }

        .message-content em {
            font-style: italic;
        }

        .message-content a {
            text-decoration: underline;
        }

        .message-content blockquote {
            border-left: 4px solid #ccc;
            padding-left: 16px;
            margin: 12px 0;
            color: #666;
            font-style: italic;
        }

        .message-content ul, .message-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin: 4px 0;
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .message-content hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 16px 0;
        }

        .message-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 8px 0;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }

        .message-content table td, .message-content table th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .message-content table th {
            background-color: rgba(0, 0, 0, 0.05);
            font-weight: bold;
        }

    </style>
</head>
<body>

    <aside id="sidebar" class="sidebar collapsed">
        <div class="flex items-center justify-between p-4 h-16 border-b border-gray-200 flex-shrink-0">
            <h1 class="text-lg font-bold primary-gradient-text whitespace-nowrap overflow-hidden">
                <span>midsummer's bird</span>
            </h1>
        </div>
        <nav id="main-nav" class="flex-grow p-4 space-y-2">
            <button data-modal="api-settings-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.api" title="API è®¾ç½®"><i class="fas fa-robot text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.api">API è®¾ç½®</span></button>
            <button data-modal="character-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.character" title="è§’è‰²å¡"><i class="fas fa-user-astronaut text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.character">è§’è‰²å¡</span></button>
            <button data-modal="presets-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.presets" title="AI é¢„è®¾"><i class="fas fa-sliders-h text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.presets">AI é¢„è®¾</span></button>
            <button data-modal="world-info-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.worldInfo" title="ä¸–ç•Œä¹¦"><i class="fas fa-book text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.worldInfo">ä¸–ç•Œä¹¦</span></button>
            <button data-modal="regex-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.regex" title="æ­£åˆ™è¡¨è¾¾å¼"><i class="fas fa-code text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.regex">æ­£åˆ™è¡¨è¾¾å¼</span></button>
            <button data-modal="theme-settings-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.theme" title="ä¸»é¢˜è®¾ç½®"><i class="fas fa-palette text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.theme">ä¸»é¢˜è®¾ç½®</span></button>
            <button data-modal="preferences-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.preferences" title="åå¥½è®¾ç½®"><i class="fas fa-sliders text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.preferences">åå¥½è®¾ç½®</span></button>
            <button data-modal="user-profile-modal" class="nav-link w-full flex items-center gap-4 p-3 rounded-lg text-left" data-i18n-title="sidebar.user" title="ç”¨æˆ·/UIè®¾ç½®"><i class="fas fa-cog text-xl w-6 text-center"></i><span class="font-medium" data-i18n="sidebar.user">ç”¨æˆ·/UIè®¾ç½®</span></button>
        </nav>
    </aside>

    <div id="app-wrapper">
        <main class="min-h-screen">
            <div class="card flex flex-col h-screen">
                <header class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                    <div class="flex items-center gap-3">
                         <button id="mobile-sidebar-toggle" class="p-2 -ml-2 text-gray-500 hover:text-primary-color">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <img id="char-avatar-header" src="https://placehold.co/40x40/5E5B9D/ffffff?text=AI" class="w-10 h-10 rounded-full object-cover">
                        <h2 id="char-name-header" class="text-xl font-bold">No Character Loaded</h2>
                    </div>
                    <button id="reselect-greeting-btn" class="btn-secondary px-3 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm" data-i18n-title="chat.reselectGreeting" title="é‡æ–°é€‰æ‹©å¼€åœºç™½">
                        <i class="fas fa-redo mr-1"></i><span data-i18n="chat.reselectGreeting">é‡é€‰å¼€åœºç™½</span>
                    </button>
                </header>
                <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                    </div>
                <footer class="p-4 border-t border-gray-200 flex-shrink-0">
                     <div id="reply-status-container"></div>
                    <div class="flex items-center gap-2">
                        <!-- å·¦ä¾§èœå•æŒ‰é’® -->
                        <div class="relative">
                            <button id="chat-menu-btn" class="w-10 h-10 flex items-center justify-center btn-secondary rounded-lg hover:bg-gray-300 transition-colors flex-shrink-0" data-i18n-title="chat.moreOptions" title="æ›´å¤šé€‰é¡¹">
                                <i class="fas fa-plus text-lg"></i>
                            </button>
                            <!-- å¼¹å‡ºèœå• -->
                            <div id="chat-menu-panel" class="hidden absolute bottom-12 left-0 bg-white border border-gray-200 rounded-lg shadow-lg p-2 min-w-[180px]">
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-view-prompt-btn">
                                    <i class="fas fa-eye text-purple-500"></i>
                                    <span data-i18n="chat.viewPrompt">æŸ¥çœ‹æç¤ºè¯</span>
                                </button>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-new-chat-btn">
                                    <i class="fas fa-sync-alt text-green-500"></i>
                                    <span data-i18n="chat.newChat">æ–°å¯¹è¯</span>
                                </button>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-image-btn">
                                    <i class="fas fa-image text-blue-500"></i>
                                    <span data-i18n="chat.sendImage">å‘é€å›¾ç‰‡</span>
                                </button>
                                <div class="border-t border-gray-200 my-1"></div>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-summarize-btn">
                                    <i class="fas fa-compress-alt text-purple-500"></i>
                                    <span data-i18n="chat.summarize">æ€»ç»“èŠå¤©</span>
                                </button>
                                <div class="border-t border-gray-200 my-1"></div>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-export-config-btn">
                                    <i class="fas fa-download text-orange-500"></i>
                                    <span data-i18n="chat.exportConfig">å¯¼å‡ºé…ç½®</span>
                                </button>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-import-config-btn">
                                    <i class="fas fa-upload text-orange-500"></i>
                                    <span data-i18n="chat.importConfig">å¯¼å…¥é…ç½®</span>
                                </button>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-export-chat-btn">
                                    <i class="fas fa-file-download text-indigo-500"></i>
                                    <span data-i18n="chat.exportChat">å¯¼å‡ºèŠå¤©è®°å½•</span>
                                </button>
                                <button class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-gray-100 text-left" id="menu-import-chat-btn">
                                    <i class="fas fa-file-upload text-indigo-500"></i>
                                    <span data-i18n="chat.importChat">å¯¼å…¥èŠå¤©è®°å½•</span>
                                </button>
                            </div>
                            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                            <input type="file" id="config-file-input" accept=".json" class="hidden">
                            <input type="file" id="chat-file-input" accept=".json" class="hidden">
                        </div>
                        <!-- è¾“å…¥æ¡† -->
                        <textarea id="chat-input" class="flex-1 light-input rounded-lg p-2.5 resize-none" data-i18n-placeholder="chat.inputPlaceholder" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" style="min-height: 40px; max-height: 200px;"></textarea>
                        <!-- å‘é€æŒ‰é’® -->
                        <button id="send-button" class="w-10 h-10 flex-shrink-0 btn-primary text-white rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center" data-i18n-title="chat.sendMessage" title="å‘é€æ¶ˆæ¯">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <!-- API å®¢æˆ·ç«¯æ¨¡å— -->
    <script>
        // ç®€åŒ–çš„ API å®¢æˆ·ç«¯
        class SimpleAPIClient {
            constructor(config) {
                this.config = config;
            }

            async chat(messages, options = {}) {
                const { stream = false, onMessage = null } = options;
                const url = new URL(this.config.url);

                let endpoint = `${this.config.url.replace(/\/$/, '')}/chat/completions`;
                let headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.config.key}`
                };

                let body = {
                    model: this.config.model,
                    messages: messages,
                    stream: stream,
                    max_tokens: options.maxTokens || 1024,
                    temperature: options.temperature || 0.7
                };

                // Google Gemini ç‰¹æ®Šå¤„ç†
                if (url.hostname.includes('google')) {
                    endpoint = `${url.origin}/v1beta/models/${this.config.model}:generateContent?key=${this.config.key}`;
                    delete headers.Authorization;

                    const userMessages = messages.filter(m => m.role !== 'system');
                    const systemMessage = messages.find(m => m.role === 'system');

                    if (systemMessage && userMessages.length > 0) {
                        userMessages[0].content = systemMessage.content + '\n\n' + userMessages[0].content;
                    }

                    body = {
                        contents: userMessages.map(m => ({
                            role: m.role === 'assistant' ? 'model' : 'user',
                            parts: [{ text: m.content }]
                        })),
                        generationConfig: {
                            maxOutputTokens: options.maxTokens || 1024,
                            temperature: options.temperature || 0.7
                        }
                    };
                    stream = false; // Gemini ä¸æ”¯æŒæµå¼
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }

                if (stream && !url.hostname.includes('google')) {
                    return this.handleStreamResponse(response, onMessage);
                } else {
                    const data = await response.json();
                    if (data.choices) {
                        return { choices: [{ message: { content: data.choices[0].message.content } }] };
                    } else if (data.candidates) {
                        return { choices: [{ message: { content: data.candidates[0].content.parts[0].text } }] };
                    }
                    throw new Error('Unknown response format');
                }
            }

            async handleStreamResponse(response, onMessage) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const json = JSON.parse(data);
                                const delta = json.choices?.[0]?.delta?.content;
                                if (delta) {
                                    fullContent += delta;
                                    if (onMessage) {
                                        onMessage(delta, fullContent);
                                    }
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯
                            }
                        }
                    }
                }

                return { choices: [{ message: { content: fullContent } }] };
            }

            async testConnection() {
                try {
                    const response = await this.chat([
                        { role: 'user', content: 'Hi' }
                    ], { maxTokens: 5 });
                    return { success: true, message: 'è¿æ¥æˆåŠŸï¼' };
                } catch (error) {
                    return { success: false, message: error.message };
                }
            }
        }

        // å…¨å±€ API å®ä¾‹
        window.apiClient = null;
    </script>

    <div id="api-settings-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text" data-i18n="api.title">API è®¾ç½®</h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4 overflow-y-auto pr-4 -mr-4">
                <div class="p-4 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium mb-2" data-i18n="api.configManage">API é…ç½®ç®¡ç†</label>
                    <div class="flex gap-2">
                        <select id="savedApiSelect" class="flex-1 light-input rounded-md p-2"></select>
                        <button id="loadApiBtn" class="btn-secondary px-3 rounded-lg" data-i18n-title="api.loadSelected" title="åŠ è½½é€‰ä¸­é…ç½®"><i class="fas fa-check"></i></button>
                        <button id="deleteApiBtn" class="btn-secondary px-3 rounded-lg hover:bg-red-100 hover:text-red-500" data-i18n-title="api.deleteSelected" title="åˆ é™¤é€‰ä¸­é…ç½®"><i class="fas fa-trash"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div><label class="block text-sm font-medium mb-1" data-i18n="api.configName">é…ç½®åç§°</label><input id="apiConfigNameInput" type="text" data-i18n-placeholder="api.configNamePlaceholder" placeholder="ä¸ºæ­¤é…ç½®å‘½å" class="w-full light-input rounded-md p-2"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1" data-i18n="api.url">API URL (OpenAI æ ¼å¼)</label>
                    <input id="api-url" type="text" class="w-full light-input rounded-md p-2" data-i18n-placeholder="api.placeholder.url">
                    <div class="text-xs text-gray-500 mt-1 space-y-1">
                        <div><b data-i18n="api.supportedFormats">æ”¯æŒæ ¼å¼:</b> DeepSeek, OpenAI, SiliconFlow, Google Gemini ç­‰.</div>
                        <div class="text-red-500"><b data-i18n="api.note">æ³¨æ„:</b> <span data-i18n="api.googleKeyNote">Google APIå¯†é’¥ä»¥ `AIza...` å¼€å¤´.</span></div>
                    </div>
                </div>
                <div><label class="block text-sm font-medium mb-1" data-i18n="api.key">API Key</label><input id="api-key" type="password" class="w-full light-input rounded-md p-2" data-i18n-placeholder="api.placeholder.key"></div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1" data-i18n="api.model">æ¨¡å‹åˆ—è¡¨</label>
                        <select id="model-select" class="w-full light-input rounded-md p-2 hidden"></select>
                        <input id="model-name" type="text" class="w-full light-input rounded-md p-2" data-i18n-placeholder="api.modelPlaceholder" placeholder="ä¾‹å¦‚ gpt-4-turbo">
                    </div>
                    <div class="flex flex-col">
                        <label class="block text-sm font-medium mb-1 invisible">å ä½</label>
                        <div class="flex items-center gap-2">
                            <label class="flex items-center gap-2 cursor-pointer flex-1 min-w-0">
                                <input id="api-streaming-toggle" type="checkbox" class="w-4 h-4 accent-primary-color flex-shrink-0">
                                <span class="text-sm truncate" data-i18n="api.streaming">æµå¼ä¼ è¾“</span>
                            </label>
                            <button id="load-models-btn" class="py-2 px-3 btn-primary rounded-lg text-sm whitespace-nowrap flex-shrink-0">
                                <i class="fas fa-sync-alt mr-1"></i><span data-i18n="api.loadModels">åˆ·æ–°</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="api-test-result" class="text-sm mt-2 text-center h-auto min-h-[1rem]"></div>

                <hr class="my-4 border-gray-200">
                <h3 class="text-lg font-semibold primary-gradient-text" data-i18n="api.visionTitle">ğŸ–¼ï¸ è¯†å›¾ API è®¾ç½® (å¯é€‰)</h3>
                <p class="text-xs text-gray-500 mb-3" data-i18n="api.visionDescription">ç”¨äºå‘é€å›¾ç‰‡æ—¶è®©AIèƒ½å¤Ÿç†è§£å›¾ç‰‡å†…å®¹ã€‚</p>

                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1" data-i18n="api.visionUrl">è¯†å›¾ API URL</label>
                        <input id="vision-api-url" type="text" class="w-full light-input rounded-md p-2" data-i18n-placeholder="api.placeholder.url">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1" data-i18n="api.visionKey">è¯†å›¾ API Key</label>
                        <input id="vision-api-key" type="password" class="w-full light-input rounded-md p-2" data-i18n-placeholder="api.placeholder.key">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1" data-i18n="api.visionModel">è¯†å›¾æ¨¡å‹</label>
                        <select id="vision-model-select" class="w-full light-input rounded-md p-2 hidden"></select>
                        <button id="load-vision-models-btn" class="w-full mt-2 py-2 btn-primary rounded-lg text-sm">
                            <i class="fas fa-sync-alt mr-1"></i><span data-i18n="api.loadVisionModels">åŠ è½½è¯†å›¾æ¨¡å‹</span>
                        </button>
                    </div>
                </div>

                <div id="vision-api-test-result" class="text-sm mt-3 text-center h-auto min-h-[1rem]"></div>

                <div class="flex flex-wrap gap-4 pt-4 mt-auto">
                    <button id="saveAsNewBtn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="api.saveAsNew">å¦å­˜ä¸ºæ–°é…ç½®</button>
                    <button id="updateCurrentBtn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="api.updateCurrent">æ›´æ–°å½“å‰é…ç½®</button>
                </div>
                <div class="flex flex-wrap gap-4">
                    <button id="testApiConnection" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="api.testConnection">æµ‹è¯•è¿æ¥</button>
                    <button id="debugModelsBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="api.debugModels">è°ƒè¯•æ¨¡å‹</button>
                    <button id="directChatTestBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="api.directChatTest">ç›´æ¥æµ‹è¯•èŠå¤©</button>
                </div>
            </div>
        </div>
    </div>
    <div id="presets-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-6 rounded-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0"><h2 class="text-2xl font-bold primary-gradient-text" data-i18n="presets.title">AI é¢„è®¾</h2><button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button></div>
            <div class="flex flex-1 flex-col gap-6 overflow-hidden">
                <div class="w-full flex flex-col border-b border-gray-200 pb-4">
                    <div class="flex gap-2 mb-4"><button class="flex-1 py-2 text-sm btn-secondary rounded" onclick="document.getElementById('preset-import-json').click()" data-i18n="presets.import">å¯¼å…¥</button><input type="file" id="preset-import-json" accept=".json" class="hidden"><button id="preset-export-json" class="flex-1 py-2 text-sm btn-secondary rounded" data-i18n="presets.export">å¯¼å‡º</button></div>
                    <div id="preset-list" class="flex-1 overflow-y-auto space-y-2 pr-2"></div>
                    <div class="mt-4"><button id="save-as-preset-btn" class="w-full py-2 btn-primary rounded-lg" data-i18n="presets.saveAsNew">å¦å­˜ä¸ºæ–°é¢„è®¾</button></div>
                </div>
                <div class="w-full flex flex-1 flex-col gap-6 overflow-hidden">
                    <div id="preset-editor" class="w-full overflow-y-auto pr-2 space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg mb-2" data-i18n="presets.samplingParams">é‡‡æ ·å‚æ•°</h3>
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-calculator mr-1"></i>
                                <span data-i18n="presets.estimatedTokens">é¢„ä¼°Token:</span> <span id="preset-token-estimate" class="font-bold text-primary-color">0</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Temperature</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-temp" min="0" max="2" step="0.01"><input type="number" id="param-temp-value" min="0" max="2" step="0.01" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Top P</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-top-p" min="0" max="1" step="0.01"><input type="number" id="param-top-p-value" min="0" max="1" step="0.01" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Top K</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-top-k" min="0" max="100" step="1"><input type="number" id="param-top-k-value" min="0" max="100" step="1" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Frequency Penalty</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-freq-pen" min="-2" max="2" step="0.01"><input type="number" id="param-freq-pen-value" min="-2" max="2" step="0.01" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Presence Penalty</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-pres-pen" min="-2" max="2" step="0.01"><input type="number" id="param-pres-pen-value" min="-2" max="2" step="0.01" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <div class="grid grid-cols-5 gap-4 items-center"><label class="text-sm col-span-2">Repetition Penalty</label><div class="col-span-3 flex items-center gap-2"><input type="range" id="param-rep-pen" min="0" max="2" step="0.01"><input type="number" id="param-rep-pen-value" min="0" max="2" step="0.01" class="w-20 rounded-md p-1 text-center light-input"></div></div>
                        <hr class="border-gray-200">
                        <div class="grid grid-cols-5 gap-4 items-center">
                            <label class="text-sm col-span-2">Max Response Tokens</label>
                            <input type="number" id="param-max-tokens" min="1" max="8192" step="1" class="light-input rounded-md p-1 col-span-3">
                        </div>
                        <div class="grid grid-cols-5 gap-4 items-center">
                            <label class="text-sm col-span-2">Context Size (Tokens)</label>
                            <input type="number" id="param-context-size" min="1" max="32768" step="1" class="light-input rounded-md p-1 col-span-3">
                        </div>
                        <div class="p-3 bg-gray-100 rounded-lg text-xs text-gray-600">
                            <div class="flex justify-between mb-1">
                                <span data-i18n="presets.remainingContext">å‰©ä½™ä¸Šä¸‹æ–‡ï¼š</span>
                                <span id="remaining-context" class="font-bold">0</span>
                            </div>
                            <div class="w-full bg-gray-300 rounded-full h-2">
                                <div id="context-usage-bar" class="bg-primary-color h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div id="prompt-editor" class="w-full flex flex-col overflow-hidden border-gray-200">
                        <div class="flex justify-between items-center mb-2 flex-shrink-0">
                             <h3 class="font-bold text-lg" data-i18n="presets.promptEntries">æç¤ºè¯æ¡ç›®</h3>
                             <div class="flex items-center gap-2">
                                <button id="add-prompt-btn" class="w-8 h-8 flex items-center justify-center btn-secondary rounded-md" data-i18n-title="presets.addEntry" title="æ·»åŠ æ–°æ¡ç›®"><i class="fas fa-plus"></i></button>
                                <button id="restore-prompts-btn" class="w-8 h-8 flex items-center justify-center btn-secondary rounded-md" data-i18n-title="presets.restoreDefaults" title="æ¢å¤é»˜è®¤"><i class="fas fa-undo"></i></button>
                             </div>
                        </div>
                        <div id="prompt-list" class="flex-1 overflow-y-auto space-y-2 pr-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="character-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-0 flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text flex items-center gap-3"><i class="fas fa-user-astronaut"></i><span data-i18n="char.title">è§’è‰²ç®¡ç†</span></h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </header>
            <div class="flex-1 flex flex-col gap-0 overflow-hidden">
                <!-- è§’è‰²é€‰æ‹©åŒºåŸŸ -->
                <div class="p-4 space-y-3 flex-shrink-0 border-b border-gray-200">
                    <label class="block text-sm font-medium" data-i18n="char.current">å½“å‰è§’è‰²</label>

                    <!-- è§’è‰²é¢„è§ˆå¡ç‰‡ï¼ˆç‚¹å‡»æ‰“å¼€å¼¹çª—ï¼‰ -->
                    <div id="char-preview-card" class="p-3 rounded-lg border-2 border-gray-200 hover:border-primary-color cursor-pointer transition-all bg-white">
                        <div class="flex items-center gap-3">
                            <img id="current-char-avatar-preview" src="https://placehold.co/48x48/5E5B9D/ffffff?text=AI" class="w-12 h-12 rounded-full object-cover border-2 border-primary-color">
                            <div class="flex-1">
                                <p id="current-char-name-preview" class="font-bold text-lg" data-i18n="char.noSelect">æœªé€‰æ‹©è§’è‰²</p>
                                <p class="text-sm text-gray-500" data-i18n="char.clickSelect">ç‚¹å‡»é€‰æ‹©æˆ–åˆ›å»ºè§’è‰²</p>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                       <button id="char-new-btn" class="py-2 text-sm btn-secondary rounded-lg"><i class="fas fa-plus"></i> <span data-i18n="char.new">æ–°å»ºè§’è‰²</span></button>
                       <button id="open-char-selector-btn" class="py-2 text-sm btn-primary rounded-lg"><i class="fas fa-users"></i> <span data-i18n="char.switch">åˆ‡æ¢è§’è‰²</span></button>
                    </div>

                    <div class="flex gap-2">
                        <button id="char-import-btn" class="flex-1 py-2 text-sm btn-secondary rounded-lg"><i class="fas fa-upload"></i> <span data-i18n="char.import">å¯¼å…¥è§’è‰²</span></button>
                        <input type="file" id="char-import-file" class="hidden" accept=".json,.png">
                    </div>
                </div>

                <!-- è§’è‰²ç¼–è¾‘å™¨ -->
                <div id="char-editor-panel" class="w-full flex-1 flex flex-col overflow-y-auto p-4">
                    <div id="char-editor-placeholder" class="text-center text-gray-500 my-auto">
                        <i class="fas fa-users fa-3x mb-4"></i>
                        <p data-i18n="char.selectTip">é€‰æ‹©ä¸€ä¸ªè§’è‰²è¿›è¡Œç¼–è¾‘ï¼Œæˆ–å¯¼å…¥/æ–°å»ºä¸€ä¸ªè§’è‰²ã€‚</p>
                    </div>
                    <div id="char-editor-content" class="hidden w-full h-full flex flex-col gap-4">
                        <input type="hidden" id="char-editing-id">
                        <div class="flex items-start gap-4 flex-shrink-0">
                            <div class="flex-shrink-0 text-center">
                                <img id="char-editor-avatar" src="https://placehold.co/128x128/5E5B9D/ffffff?text=AI" class="w-32 h-32 rounded-lg object-cover mx-auto">
                                <label class="mt-2 text-sm text-primary-color hover:underline cursor-pointer" data-i18n="char.uploadAvatar">ä¸Šä¼ å¤´åƒ<input type="file" id="char-avatar-upload" class="hidden" accept="image/*"></label>
                            </div>
                            <div class="flex-1 space-y-3">
                                <input id="char-editor-name" type="text" data-i18n-placeholder="char.name" placeholder="è§’è‰²åç§°" class="w-full text-xl font-bold light-input rounded-md p-2">
                                <input id="char-editor-tags" type="text" data-i18n-placeholder="char.tags" placeholder="æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œå¦‚: å¥³æ€§, åŠ©æ‰‹, å¹»æƒ³ï¼‰" class="w-full text-sm light-input rounded-md p-2">
                                <div class="flex flex-wrap items-center gap-2">
                                     <button id="char-save-btn" class="py-1.5 px-4 text-sm btn-primary rounded-lg"><i class="fas fa-save mr-2"></i><span data-i18n="char.save">ä¿å­˜</span></button>
                                     <button id="char-export-btn" data-i18n-title="char.export" title="å¯¼å‡ºä¸º .json" class="w-9 h-9 btn-secondary rounded-lg"><i class="fas fa-download"></i></button>
                                     <button id="char-duplicate-btn" data-i18n-title="char.duplicate" title="å¤åˆ¶" class="w-9 h-9 btn-secondary rounded-lg"><i class="fas fa-clone"></i></button>
                                     <button id="char-delete-btn" data-i18n-title="char.delete" title="åˆ é™¤" class="w-9 h-9 btn-secondary rounded-lg hover:bg-red-100 hover:text-red-600"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-3 flex-1 overflow-y-auto">
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="char-editor-desc" class="block text-sm font-medium" data-i18n="char.description">è§’è‰²æè¿° (æ€§æ ¼, å¤–è²Œ, å¯¹è¯ç¤ºä¾‹ç­‰)</label>
                                    <button class="text-primary-color hover:text-primary-hover-color" onclick="openTextEditModal('desc', 'è§’è‰²æè¿°')" data-i18n-title="char.expandEdit" title="æ”¾å¤§ç¼–è¾‘">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                                <textarea id="char-editor-desc" class="w-full light-input rounded-md p-2 resize-y" rows="6"></textarea>
                            </div>
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="char-editor-first-mes" class="block text-sm font-medium" data-i18n="char.firstMessage">ç¬¬ä¸€æ¡æ¶ˆæ¯</label>
                                    <button class="text-primary-color hover:text-primary-hover-color" onclick="openTextEditModal('firstMes', 'ç¬¬ä¸€æ¡æ¶ˆæ¯')" data-i18n-title="char.expandEdit" title="æ”¾å¤§ç¼–è¾‘">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                                <textarea id="char-editor-first-mes" class="w-full light-input rounded-md p-2 resize-y" rows="4"></textarea>
                            </div>
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="block text-sm font-medium" data-i18n="char.alternateGreetings">å¤‡é€‰å¼€åœºç™½</label>
                                    <button id="add-greeting-btn" class="text-sm btn-primary px-3 py-1 rounded-lg">
                                        <i class="fas fa-plus mr-1"></i><span data-i18n="char.addGreeting">æ·»åŠ </span>
                                    </button>
                                </div>
                                <div id="alternate-greetings-list" class="space-y-2 max-h-64 overflow-y-auto">
                                    <!-- å¤‡é€‰å¼€åœºç™½åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                </div>
                            </div>
                            <div class="card p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="char-editor-creator-notes" class="block text-sm font-medium" data-i18n="char.creatorNotes">åˆ›ä½œè€…çš„æ³¨é‡Š</label>
                                    <button class="text-primary-color hover:text-primary-hover-color" onclick="openTextEditModal('creatorNotes', 'åˆ›ä½œè€…çš„æ³¨é‡Š')" data-i18n-title="char.expandEdit" title="æ”¾å¤§ç¼–è¾‘">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                                <textarea id="char-editor-creator-notes" class="w-full light-input rounded-md p-2 resize-y" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="world-info-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-0 flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text flex items-center gap-3">
                    <i class="fas fa-book"></i><span data-i18n="worldInfo.title">ä¸–ç•Œä¹¦</span>
                </h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </header>
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="w-full flex flex-col border-b border-gray-200">
                    <div class="p-3 space-y-2 flex-shrink-0 border-b border-gray-200">
                        <label class="block text-sm font-medium" data-i18n="worldInfo.select">é€‰æ‹©ä¸–ç•Œä¹¦</label>
                        <select id="wi-world-select" class="w-full light-input rounded-md p-2"></select>
                         <div class="grid grid-cols-2 gap-2">
                            <button id="wi-new-world-btn" class="py-2 text-sm btn-secondary rounded-lg"><i class="fas fa-plus"></i> <span data-i18n="worldInfo.newWorld">æ–°ä¸–ç•Œ</span></button>
                            <button id="wi-import-world-btn" class="py-2 text-sm btn-secondary rounded-lg"><i class="fas fa-upload"></i> <span data-i18n="worldInfo.import">å¯¼å…¥</span></button>
                            <input type="file" id="wi-import-file" class="hidden" accept=".json">
                            <button id="wi-export-world-btn" class="py-2 text-sm btn-secondary rounded-lg"><i class="fas fa-download"></i> <span data-i18n="worldInfo.export">å¯¼å‡º</span></button>
                            <button id="wi-delete-world-btn" class="py-2 text-sm btn-secondary rounded-lg hover:bg-red-100 hover:text-red-600"><i class="fas fa-trash"></i> <span data-i18n="worldInfo.delete">åˆ é™¤</span></button>
                        </div>
                    </div>
                    <div class="p-3 flex-shrink-0">
                        <button id="wi-new-entry-btn" class="w-full py-2 btn-primary rounded-lg"><i class="fas fa-plus mr-2"></i><span data-i18n="worldInfo.newEntry">æ–°å»ºæ¡ç›®</span></button>
                    </div>
                    <div id="wi-entry-list" class="overflow-y-auto p-3 pt-0 space-y-2" style="max-height: 30vh;">
                        </div>
                </div>
                <div id="wi-editor-panel" class="flex-1 flex flex-col overflow-y-auto p-3">
                    <div id="wi-editor-placeholder" class="text-center text-gray-500 my-auto">
                        <i class="fas fa-file-alt fa-3x mb-4"></i>
                        <p data-i18n="worldInfo.selectTip">é€‰æ‹©ä¸€ä¸ªæ¡ç›®è¿›è¡Œç¼–è¾‘ï¼Œæˆ–æ–°å»ºä¸€ä¸ªæ¡ç›®ã€‚</p>
                    </div>
                    <div id="wi-editor-content" class="hidden w-full h-full flex flex-col gap-4">
                        <input type="hidden" id="wi-editing-entry-id">
                        <div class="flex flex-wrap items-center gap-4 flex-shrink-0">
                            <label class="flex items-center gap-2 cursor-pointer"><input id="wi-entry-enabled" type="checkbox" class="w-5 h-5 accent-primary-color"><span data-i18n="worldInfo.enabled">å¯ç”¨</span></label>
                            <input id="wi-entry-name" type="text" data-i18n-placeholder="worldInfo.entryTitle" placeholder="æ¡ç›®æ ‡é¢˜ (å¯é€‰)" class="flex-1 light-input rounded-md p-2 min-w-[200px]">
                            <button id="wi-clone-entry-btn" data-i18n-title="worldInfo.clone" title="å…‹éš†" class="w-10 h-10 btn-secondary rounded-lg flex-shrink-0"><i class="fas fa-clone"></i></button>
                            <button id="wi-delete-entry-btn" data-i18n-title="worldInfo.delete" title="åˆ é™¤" class="w-10 h-10 btn-secondary rounded-lg hover:bg-red-100 hover:text-red-600 flex-shrink-0"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="card p-4">
                             <label class="block text-sm font-medium mb-2" data-i18n="worldInfo.primaryKeys">ä¸»è¦å…³é”®å­— (é€—å·åˆ†éš”)</label>
                             <textarea id="wi-entry-keys" class="w-full light-input rounded-md p-2 resize-y" rows="2"></textarea>
                             <div class="grid grid-cols-2 gap-4 mt-3 text-sm">
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-keys-case-sensitive" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.caseSensitive">åŒºåˆ†å¤§å°å†™</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-keys-whole-word" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.wholeWord">å®Œæ•´å•è¯</span></label>
                             </div>
                        </div>
                         <div class="card p-4 flex-1 flex flex-col overflow-hidden min-h-[200px]">
                            <label for="wi-entry-content" class="block text-sm font-medium mb-2" data-i18n="worldInfo.content">å†…å®¹</label>
                            <textarea id="wi-entry-content" class="w-full h-full flex-1 light-input rounded-md p-2 resize-y"></textarea>
                        </div>
                        <div class="card p-4 grid grid-cols-1 gap-4 text-sm flex-shrink-0">
                            <div><label class="block font-medium mb-1" data-i18n="worldInfo.position">æ’å…¥ä½ç½®</label>
                                <select id="wi-entry-position" class="w-full light-input rounded-md p-1.5">
                                    <option value="0">è§’è‰²å®šä¹‰ä¹‹å‰</option>
                                    <option value="1">è§’è‰²å®šä¹‰ä¹‹å</option>
                                    <option value="2">ç¤ºä¾‹æ¶ˆæ¯å‰ (â†‘EM)</option>
                                    <option value="3">ç¤ºä¾‹æ¶ˆæ¯å (â†“EM)</option>
                                    <option value="4">@D ğŸŸ¢[ç³»ç»Ÿ]åœ¨æ·±åº¦</option>
                                    <option value="5">@D ğŸŸ£[ç”¨æˆ·]åœ¨æ·±åº¦</option>
                                    <option value="6">@D ğŸ§ [AI]åœ¨æ·±åº¦</option>
                                </select>
                            </div>
                             <div><label class="block font-medium mb-1" data-i18n="worldInfo.role">è§’è‰²</label>
                                <select id="wi-entry-role" class="w-full light-input rounded-md p-1.5">
                                    <option value="0">ç³»ç»Ÿ</option>
                                    <option value="1">ç”¨æˆ·</option>
                                    <option value="2">AI</option>
                                </select>
                             </div>
                            <div><label class="block font-medium mb-1" data-i18n="worldInfo.depth">æ·±åº¦</label><input id="wi-entry-depth" type="number" value="4" class="w-full light-input rounded-md p-1.5"></div>
                             <div><label class="block font-medium mb-1" data-i18n="worldInfo.priority">ä¼˜å…ˆçº§</label><input id="wi-entry-priority" type="number" value="100" class="w-full light-input rounded-md p-1.5"></div>
                             <label class="flex items-center gap-2 cursor-pointer"><input id="wi-entry-constant" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.constant">æ€»æ˜¯å¯ç”¨ (Constant)</span></label>
                             <label class="flex items-center gap-2 cursor-pointer"><input id="wi-entry-selective" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.selective">é€‰æ‹©æ€§</span></label>
                             <label class="flex items-center gap-2 cursor-pointer"><input id="wi-entry-exclude-recursion" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.excludeRecursion">æ’é™¤é€’å½’</span></label>
                        </div>
                        <div class="card p-4">
                            <h4 class="font-medium mb-3 text-sm" data-i18n="worldInfo.matchSources">é¢å¤–åŒ¹é…æ¥æº</h4>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-char-desc" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchCharDesc">è§’è‰²æè¿°</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-char-pers" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchCharPers">è§’è‰²æ€§æ ¼</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-scenario" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchScenario">æƒ…æ™¯</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-user-profile" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchUserProfile">ç”¨æˆ·è®¾å®šæè¿°</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-char-notes" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchCharNotes">è§’è‰²å¤‡æ³¨</span></label>
                                <label class="flex items-center gap-2 cursor-pointer"><input id="wi-match-creator-notes" type="checkbox" class="wi-match-source w-4 h-4 accent-primary-color"><span data-i18n="worldInfo.matchCreatorNotes">åˆ›ä½œè€…çš„æ³¨é‡Š</span></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="regex-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-0 flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text flex items-center gap-3">
                    <i class="fas fa-code"></i><span data-i18n="regex.title">æ­£åˆ™è¡¨è¾¾å¼</span>
                </h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </header>
            <div class="flex-1 flex flex-col overflow-y-auto p-4 space-y-6">
                <div class="flex flex-wrap gap-2">
                    <button id="regex-new-global-btn" class="btn-secondary py-2 px-3 rounded-lg text-sm"><i class="fas fa-plus mr-2"></i><span data-i18n="regex.newGlobal">æ–°å»ºå…¨å±€æ­£åˆ™</span></button>
                    <button id="regex-new-local-btn" class="btn-secondary py-2 px-3 rounded-lg text-sm"><i class="fas fa-plus mr-2"></i><span data-i18n="regex.newLocal">æ–°å»ºå±€éƒ¨æ­£åˆ™</span></button>
                    <button id="regex-import-btn" class="btn-secondary py-2 px-3 rounded-lg text-sm"><i class="fas fa-upload mr-2"></i><span data-i18n="regex.import">å¯¼å…¥æ­£åˆ™</span></button>
                    <input type="file" id="regex-import-file" class="hidden" accept=".json">
                </div>

                <div id="global-regex-section">
                    <h3 class="text-lg font-semibold mb-2 border-b pb-2" data-i18n="regex.globalTitle">å…¨å±€æ­£åˆ™è„šæœ¬</h3>
                    <p class="text-sm text-gray-500 mb-3" data-i18n="regex.globalDesc">å½±å“æ‰€æœ‰è§’è‰²ï¼Œä¿å­˜åœ¨æœ¬åœ°è®¾å®šä¸­ã€‚</p>
                    <div id="global-regex-list" class="space-y-2">
                        </div>
                </div>

                <div id="local-regex-section">
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <h3 class="text-lg font-semibold" data-i18n="regex.localTitle">å±€éƒ¨æ­£åˆ™è„šæœ¬</h3>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <span class="text-sm" data-i18n="regex.enable">å¯ç”¨</span>
                            <input type="checkbox" id="local-regex-enable-toggle" class="switch">
                        </label>
                    </div>
                    <p class="text-sm text-gray-500 mb-3" data-i18n="regex.localDesc">åªå½±å“å½“å‰è§’è‰²ï¼Œä¿å­˜åœ¨è§’è‰²å¡ç‰‡ä¸­ã€‚</p>
                    <div id="local-regex-list" class="space-y-2">
                        </div>
                </div>
            </div>
        </div>
    </div>
    <div id="user-profile-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-0 flex flex-col">
            <header class="flex justify-between items-center p-4 border-b border-gray-200 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text flex items-center gap-3">
                    <i class="fas fa-users"></i><span data-i18n="user.title">ç”¨æˆ·ç®¡ç†</span>
                </h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </header>

            <div class="flex-1 flex flex-col gap-0 overflow-hidden">
                <!-- ç”¨æˆ·é€‰æ‹©åŒºåŸŸ -->
                <div class="p-4 space-y-3 flex-shrink-0 border-b border-gray-200">
                    <label class="block text-sm font-medium" data-i18n="user.currentUser">å½“å‰ç”¨æˆ·</label>

                    <!-- ç”¨æˆ·é¢„è§ˆå¡ç‰‡ï¼ˆç‚¹å‡»æ‰“å¼€å¼¹çª—ï¼‰ -->
                    <div id="user-preview-card" class="p-3 rounded-lg border-2 border-gray-200 hover:border-primary-color cursor-pointer transition-all bg-white">
                        <div class="flex items-center gap-3">
                            <img id="current-user-avatar-preview" src="https://placehold.co/48x48/E4E6EB/1A1A1D?text=U" class="w-12 h-12 rounded-full object-cover border-2 border-primary-color">
                            <div class="flex-1">
                                <p id="current-user-name-preview" class="font-bold text-lg">é»˜è®¤ç”¨æˆ·</p>
                                <p id="current-user-status-preview" class="text-sm text-gray-500">åœ¨çº¿</p>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button id="user-new-btn" class="py-2 text-sm btn-secondary rounded-lg">
                            <i class="fas fa-plus"></i> <span data-i18n="user.new">æ–°å»ºç”¨æˆ·</span>
                        </button>
                        <button id="open-user-selector-btn" class="py-2 text-sm btn-primary rounded-lg">
                            <i class="fas fa-users"></i> <span data-i18n="user.switch">åˆ‡æ¢ç”¨æˆ·</span>
                        </button>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç¼–è¾‘å™¨ -->
                <div class="w-full flex-1 flex flex-col overflow-y-auto p-4">
                    <div id="user-editor-placeholder" class="text-center text-gray-500 my-auto">
                        <i class="fas fa-user-circle fa-3x mb-4"></i>
                        <p data-i18n="user.selectTip">é€‰æ‹©ä¸€ä¸ªç”¨æˆ·è¿›è¡Œç¼–è¾‘ï¼Œæˆ–åˆ›å»ºæ–°ç”¨æˆ·ã€‚</p>
                    </div>

                    <div id="user-editor-content" class="hidden w-full h-full flex flex-col gap-4">
                        <input type="hidden" id="user-editing-id">

                        <!-- å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
                        <div class="flex items-start gap-4 flex-shrink-0">
                            <div class="flex-shrink-0 text-center">
                                <div class="relative">
                                    <img id="user-editor-avatar" src="https://placehold.co/128x128/E4E6EB/1A1A1D?text=U"
                                         class="w-32 h-32 rounded-lg object-cover">
                                    <label class="mt-2 text-sm text-primary-color hover:underline cursor-pointer block" data-i18n="user.uploadAvatar">
                                        ä¸Šä¼ å¤´åƒ
                                        <input type="file" id="user-avatar-upload" class="hidden" accept="image/*">
                                    </label>
                                </div>
                            </div>

                            <div class="flex-1 space-y-3">
                                <input id="user-editor-name" type="text" data-i18n-placeholder="user.name" placeholder="ç”¨æˆ·åç§°" class="w-full text-xl font-bold light-input rounded-md p-2">
                                <input id="user-editor-status" type="text" data-i18n-placeholder="user.status" placeholder="çŠ¶æ€/å¿ƒæƒ…" class="w-full light-input rounded-md p-2">
                                <div class="flex flex-wrap items-center gap-2">
                                    <button id="user-save-btn" class="py-1.5 px-4 text-sm btn-primary rounded-lg"><i class="fas fa-save mr-2"></i><span data-i18n="user.save">ä¿å­˜</span></button>
                                    <button id="user-use-btn" class="py-1.5 px-4 text-sm btn-secondary rounded-lg"><i class="fas fa-user-check mr-1"></i><span data-i18n="user.use">ä½¿ç”¨</span></button>
                                    <button id="user-duplicate-btn" data-i18n-title="user.duplicate" title="å¤åˆ¶" class="w-9 h-9 btn-secondary rounded-lg"><i class="fas fa-clone"></i></button>
                                    <button id="user-delete-btn" data-i18n-title="user.delete" title="åˆ é™¤" class="w-9 h-9 btn-secondary rounded-lg hover:bg-red-100 hover:text-red-600"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>

                        <!-- è¯¦ç»†è®¾å®šåŒºåŸŸ - ä½¿ç”¨å¡ç‰‡ç½‘æ ¼å¸ƒå±€ -->
                        <div class="grid grid-cols-1 gap-4 flex-1 overflow-y-auto">
                            <div class="card p-4 flex flex-col">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="user-editor-description" class="block text-sm font-medium" data-i18n="user.description">ç”¨æˆ·è§’è‰²æè¿°ï¼ˆå°†å‘é€ç»™AIï¼‰</label>
                                    <button class="text-primary-color hover:text-primary-hover-color" onclick="openUserTextEditModal('description', 'ç”¨æˆ·è§’è‰²æè¿°')" data-i18n-title="user.expandEdit" title="æ”¾å¤§ç¼–è¾‘">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                                <textarea id="user-editor-description"
                                          data-i18n-placeholder="user.descriptionPlaceholder"
                                          placeholder="æè¿°æ‚¨çš„è§’è‰²è®¾å®šï¼Œä¾‹å¦‚ï¼šä½ æ˜¯ä¸€åç¨‹åºå‘˜ï¼Œå–œæ¬¢æŠ€æœ¯è®¨è®º..."
                                          class="w-full flex-1 light-input rounded-md p-2 resize-none min-h-[120px]"></textarea>
                            </div>

                            <div class="card p-4 flex flex-col">
                                <div class="flex justify-between items-center mb-2">
                                    <label for="user-editor-system-prompt" class="block text-sm font-medium" data-i18n="user.systemPrompt">ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼Œå°†æ·»åŠ åˆ°ç³»ç»Ÿæ¶ˆæ¯ï¼‰</label>
                                    <button class="text-primary-color hover:text-primary-hover-color" onclick="openUserTextEditModal('systemPrompt', 'ç³»ç»Ÿæç¤ºè¯')" data-i18n-title="user.expandEdit" title="æ”¾å¤§ç¼–è¾‘">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                </div>
                                <textarea id="user-editor-system-prompt"
                                          data-i18n-placeholder="user.systemPromptPlaceholder"
                                          placeholder="ä¾‹å¦‚ï¼šè¯·ä»¥ä¸“ä¸šçš„æ–¹å¼å›ç­”æŠ€æœ¯é—®é¢˜..."
                                          class="w-full flex-1 light-input rounded-md p-2 resize-none min-h-[100px]"></textarea>
                            </div>

                            <!-- ç”¨æˆ·åå¥½è®¾ç½® -->
                            <div class="card p-4">
                                <h3 class="font-medium mb-3" data-i18n="user.preferences">åå¥½è®¾ç½®</h3>
                                <div class="space-y-3">
                                    <!-- è¯­è¨€é€‰æ‹© -->
                                    <div>
                                        <label for="language-select" class="block text-sm font-medium mb-1" data-i18n="user.language">ç•Œé¢è¯­è¨€</label>
                                        <select id="language-select" class="w-full light-input rounded-md p-2">
                                            <option value="zh">ä¸­æ–‡ (Chinese)</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="user-auto-announce" class="w-4 h-4 accent-primary-color">
                                            <span class="text-sm" data-i18n="user.autoAnnounce">è‡ªåŠ¨å‘é€ç”¨æˆ·æè¿°</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="user-show-typing" class="w-4 h-4 accent-primary-color">
                                            <span class="text-sm" data-i18n="user.showTyping">æ˜¾ç¤ºæ‰“å­—çŠ¶æ€</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-prompt-modal" class="modal-overlay sub-modal">
        <div class="modal-content card p-6" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
             <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold primary-gradient-text" data-i18n="edit.promptTitle">ç¼–è¾‘æç¤ºè¯æ¡ç›®</h2><div><button id="delete-prompt-btn" class="text-red-500 hover:text-red-700 mr-4"><i class="fas fa-trash"></i> <span data-i18n="edit.delete">åˆ é™¤</span></button><button class="close-sub-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button></div></div>
            <input type="hidden" id="edit-prompt-index">
            <div class="space-y-4">
                <div><label for="prompt-name-input" class="block text-sm font-medium mb-1" data-i18n="edit.promptName">åç§°</label><input id="prompt-name-input" type="text" class="w-full light-input rounded-md p-2"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="prompt-position-select" class="block text-sm font-medium mb-1" data-i18n="edit.promptPosition">ä½ç½®</label><select id="prompt-position-select" class="w-full light-input rounded-md p-2"><option value="0" data-i18n="edit.positionRelative">ç›¸å¯¹ (Relative)</option><option value="1" data-i18n="edit.positionInChat">åœ¨èŠå¤©ä¸­ (In-chat)</option></select></div>
                    <div><label for="prompt-depth-input" class="block text-sm font-medium mb-1" data-i18n="edit.promptDepth">æ·±åº¦ (Depth)</label><input id="prompt-depth-input" type="number" class="w-full light-input rounded-md p-2" min="0"></div>
                </div>
                <div><label for="prompt-content-input" class="block text-sm font-medium mb-1" data-i18n="edit.promptContent">å†…å®¹</label><textarea id="prompt-content-input" rows="8" class="w-full light-input rounded-md p-2 resize-y"></textarea></div>
                <button id="save-prompt-changes-btn" class="w-full py-2 btn-primary rounded-lg" data-i18n="edit.saveChanges">ä¿å­˜æ›´æ”¹</button>
            </div>
        </div>
    </div>

    <div id="edit-regex-modal" class="modal-overlay sub-modal">
        <div class="modal-content card p-6" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold primary-gradient-text" data-i18n="regexEdit.title">æ­£åˆ™è„šæœ¬ç¼–è¾‘å™¨</h2><button class="close-sub-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button></div>
            <input type="hidden" id="edit-regex-id">
            <input type="hidden" id="edit-regex-scope">
            <div class="space-y-4 text-sm">
                <div><label class="block font-medium mb-1" data-i18n="regexEdit.scriptName">è„šæœ¬åç§°</label><input id="regex-name-input" type="text" class="w-full light-input rounded-md p-2"></div>
                <div><label class="block font-medium mb-1" data-i18n="regexEdit.findPattern">æŸ¥æ‰¾æ­£åˆ™è¡¨è¾¾å¼</label><textarea id="regex-find-input" rows="3" class="w-full light-input rounded-md p-2 font-mono text-xs"></textarea></div>
                <div><label class="block font-medium mb-1" data-i18n="regexEdit.replaceWith">æ›¿æ¢ä¸º</label><textarea id="regex-replace-input" rows="3" class="w-full light-input rounded-md p-2 font-mono text-xs"></textarea></div>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block font-medium mb-1" data-i18n="regexEdit.scope">ä½œç”¨èŒƒå›´</label>
                        <div class="space-y-1 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-placement="0" class="regex-placement-cb w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.scopeUserInput">ç”¨æˆ·è¾“å…¥ (User Input)</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-placement="1" class="regex-placement-cb w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.scopeAIOutput">AIè¾“å‡º (AI Output)</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-placement="2" class="regex-placement-cb w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.scopeQuickReply">å¿«æ·å‘½ä»¤ (Quick Reply)</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" data-placement="3" class="regex-placement-cb w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.scopeWorldInfo">ä¸–ç•Œä¿¡æ¯ (World Info)</span></label>
                        </div>
                    </div>
                    <div>
                        <label class="block font-medium mb-1" data-i18n="regexEdit.options">å…¶ä»–é€‰é¡¹</label>
                        <div class="space-y-1 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer"><input id="regex-markdown-only" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.markdownOnly">ä»…å·²ç¦ç”¨ (Markdown Only)</span></label>
                            <label class="flex items-center gap-2 cursor-pointer"><input id="regex-prompt-only" type="checkbox" class="w-4 h-4 accent-primary-color"><span data-i18n="regexEdit.promptOnly">åœ¨ç¼–è¾‘æ—¶è¿è¡Œ (Prompt Only)</span></label>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block font-medium mb-1" data-i18n="regexEdit.minDepth">æœ€å°æ·±åº¦</label><input id="regex-min-depth" type="number" data-i18n-placeholder="regexEdit.noLimit" placeholder="æ— é™" class="w-full light-input rounded-md p-2"></div>
                    <div><label class="block font-medium mb-1" data-i18n="regexEdit.maxDepth">æœ€å¤§æ·±åº¦</label><input id="regex-max-depth" type="number" data-i18n-placeholder="regexEdit.noLimit" placeholder="æ— é™" class="w-full light-input rounded-md p-2"></div>
                </div>
                 <div class="flex gap-4 pt-2">
                    <button id="save-regex-changes-btn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="regexEdit.save">ä¿å­˜</button>
                    <button id="delete-regex-btn" class="flex-1 py-2 btn-secondary rounded-lg hover:bg-red-100 hover:text-red-600" data-i18n="regexEdit.delete">åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <div id="import-regex-location-modal" class="modal-overlay super-sub-modal">
        <div class="modal-content w-full card p-6 text-center">
            <h3 class="text-xl font-bold mb-4" data-i18n="regexImport.title">å¯¼å…¥è‡³:</h3>
            <div class="space-y-3 mb-6">
                <label class="block p-4 rounded-lg border cursor-pointer hover:bg-gray-50"><input type="radio" name="import-location" value="global" class="mr-2" checked><span data-i18n="regexImport.global">å…¨å±€æ­£åˆ™è„šæœ¬</span></label>
                <label class="block p-4 rounded-lg border cursor-pointer hover:bg-gray-50"><input type="radio" name="import-location" value="local" class="mr-2"><span data-i18n="regexImport.local">å±€éƒ¨æ­£åˆ™è„šæœ¬</span></label>
            </div>
            <div class="flex gap-4">
                <button id="confirm-regex-import-btn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="regexImport.confirm">ç¡®è®¤</button>
                <button id="cancel-regex-import-btn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="regexImport.cancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ–‡æœ¬ç¼–è¾‘æ”¾å¤§å¼¹çª— -->
    <div id="text-edit-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full h-full card p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text" id="text-edit-modal-title" data-i18n="textEdit.title">ç¼–è¾‘æ–‡æœ¬</h2>
                <button class="close-sub-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>
            <input type="hidden" id="text-edit-field-name">
            <div class="flex-1 flex flex-col">
                <textarea id="text-edit-textarea" class="w-full h-full light-input rounded-md p-3 resize-none"></textarea>
            </div>
            <div class="flex gap-4 pt-4 mt-auto flex-shrink-0">
                <button id="save-text-edit-btn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="textEdit.save">ä¿å­˜</button>
                <button class="close-sub-modal-btn flex-1 py-2 btn-secondary rounded-lg" data-i18n="textEdit.cancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¤‡é€‰å¼€åœºç™½ç¼–è¾‘å¼¹çª— -->
    <div id="greeting-edit-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full h-full card p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text" data-i18n="greetingEdit.title">ç¼–è¾‘å¼€åœºç™½</h2>
                <button class="close-sub-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>
            <input type="hidden" id="greeting-edit-index">
            <div class="flex-1 flex flex-col">
                <textarea id="greeting-edit-textarea" class="w-full h-full light-input rounded-md p-3 resize-none" data-i18n-placeholder="greetingEdit.placeholder" placeholder="è¾“å…¥å¼€åœºç™½å†…å®¹..."></textarea>
            </div>
            <div class="flex gap-4 pt-4 mt-auto flex-shrink-0">
                <button id="save-greeting-edit-btn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="greetingEdit.save">ä¿å­˜</button>
                <button class="close-sub-modal-btn flex-1 py-2 btn-secondary rounded-lg" data-i18n="greetingEdit.cancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·é€‰æ‹©å¼¹çª— -->
    <div id="user-selector-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full max-w-2xl card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold primary-gradient-text"><i class="fas fa-users mr-2"></i><span data-i18n="userSelector.title">é€‰æ‹©ç”¨æˆ·</span></h2>
                <button class="close-user-selector-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div id="user-list" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- ç”¨æˆ·åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- è§’è‰²é€‰æ‹©å¼¹çª— -->
    <div id="char-selector-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full max-w-2xl card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold primary-gradient-text"><i class="fas fa-user-astronaut mr-2"></i><span data-i18n="charSelector.title">é€‰æ‹©è§’è‰²</span></h2>
                <button class="close-char-selector-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- åç§°æœç´¢æ¡† -->
            <div class="mb-4">
                <input id="char-name-search" type="text" data-i18n-placeholder="charSelector.searchPlaceholder" placeholder="æœç´¢è§’è‰²åç§°..." class="w-full light-input rounded-md p-2 text-sm">
            </div>

            <!-- æ ‡ç­¾ç­›é€‰å™¨ -->
            <div class="mb-4">
                <input id="char-tag-filter" type="text" data-i18n-placeholder="charSelector.tagFilterPlaceholder" placeholder="æŒ‰æ ‡ç­¾ç­›é€‰ï¼ˆè¾“å…¥æ ‡ç­¾åç§°ï¼‰" class="w-full light-input rounded-md p-2 text-sm">
                <div id="char-tag-list" class="flex flex-wrap gap-2 mt-2">
                    <!-- æ ‡ç­¾åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div id="char-list" class="space-y-2 max-h-96 overflow-y-auto">
                <!-- è§’è‰²åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- å¼€åœºç™½é€‰æ‹©å¼¹çª— -->
    <div id="greeting-selector-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full max-w-4xl card p-6 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text"><i class="fas fa-comment-dots mr-2"></i><span data-i18n="greetingSelector.title">é€‰æ‹©å¼€åœºç™½</span></h2>
                <button class="close-greeting-selector-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div id="greeting-list" class="space-y-3 overflow-y-auto flex-1">
                <!-- å¼€åœºç™½åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <div id="theme-settings-modal" class="modal-overlay">
        <div class="modal-content w-full h-full card p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text" data-i18n="theme.title">ğŸ¨ ä¸»é¢˜è®¾ç½®</h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- æ ‡ç­¾é¡µ -->
            <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-200 pb-2">
                <button id="theme-tab-presets" class="px-3 py-2 border-b-2 border-primary-color font-medium text-sm whitespace-nowrap" onclick="switchThemeTab('presets')" data-i18n="theme.tabPresets">é¢„è®¾ä¸»é¢˜</button>
                <button id="theme-tab-custom" class="px-3 py-2 text-gray-500 text-sm whitespace-nowrap" onclick="switchThemeTab('custom')" data-i18n="theme.tabCustom">è‡ªå®šä¹‰CSS</button>
                <button id="theme-tab-saved" class="px-3 py-2 text-gray-500 text-sm whitespace-nowrap" onclick="switchThemeTab('saved')" data-i18n="theme.tabSaved">ä¿å­˜çš„ä¸»é¢˜</button>
            </div>

            <div class="space-y-4 overflow-y-auto pr-4 -mr-4">
                <!-- é¢„è®¾ä¸»é¢˜é¡µ -->
                <div id="theme-presets-content" class="theme-tab-content">
                    <div class="setting-group">
                        <label class="block text-sm font-medium mb-2" data-i18n="theme.presetThemes">é¢„è®¾ä¸»é¢˜</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="default" data-i18n="theme.default">é»˜è®¤</button>
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="dark" data-i18n="theme.dark">æš—é»‘</button>
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="blue" data-i18n="theme.blue">æµ·æ´‹</button>
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="green" data-i18n="theme.green">æ£®æ—</button>
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="purple" data-i18n="theme.purple">ç´«ç½—å…°</button>
                            <button class="theme-preset-btn p-3 rounded-lg text-sm" data-theme="pink" data-i18n="theme.pink">æ¨±èŠ±</button>
                        </div>
                    </div>
                    <hr>
                    <div class="setting-group space-y-3">
                        <label class="block text-sm font-medium" data-i18n="theme.colorSettings">é¢œè‰²è®¾ç½®</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.primary">ä¸»è‰²è°ƒ</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="primaryColorInput" class="color-input">
                                    <input type="text" id="primaryColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.userBubble">ç”¨æˆ·æ°”æ³¡</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="userBubbleColorInput" class="color-input">
                                    <input type="text" id="userBubbleColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.bg">èƒŒæ™¯è‰²</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="bgColorInput" class="color-input">
                                    <input type="text" id="bgColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.aiBubble">AIæ°”æ³¡</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="aiBubbleColorInput" class="color-input">
                                    <input type="text" id="aiBubbleColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.cardBg">å¡ç‰‡èƒŒæ™¯</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="cardBgColorInput" class="color-input">
                                    <input type="text" id="cardBgColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.text">æ–‡å­—é¢œè‰²</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="textColorInput" class="color-input">
                                    <input type="text" id="textColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.border">è¾¹æ¡†é¢œè‰²</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="borderColorInput" class="color-input">
                                    <input type="text" id="borderColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm block mb-1" data-i18n="theme.inputBg">è¾“å…¥æ¡†èƒŒæ™¯</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="inputBgColorInput" class="color-input">
                                    <input type="text" id="inputBgColorText" class="w-full light-input rounded-md p-1 text-sm font-mono">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰CSSé¡µ -->
                <div id="theme-custom-content" class="theme-tab-content hidden">
                    <div class="setting-group">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium" data-i18n="theme.customCSS">è‡ªå®šä¹‰CSS</label>
                            <div class="flex gap-2">
                                <button id="css-format-btn" class="btn-secondary px-3 py-1 text-sm rounded" data-i18n="theme.format">æ ¼å¼åŒ–</button>
                                <button id="css-minify-btn" class="btn-secondary px-3 py-1 text-sm rounded" data-i18n="theme.minify">å‹ç¼©</button>
                                <button id="css-preview-btn" class="btn-secondary px-3 py-1 text-sm rounded" data-i18n="theme.preview">é¢„è§ˆ</button>
                            </div>
                        </div>
                        <textarea id="custom-css-editor" class="w-full h-96 light-input rounded-md p-3 font-mono text-sm resize-y" data-i18n-placeholder="theme.customCSSPlaceholder" placeholder="/* è¾“å…¥ä½ çš„è‡ªå®šä¹‰CSS */
/* ä¾‹å¦‚: */
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card {
    backdrop-filter: blur(10px);
    background: rgba(255,255,255,0.9);
}

.chat-bubble.user-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}"></textarea>
                        <div class="mt-2 text-xs text-gray-500" data-i18n="theme.customCSSHint">
                            æç¤ºï¼šå¯ä»¥è¦†ç›–æ‰€æœ‰ç°æœ‰çš„CSSå˜é‡å’Œç±»ã€‚å®æ—¶é¢„è§ˆæŸ¥çœ‹æ•ˆæœã€‚
                        </div>
                    </div>

                    <hr>

                    <div class="setting-group">
                        <label class="block text-sm font-medium mb-2" data-i18n="theme.cssVarsRef">CSSå˜é‡å‚è€ƒ</label>
                        <div class="bg-gray-100 p-3 rounded-lg max-h-48 overflow-y-auto">
                            <pre class="text-xs font-mono">--bg-color: èƒŒæ™¯é¢œè‰²
--card-bg-color: å¡ç‰‡èƒŒæ™¯
--text-color: æ–‡å­—é¢œè‰²
--text-secondary-color: æ¬¡è¦æ–‡å­—é¢œè‰²
--border-color: è¾¹æ¡†é¢œè‰²
--primary-color: ä¸»è‰²è°ƒ
--primary-hover-color: ä¸»è‰²è°ƒæ‚¬åœ
--input-bg-color: è¾“å…¥æ¡†èƒŒæ™¯
--user-bubble-color: ç”¨æˆ·æ°”æ³¡é¢œè‰²
--ai-bubble-color: AIæ°”æ³¡é¢œè‰²
--bubble-opacity: æ°”æ³¡é€æ˜åº¦
--bubble-text-color: æ°”æ³¡æ–‡å­—é¢œè‰²
--user-bubble-text-color: ç”¨æˆ·æ°”æ³¡æ–‡å­—é¢œè‰²</pre>
                        </div>
                    </div>
                </div>

                <!-- ä¿å­˜çš„ä¸»é¢˜é¡µ -->
                <div id="theme-saved-content" class="theme-tab-content hidden">
                    <div class="setting-group">
                        <div class="flex justify-between items-center mb-4">
                            <label class="block text-sm font-medium" data-i18n="theme.myThemes">æˆ‘çš„ä¸»é¢˜</label>
                            <button id="save-current-theme-btn" class="btn-primary px-4 py-2 text-sm rounded-lg">
                                <i class="fas fa-save mr-2"></i><span data-i18n="theme.saveCurrentTheme">ä¿å­˜å½“å‰ä¸»é¢˜</span>
                            </button>
                        </div>
                        <div id="saved-themes-list" class="space-y-2">
                            <!-- åŠ¨æ€ç”Ÿæˆçš„ä¸»é¢˜åˆ—è¡¨ -->
                        </div>
                        <div class="text-center text-gray-400 py-8" id="no-saved-themes">
                            <i class="fas fa-palette fa-3x mb-2"></i>
                            <p data-i18n="theme.noSavedThemes">è¿˜æ²¡æœ‰ä¿å­˜çš„ä¸»é¢˜</p>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="flex flex-wrap gap-4 pt-4 mt-auto">
                    <button id="applyThemeBtn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="theme.apply">åº”ç”¨</button>
                    <button id="saveAsThemeBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="theme.saveAsNew">å¦å­˜ä¸ºæ–°ä¸»é¢˜</button>
                    <button id="exportThemeBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="theme.exportTheme">å¯¼å‡ºä¸»é¢˜</button>
                    <button id="importThemeBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="theme.importTheme">å¯¼å…¥ä¸»é¢˜</button>
                    <button id="resetThemeBtn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n="theme.reset">é‡ç½®ä¸ºé»˜è®¤</button>
                </div>
            </div>
        </div>
    </div>
    <input type="file" id="themeImportFile" class="hidden" accept=".json">
    <input type="file" id="imageFileInput" class="hidden" accept="image/*">

    <!-- åå¥½è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="preferences-modal" class="modal-overlay">
        <div class="modal-content card" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6 p-6 pb-0">
                <h2 class="text-2xl font-bold primary-gradient-text" data-i18n="preferences.title">âš™ï¸ åå¥½è®¾ç½®</h2>
                <button class="close-modal-btn text-gray-400 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-4 p-6 pt-4">
                <!-- è¯­è¨€è®¾ç½® -->
                <div class="card p-4">
                    <h3 class="font-medium mb-3" data-i18n="preferences.language">ç•Œé¢è¯­è¨€</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="language-select-pref" class="block text-sm font-medium mb-1">Language / è¯­è¨€</label>
                            <select id="language-select-pref" class="w-full light-input rounded-md p-2">
                                <option value="zh">ä¸­æ–‡ (Chinese)</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·è¡Œä¸ºè®¾ç½® -->
                <div class="card p-4">
                    <h3 class="font-medium mb-3" data-i18n="preferences.behavior">ç”¨æˆ·è¡Œä¸º</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="user-auto-announce-pref" class="w-4 h-4 accent-primary-color">
                            <span class="text-sm" data-i18n="preferences.autoAnnounce">è‡ªåŠ¨å‘é€ç”¨æˆ·æè¿°</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="user-show-typing-pref" class="w-4 h-4 accent-primary-color">
                            <span class="text-sm" data-i18n="preferences.showTyping">æ˜¾ç¤ºæ‰“å­—çŠ¶æ€</span>
                        </label>
                    </div>
                </div>

                <!-- ä¿å­˜æŒ‰é’® -->
                <div class="flex gap-4 pt-2">
                    <button id="save-preferences-btn" class="flex-1 py-2 btn-primary rounded-lg" data-i18n="preferences.save">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ€»ç»“èŠå¤©é…ç½®æ¨¡æ€æ¡† -->
    <div id="summarize-modal" class="modal-overlay">
        <div class="modal-content card overflow-y-auto" style="max-width: 1400px; max-height: 90vh; width: 95vw;">
            <div class="flex justify-between items-center mb-6 pt-2 px-2">
                <h2 class="text-xl font-bold primary-gradient-text" data-i18n="summary.title">
                    æ€»ç»“èŠå¤©è®¾ç½®
                </h2>
                <button id="summarize-modal-close" class="text-gray-400 hover:text-gray-800">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- APIé…ç½® -->
                <div class="card p-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <i class="fas fa-server text-purple-500"></i>
                        <span data-i18n="summary.apiConfig">æ€»ç»“APIé…ç½®</span>
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1" data-i18n="summary.apiUrl">APIåœ°å€</label>
                            <input type="text" id="summarize-api-url"
                                   class="w-full light-input rounded-md p-2"
                                   data-i18n-placeholder="summary.apiUrlPlaceholder"
                                   placeholder="https://api.openai.com/v1/chat/completions">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" data-i18n="summary.apiKey">APIå¯†é’¥</label>
                            <input type="password" id="summarize-api-key"
                                   class="w-full light-input rounded-md p-2"
                                   data-i18n-placeholder="summary.apiKeyPlaceholder"
                                   placeholder="sk-...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" data-i18n="summary.model">æ¨¡å‹</label>
                            <div class="flex gap-2">
                                <select id="summarize-api-model-select" class="flex-1 light-input rounded-md p-2">
                                    <option value="" data-i18n="summary.selectModel">é€‰æ‹©æ¨¡å‹...</option>
                                    <option value="gpt-4o">gpt-4o</option>
                                    <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
                                    <option value="gpt-4-turbo">gpt-4-turbo</option>
                                    <option value="gpt-4">gpt-4</option>
                                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                    <option value="custom" data-i18n="summary.customModel">è‡ªå®šä¹‰...</option>
                                </select>
                                <button id="fetch-models-btn" class="px-3 py-2 btn-secondary rounded-md" data-i18n-title="summary.loadConfig" title="ä»APIè·å–æ¨¡å‹åˆ—è¡¨">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <input type="text" id="summarize-api-model"
                                   class="w-full light-input rounded-md p-2 mt-2 hidden"
                                   data-i18n-placeholder="summary.customModelPlaceholder"
                                   placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°"
                                   value="gpt-4o-mini">
                        </div>
                        <div class="flex gap-2">
                            <button id="save-summarize-api-config-btn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n-title="summary.saveConfig" title="ä¿å­˜APIé…ç½®">
                                <i class="fas fa-save mr-2"></i><span data-i18n="summary.saveConfig">ä¿å­˜é…ç½®</span>
                            </button>
                            <button id="load-summarize-api-config-btn" class="flex-1 py-2 btn-secondary rounded-lg" data-i18n-title="summary.loadConfig" title="åŠ è½½APIé…ç½®">
                                <i class="fas fa-upload mr-2"></i><span data-i18n="summary.loadConfig">åŠ è½½é…ç½®</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ€»ç»“è®¾ç½® -->
                <div class="card p-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <i class="fas fa-cog text-blue-500"></i>
                        <span data-i18n="summary.settings">æ€»ç»“è®¾ç½®</span>
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1" data-i18n="summary.messageCount">æ€»ç»“æ¥¼å±‚æ•°</label>
                            <input type="number" id="summarize-floor-count"
                                   class="w-full light-input rounded-md p-2"
                                   placeholder="10"
                                   value="10"
                                   min="1">
                            <p class="text-xs text-gray-500 mt-1" data-i18n="summary.messageCountHint">æ€»ç»“æœ€è¿‘çš„Næ¡æ¶ˆæ¯</p>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="summarize-auto-enable"
                                       class="w-4 h-4 accent-primary-color">
                                <span class="text-sm font-medium" data-i18n="summary.autoEnable">å¯ç”¨è‡ªåŠ¨æ€»ç»“</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1 ml-6" data-i18n="summary.autoEnableHint">è¾¾åˆ°è®¾ç½®çš„æ¥¼å±‚æ•°åè‡ªåŠ¨è§¦å‘æ€»ç»“</p>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="summarize-auto-hide"
                                       class="w-4 h-4 accent-primary-color" checked>
                                <span class="text-sm" data-i18n="summary.autoHide">è‡ªåŠ¨éšè—å·²æ€»ç»“çš„æ¶ˆæ¯</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1 ml-6" data-i18n="summary.autoHideHint">éšè—çš„æ¶ˆæ¯ä¸ä¼šå‘é€ç»™AI</p>
                        </div>
                    </div>
                </div>

                <!-- æç¤ºè¯æ¨¡æ¿ -->
                <div class="card p-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <i class="fas fa-file-alt text-green-500"></i>
                        <span data-i18n="summary.promptTemplates">æç¤ºè¯æ¨¡æ¿</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <select id="summarize-prompt-templates" class="flex-1 light-input rounded-md p-2">
                                <option value="" data-i18n="summary.selectTemplate">é€‰æ‹©æ¨¡æ¿...</option>
                            </select>
                            <button id="load-prompt-template-btn" class="px-3 py-2 btn-secondary rounded-md" data-i18n-title="summary.loadTemplate" title="åŠ è½½æ¨¡æ¿">
                                <i class="fas fa-download"></i>
                            </button>
                            <button id="save-prompt-template-btn" class="px-3 py-2 btn-secondary rounded-md" data-i18n-title="summary.saveTemplate" title="ä¿å­˜ä¸ºæ–°æ¨¡æ¿">
                                <i class="fas fa-save"></i>
                            </button>
                            <button id="delete-prompt-template-btn" class="px-3 py-2 btn-secondary rounded-md hover:bg-red-100 hover:text-red-600" data-i18n-title="summary.deleteTemplate" title="åˆ é™¤æ¨¡æ¿">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" data-i18n="summary.prompt">æ€»ç»“æç¤ºè¯</label>
                            <textarea id="summarize-prompt"
                                      class="w-full light-input rounded-md p-2 resize-y font-mono text-sm"
                                      rows="8"
                                      data-i18n-placeholder="summary.promptPlaceholder"
                                      placeholder="è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯å†…å®¹...">è¯·ç®€æ˜æ‰¼è¦åœ°æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„å…³é”®ä¿¡æ¯ã€é‡è¦äº‹ä»¶å’Œè§’è‰²çŠ¶æ€å˜åŒ–ã€‚æ³¨æ„ï¼š
1. ä¿ç•™é‡è¦çš„ç»†èŠ‚å’Œæƒ…èŠ‚å‘å±•
2. è®°å½•è§’è‰²çš„æƒ…ç»ªå’Œå…³ç³»å˜åŒ–
3. ä½¿ç”¨ç¬¬ä¸‰äººç§°è§†è§’
4. ä¿æŒå®¢è§‚ä¸­ç«‹çš„è¯­æ°”
5. æ§åˆ¶åœ¨200å­—ä»¥å†…</textarea>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex flex-col sm:flex-row gap-3 mt-4">
                    <button id="start-summarize-btn" class="flex-1 py-3 btn-primary rounded-lg text-base">
                        <i class="fas fa-play mr-2"></i><span data-i18n="summary.start">å¼€å§‹æ€»ç»“</span>
                    </button>
                    <button id="test-summarize-api-btn" class="flex-1 py-3 btn-secondary rounded-lg text-base">
                        <i class="fas fa-vial mr-2"></i><span data-i18n="summary.test">æµ‹è¯•API</span>
                    </button>
                </div>
                <div id="summarize-api-test-result" class="text-sm mt-3 text-center h-auto min-h-[1rem]"></div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯ç¼–è¾‘å¼¹çª— -->
    <div id="message-edit-modal" class="message-editing-modal">
        <div class="modal-content card p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold primary-gradient-text" data-i18n="msgEdit.title">ç¼–è¾‘æ¶ˆæ¯</h3>
                <div class="flex items-center gap-2">
                    <button id="toggle-expand-edit-message" class="text-gray-400 hover:text-primary-color transition-colors" data-i18n-title="msgEdit.expandWindow" title="æ‰©å¤§/ç¼©å°çª—å£">
                        <i class="fas fa-expand text-lg"></i>
                    </button>
                    <button id="close-edit-message" class="text-gray-400 hover:text-gray-800">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2" data-i18n="msgEdit.content">æ¶ˆæ¯å†…å®¹</label>
                <textarea id="edit-message-textarea" class="message-edit-textarea light-input rounded-md" rows="6"></textarea>
            </div>
            <div class="flex gap-3">
                <button id="save-edit-message" class="flex-1 btn-primary py-2 rounded-lg">
                    <i class="fas fa-check mr-2"></i><span data-i18n="msgEdit.save">ä¿å­˜</span>
                </button>
                <button id="cancel-edit-message" class="flex-1 btn-secondary py-2 rounded-lg">
                    <i class="fas fa-times mr-2"></i><span data-i18n="msgEdit.cancel">å–æ¶ˆ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹æç¤ºè¯æ¨¡æ€æ¡† - æ”¹è¿›ç‰ˆæœ¬ï¼Œæ·»åŠ è¯¦ç»†æ£€æŸ¥ä¿¡æ¯ -->
    <div id="prompt-preview-modal" class="modal-overlay sub-modal">
        <div class="modal-content w-full h-full card p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold primary-gradient-text" data-i18n="prompt.title">ğŸ“ å‘é€æç¤ºè¯æ£€æŸ¥</h2>
                <button id="close-prompt-preview" class="text-gray-400 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- æç¤ºè¯æ£€æŸ¥æ¸…å• -->
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 class="font-bold text-sm mb-2 text-blue-800" data-i18n="prompt.checkTitle">âœ… æç¤ºè¯åŒ…å«é¡¹æ£€æŸ¥ï¼š</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div id="check-system-prompt" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkSystemPrompt">ç³»ç»Ÿæç¤ºè¯</span>
                    </div>
                    <div id="check-user-profile" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkUserProfile">ç”¨æˆ·è§’è‰²è®¾å®š</span>
                    </div>
                    <div id="check-char-desc" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkCharDesc">è§’è‰²æè¿°</span>
                    </div>
                    <div id="check-world-info" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkWorldInfo">ä¸–ç•Œä¹¦ä¿¡æ¯</span>
                    </div>
                    <div id="check-chat-history" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkChatHistory">èŠå¤©å†å²</span>
                    </div>
                    <div id="check-regex" class="flex items-center gap-1">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span data-i18n="prompt.checkRegex">æ­£åˆ™è¡¨è¾¾å¼å¤„ç†</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3 mb-4 p-3 bg-gray-100 rounded-lg flex-wrap">
                <div class="flex-1 flex flex-wrap gap-x-4 gap-y-2 text-sm min-w-0">
                    <div class="flex items-center gap-1 whitespace-nowrap">
                        <span class="font-medium text-xs" data-i18n="prompt.totalTokens">æ€»Tokenæ•°ï¼š</span>
                        <span id="total-tokens" class="text-primary-color font-bold">0</span>
                    </div>
                    <div class="flex items-center gap-1 whitespace-nowrap">
                        <span class="font-medium text-xs" data-i18n="prompt.systemTokens">ç³»ç»Ÿæç¤ºï¼š</span>
                        <span id="system-tokens" class="text-blue-600">0</span>
                    </div>
                    <div class="flex items-center gap-1 whitespace-nowrap">
                        <span class="font-medium text-xs" data-i18n="prompt.chatTokens">èŠå¤©å†å²ï¼š</span>
                        <span id="chat-tokens" class="text-green-600">0</span>
                    </div>
                    <div class="flex items-center gap-1 whitespace-nowrap">
                        <span class="font-medium text-xs" data-i18n="prompt.worldTokens">ä¸–ç•Œä¹¦ï¼š</span>
                        <span id="world-tokens" class="text-purple-600">0</span>
                    </div>
                </div>
                <button id="copy-prompt-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm whitespace-nowrap flex-shrink-0">
                    <i class="fas fa-copy mr-2"></i><span data-i18n="prompt.copy">å¤åˆ¶</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto">
                <div id="prompt-preview-content" class="space-y-4"></div>
            </div>
        </div>
    </div>
    <!-- å¤šé€‰å·¥å…·æ å·²ç§»é™¤ -->


    <script>
        // --- å¤šè¯­è¨€ç³»ç»Ÿ ---
        const i18n = {
            currentLang: 'zh',
            translations: {
                zh: {
                    // ä¾§è¾¹æ 
                    'sidebar.api': 'API è®¾ç½®',
                    'sidebar.character': 'è§’è‰²å¡',
                    'sidebar.presets': 'AI é¢„è®¾',
                    'sidebar.worldInfo': 'ä¸–ç•Œä¹¦',
                    'sidebar.regex': 'æ­£åˆ™è¡¨è¾¾å¼',
                    'sidebar.theme': 'ä¸»é¢˜è®¾ç½®',
                    'sidebar.preferences': 'åå¥½è®¾ç½®',
                    'sidebar.user': 'ç”¨æˆ·/UIè®¾ç½®',
                    'sidebar.newChat': 'æ–°å¯¹è¯',
                    'sidebar.summarize': 'æ€»ç»“èŠå¤©',
                    'sidebar.promptPreview': 'Prompté¢„è§ˆ',

                    // APIè®¾ç½®
                    'api.title': 'API è®¾ç½®',
                    'api.configManage': 'API é…ç½®ç®¡ç†',
                    'api.configName': 'é…ç½®åç§°',
                    'api.configNamePlaceholder': 'ä¸ºæ­¤é…ç½®å‘½å',
                    'api.loadSelected': 'åŠ è½½é€‰ä¸­é…ç½®',
                    'api.deleteSelected': 'åˆ é™¤é€‰ä¸­é…ç½®',
                    'api.selectConfig': 'é€‰æ‹©é…ç½®',
                    'api.url': 'API URL (OpenAI æ ¼å¼)',
                    'api.key': 'API Key',
                    'api.model': 'æ¨¡å‹åˆ—è¡¨',
                    'api.modelPlaceholder': 'ä¾‹å¦‚ gpt-4-turbo',
                    'api.loadModels': 'åˆ·æ–°',
                    'api.streaming': 'æµå¼ä¼ è¾“',
                    'api.temperature': 'æ¸©åº¦',
                    'api.maxTokens': 'æœ€å¤§ç”ŸæˆTokenæ•°',
                    'api.supportedFormats': 'æ”¯æŒæ ¼å¼:',
                    'api.note': 'æ³¨æ„:',
                    'api.googleKeyNote': 'Google APIå¯†é’¥ä»¥ `AIza...` å¼€å¤´.',
                    'api.visionTitle': 'ğŸ–¼ï¸ è¯†å›¾ API è®¾ç½® (å¯é€‰)',
                    'api.visionDescription': 'ç”¨äºå‘é€å›¾ç‰‡æ—¶è®©AIèƒ½å¤Ÿç†è§£å›¾ç‰‡å†…å®¹ã€‚',
                    'api.visionUrl': 'è¯†å›¾ API URL',
                    'api.visionKey': 'è¯†å›¾ API Key',
                    'api.visionModel': 'è¯†å›¾æ¨¡å‹',
                    'api.loadVisionModels': 'åŠ è½½è¯†å›¾æ¨¡å‹',
                    'api.saveAsNew': 'å¦å­˜ä¸ºæ–°é…ç½®',
                    'api.updateCurrent': 'æ›´æ–°å½“å‰é…ç½®',
                    'api.testConnection': 'æµ‹è¯•è¿æ¥',
                    'api.debugModels': 'è°ƒè¯•æ¨¡å‹',
                    'api.directChatTest': 'ç›´æ¥æµ‹è¯•èŠå¤©',
                    'api.save': 'ä¿å­˜è®¾ç½®',
                    'api.test': 'æµ‹è¯• API',
                    'api.placeholder.url': 'ä¾‹å¦‚: https://api.openai.com/v1',
                    'api.placeholder.key': 'è¾“å…¥API Key',

                    // è§’è‰²ç®¡ç†
                    'char.title': 'è§’è‰²ç®¡ç†',
                    'char.current': 'å½“å‰è§’è‰²',
                    'char.noSelect': 'æœªé€‰æ‹©è§’è‰²',
                    'char.clickSelect': 'ç‚¹å‡»é€‰æ‹©æˆ–åˆ›å»ºè§’è‰²',
                    'char.new': 'æ–°å»ºè§’è‰²',
                    'char.switch': 'åˆ‡æ¢è§’è‰²',
                    'char.import': 'å¯¼å…¥è§’è‰²',
                    'char.export': 'å¯¼å‡ºè§’è‰²',
                    'char.selectTip': 'é€‰æ‹©ä¸€ä¸ªè§’è‰²è¿›è¡Œç¼–è¾‘ï¼Œæˆ–å¯¼å…¥/æ–°å»ºä¸€ä¸ªè§’è‰²ã€‚',
                    'char.name': 'è§’è‰²åç§°',
                    'char.uploadAvatar': 'ä¸Šä¼ å¤´åƒ',
                    'char.tags': 'æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œå¦‚: å¥³æ€§, åŠ©æ‰‹, å¹»æƒ³ï¼‰',
                    'char.save': 'ä¿å­˜',
                    'char.delete': 'åˆ é™¤',
                    'char.duplicate': 'å¤åˆ¶',
                    'char.description': 'è§’è‰²æè¿° (æ€§æ ¼, å¤–è²Œ, å¯¹è¯ç¤ºä¾‹ç­‰)',
                    'char.personality': 'æ€§æ ¼',
                    'char.scenario': 'åœºæ™¯',
                    'char.firstMessage': 'ç¬¬ä¸€æ¡æ¶ˆæ¯',
                    'char.alternateGreetings': 'å¤‡é€‰å¼€åœºç™½',
                    'char.addGreeting': 'æ·»åŠ ',
                    'char.creatorNotes': 'åˆ›ä½œè€…çš„æ³¨é‡Š',
                    'char.expandEdit': 'æ”¾å¤§ç¼–è¾‘',

                    // AIé¢„è®¾
                    'presets.title': 'AI é¢„è®¾',
                    'presets.import': 'å¯¼å…¥',
                    'presets.export': 'å¯¼å‡º',
                    'presets.saveAsNew': 'å¦å­˜ä¸ºæ–°é¢„è®¾',
                    'presets.samplingParams': 'é‡‡æ ·å‚æ•°',
                    'presets.estimatedTokens': 'é¢„ä¼°Token',
                    'presets.remainingContext': 'å‰©ä½™ä¸Šä¸‹æ–‡ï¼š',
                    'presets.promptEntries': 'æç¤ºè¯æ¡ç›®',
                    'presets.addEntry': 'æ·»åŠ æ–°æ¡ç›®',
                    'presets.restoreDefaults': 'æ¢å¤é»˜è®¤',

                    // ä¸–ç•Œä¹¦
                    'worldInfo.title': 'ä¸–ç•Œä¹¦',
                    'worldInfo.select': 'é€‰æ‹©ä¸–ç•Œä¹¦',
                    'worldInfo.newWorld': 'æ–°ä¸–ç•Œ',
                    'worldInfo.import': 'å¯¼å…¥',
                    'worldInfo.export': 'å¯¼å‡º',
                    'worldInfo.delete': 'åˆ é™¤',
                    'worldInfo.newEntry': 'æ–°å»ºæ¡ç›®',
                    'worldInfo.selectTip': 'é€‰æ‹©ä¸€ä¸ªæ¡ç›®è¿›è¡Œç¼–è¾‘ï¼Œæˆ–æ–°å»ºä¸€ä¸ªæ¡ç›®ã€‚',
                    'worldInfo.enabled': 'å¯ç”¨',
                    'worldInfo.entryTitle': 'æ¡ç›®æ ‡é¢˜ (å¯é€‰)',
                    'worldInfo.clone': 'å…‹éš†',
                    'worldInfo.primaryKeys': 'ä¸»è¦å…³é”®å­— (é€—å·åˆ†éš”)',
                    'worldInfo.caseSensitive': 'åŒºåˆ†å¤§å°å†™',
                    'worldInfo.wholeWord': 'å®Œæ•´å•è¯',
                    'worldInfo.content': 'å†…å®¹',
                    'worldInfo.insertPosition': 'æ’å…¥ä½ç½®',
                    'worldInfo.role': 'è§’è‰²',
                    'worldInfo.depth': 'æ·±åº¦',
                    'worldInfo.priority': 'ä¼˜å…ˆçº§',
                    'worldInfo.constant': 'æ€»æ˜¯å¯ç”¨ (Constant)',
                    'worldInfo.selective': 'é€‰æ‹©æ€§',
                    'worldInfo.excludeRecursion': 'æ’é™¤é€’å½’',
                    'worldInfo.additionalSources': 'é¢å¤–åŒ¹é…æ¥æº',
                    'worldInfo.charDesc': 'è§’è‰²æè¿°',
                    'worldInfo.charPersonality': 'è§’è‰²æ€§æ ¼',
                    'worldInfo.scenario': 'æƒ…æ™¯',
                    'worldInfo.userProfile': 'ç”¨æˆ·è®¾å®šæè¿°',
                    'worldInfo.charNotes': 'è§’è‰²å¤‡æ³¨',
                    'worldInfo.creatorNotes': 'åˆ›ä½œè€…çš„æ³¨é‡Š',

                    // æ­£åˆ™è¡¨è¾¾å¼
                    'regex.title': 'æ­£åˆ™è¡¨è¾¾å¼',
                    'regex.newGlobal': 'æ–°å»ºå…¨å±€æ­£åˆ™',
                    'regex.newLocal': 'æ–°å»ºå±€éƒ¨æ­£åˆ™',
                    'regex.import': 'å¯¼å…¥æ­£åˆ™',
                    'regex.globalScripts': 'å…¨å±€æ­£åˆ™è„šæœ¬',
                    'regex.globalTitle': 'å…¨å±€æ­£åˆ™è„šæœ¬',
                    'regex.globalDesc': 'å½±å“æ‰€æœ‰è§’è‰²ï¼Œä¿å­˜åœ¨æœ¬åœ°è®¾å®šä¸­ã€‚',
                    'regex.localScripts': 'å±€éƒ¨æ­£åˆ™è„šæœ¬',
                    'regex.localTitle': 'å±€éƒ¨æ­£åˆ™è„šæœ¬',
                    'regex.localDesc': 'åªå½±å“å½“å‰è§’è‰²ï¼Œä¿å­˜åœ¨è§’è‰²å¡ç‰‡ä¸­ã€‚',
                    'regex.enable': 'å¯ç”¨',

                    // ä¸»é¢˜è®¾ç½®
                    'theme.title': 'ä¸»é¢˜è®¾ç½®',
                    'theme.tabPresets': 'é¢„è®¾ä¸»é¢˜',
                    'theme.tabCustom': 'è‡ªå®šä¹‰CSS',
                    'theme.tabSaved': 'ä¿å­˜çš„ä¸»é¢˜',
                    'theme.presetThemes': 'é¢„è®¾ä¸»é¢˜',
                    'theme.customCSS': 'è‡ªå®šä¹‰CSS',
                    'theme.savedThemes': 'ä¿å­˜çš„ä¸»é¢˜',
                    'theme.default': 'é»˜è®¤',
                    'theme.dark': 'æš—é»‘',
                    'theme.blue': 'æµ·æ´‹',
                    'theme.ocean': 'æµ·æ´‹',
                    'theme.green': 'æ£®æ—',
                    'theme.forest': 'æ£®æ—',
                    'theme.purple': 'ç´«ç½—å…°',
                    'theme.violet': 'ç´«ç½—å…°',
                    'theme.pink': 'æ¨±èŠ±',
                    'theme.sakura': 'æ¨±èŠ±',
                    'theme.colorSettings': 'é¢œè‰²è®¾ç½®',
                    'theme.primary': 'ä¸»è‰²è°ƒ',
                    'theme.primaryColor': 'ä¸»è‰²è°ƒ',
                    'theme.userBubble': 'ç”¨æˆ·æ°”æ³¡',
                    'theme.bg': 'èƒŒæ™¯è‰²',
                    'theme.aiBubble': 'AIæ°”æ³¡',
                    'theme.cardBg': 'å¡ç‰‡èƒŒæ™¯',
                    'theme.text': 'æ–‡å­—é¢œè‰²',
                    'theme.border': 'è¾¹æ¡†é¢œè‰²',
                    'theme.inputBg': 'è¾“å…¥æ¡†èƒŒæ™¯',
                    'theme.textSecondary': 'æ¬¡è¦æ–‡å­—é¢œè‰²',
                    'theme.primaryHover': 'ä¸»è‰²è°ƒæ‚¬åœ',
                    'theme.format': 'æ ¼å¼åŒ–',
                    'theme.minify': 'å‹ç¼©',
                    'theme.preview': 'é¢„è§ˆ',
                    'theme.customCSSPlaceholder': '/* è¾“å…¥ä½ çš„è‡ªå®šä¹‰CSS */',
                    'theme.customCSSHint': 'æç¤ºï¼šå¯ä»¥è¦†ç›–æ‰€æœ‰ç°æœ‰çš„CSSå˜é‡å’Œç±»ã€‚å®æ—¶é¢„è§ˆæŸ¥çœ‹æ•ˆæœã€‚',
                    'theme.cssVarsRef': 'CSSå˜é‡å‚è€ƒ',
                    'theme.myThemes': 'æˆ‘çš„ä¸»é¢˜',
                    'theme.saveCurrentTheme': 'ä¿å­˜å½“å‰ä¸»é¢˜',
                    'theme.noSavedThemes': 'è¿˜æ²¡æœ‰ä¿å­˜çš„ä¸»é¢˜',
                    'theme.apply': 'åº”ç”¨',
                    'theme.saveAsNew': 'å¦å­˜ä¸ºæ–°ä¸»é¢˜',
                    'theme.exportTheme': 'å¯¼å‡ºä¸»é¢˜',
                    'theme.importTheme': 'å¯¼å…¥ä¸»é¢˜',
                    'theme.reset': 'é‡ç½®ä¸ºé»˜è®¤',
                    'theme.save': 'ä¿å­˜ä¸»é¢˜',

                    // ç”¨æˆ·è®¾ç½®
                    'user.title': 'ç”¨æˆ·ç®¡ç†',
                    'user.currentUser': 'å½“å‰ç”¨æˆ·',
                    'user.defaultUser': 'é»˜è®¤ç”¨æˆ·',
                    'user.online': 'åœ¨çº¿',
                    'user.new': 'æ–°å»ºç”¨æˆ·',
                    'user.newUser': 'æ–°å»ºç”¨æˆ·',
                    'user.switch': 'åˆ‡æ¢ç”¨æˆ·',
                    'user.switchUser': 'åˆ‡æ¢ç”¨æˆ·',
                    'user.selectTip': 'é€‰æ‹©ä¸€ä¸ªç”¨æˆ·è¿›è¡Œç¼–è¾‘ï¼Œæˆ–åˆ›å»ºæ–°ç”¨æˆ·ã€‚',
                    'user.uploadAvatar': 'ä¸Šä¼ å¤´åƒ',
                    'user.name': 'ç”¨æˆ·åç§°',
                    'user.avatar': 'ç”¨æˆ·å¤´åƒURL',
                    'user.status': 'çŠ¶æ€/å¿ƒæƒ…',
                    'user.save': 'ä¿å­˜',
                    'user.use': 'ä½¿ç”¨',
                    'user.duplicate': 'å¤åˆ¶',
                    'user.delete': 'åˆ é™¤',
                    'user.description': 'ç”¨æˆ·è§’è‰²æè¿°ï¼ˆå°†å‘é€ç»™AIï¼‰',
                    'user.descriptionPlaceholder': 'æè¿°æ‚¨çš„è§’è‰²è®¾å®šï¼Œä¾‹å¦‚ï¼šä½ æ˜¯ä¸€åç¨‹åºå‘˜ï¼Œå–œæ¬¢æŠ€æœ¯è®¨è®º...',
                    'user.systemPrompt': 'ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼Œå°†æ·»åŠ åˆ°ç³»ç»Ÿæ¶ˆæ¯ï¼‰',
                    'user.systemPromptPlaceholder': 'ä¾‹å¦‚ï¼šè¯·ä»¥ä¸“ä¸šçš„æ–¹å¼å›ç­”æŠ€æœ¯é—®é¢˜...',
                    'user.expandEdit': 'æ”¾å¤§ç¼–è¾‘',
                    'user.preferences': 'åå¥½è®¾ç½®',
                    'user.language': 'ç•Œé¢è¯­è¨€',
                    'user.autoAnnounce': 'è‡ªåŠ¨å‘é€ç”¨æˆ·æè¿°',
                    'user.showTyping': 'æ˜¾ç¤ºæ‰“å­—çŠ¶æ€',

                    // èŠå¤©ç•Œé¢
                    'chat.reselectGreeting': 'é‡é€‰å¼€åœºç™½',
                    'chat.moreOptions': 'æ›´å¤šé€‰é¡¹',
                    'chat.viewPrompt': 'æŸ¥çœ‹æç¤ºè¯',
                    'chat.newChat': 'æ–°å¯¹è¯',
                    'chat.sendImage': 'å‘é€å›¾ç‰‡',
                    'chat.summarize': 'æ€»ç»“èŠå¤©',
                    'chat.exportConfig': 'å¯¼å‡ºé…ç½®',
                    'chat.importConfig': 'å¯¼å…¥é…ç½®',
                    'chat.exportChat': 'å¯¼å‡ºèŠå¤©è®°å½•',
                    'chat.importChat': 'å¯¼å…¥èŠå¤©è®°å½•',
                    'chat.inputPlaceholder': 'è¾“å…¥æ¶ˆæ¯...',
                    'chat.sendMessage': 'å‘é€æ¶ˆæ¯',

                    // åå¥½è®¾ç½®
                    'preferences.title': 'åå¥½è®¾ç½®',
                    'preferences.language': 'ç•Œé¢è¯­è¨€',
                    'preferences.behavior': 'ç”¨æˆ·è¡Œä¸º',
                    'preferences.autoAnnounce': 'è‡ªåŠ¨å‘é€ç”¨æˆ·æè¿°',
                    'preferences.showTyping': 'æ˜¾ç¤ºæ‰“å­—çŠ¶æ€',
                    'preferences.save': 'ä¿å­˜è®¾ç½®',

                    // æ€»ç»“èŠå¤©
                    'summary.title': 'æ€»ç»“èŠå¤©è®¾ç½®',
                    'summary.apiConfig': 'æ€»ç»“APIé…ç½®',
                    'summary.apiUrl': 'APIåœ°å€',
                    'summary.apiUrlPlaceholder': 'https://api.openai.com/v1/chat/completions',
                    'summary.apiKey': 'APIå¯†é’¥',
                    'summary.apiKeyPlaceholder': 'sk-...',
                    'summary.model': 'æ¨¡å‹',
                    'summary.selectModel': 'é€‰æ‹©æ¨¡å‹...',
                    'summary.customModel': 'è‡ªå®šä¹‰...',
                    'summary.customModelPlaceholder': 'è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°',
                    'summary.saveConfig': 'ä¿å­˜é…ç½®',
                    'summary.loadConfig': 'åŠ è½½é…ç½®',
                    'summary.settings': 'æ€»ç»“è®¾ç½®',
                    'summary.messageCount': 'æ€»ç»“æ¥¼å±‚æ•°',
                    'summary.messageCountHint': 'æ€»ç»“æœ€è¿‘çš„Næ¡æ¶ˆæ¯',
                    'summary.autoEnable': 'å¯ç”¨è‡ªåŠ¨æ€»ç»“',
                    'summary.autoEnableHint': 'è¾¾åˆ°è®¾ç½®çš„æ¥¼å±‚æ•°åè‡ªåŠ¨è§¦å‘æ€»ç»“',
                    'summary.autoHide': 'è‡ªåŠ¨éšè—å·²æ€»ç»“çš„æ¶ˆæ¯',
                    'summary.autoHideHint': 'éšè—çš„æ¶ˆæ¯ä¸ä¼šå‘é€ç»™AI',
                    'summary.promptTemplates': 'æç¤ºè¯æ¨¡æ¿',
                    'summary.selectTemplate': 'é€‰æ‹©æ¨¡æ¿...',
                    'summary.loadTemplate': 'åŠ è½½æ¨¡æ¿',
                    'summary.saveTemplate': 'ä¿å­˜ä¸ºæ–°æ¨¡æ¿',
                    'summary.deleteTemplate': 'åˆ é™¤æ¨¡æ¿',
                    'summary.prompt': 'æ€»ç»“æç¤ºè¯',
                    'summary.promptPlaceholder': 'è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯å†…å®¹...',
                    'summary.start': 'å¼€å§‹æ€»ç»“',
                    'summary.test': 'æµ‹è¯• API',
                    'summary.processing': 'æ€»ç»“å¤„ç†ä¸­...',
                    'summary.result': 'æ€»ç»“ç»“æœ',

                    // Prompté¢„è§ˆ
                    'prompt.title': 'Prompt é¢„è§ˆ',
                    'prompt.checkTitle': 'æç¤ºè¯åŒ…å«é¡¹æ£€æŸ¥ï¼š',
                    'prompt.checkSystemPrompt': 'ç³»ç»Ÿæç¤ºè¯',
                    'prompt.checkUserProfile': 'ç”¨æˆ·è§’è‰²è®¾å®š',
                    'prompt.checkCharDesc': 'è§’è‰²æè¿°',
                    'prompt.checkWorldInfo': 'ä¸–ç•Œä¹¦ä¿¡æ¯',
                    'prompt.checkChatHistory': 'èŠå¤©å†å²',
                    'prompt.checkRegex': 'æ­£åˆ™è¡¨è¾¾å¼å¤„ç†',
                    'prompt.refresh': 'åˆ·æ–°é¢„è§ˆ',
                    'prompt.system': 'ç³»ç»Ÿæç¤º',
                    'prompt.userPersona': 'ç”¨æˆ·è§’è‰²è®¾å®š',
                    'prompt.charDesc': 'è§’è‰²æè¿°',
                    'prompt.worldInfo': 'ä¸–ç•Œä¹¦ä¿¡æ¯',
                    'prompt.chatHistory': 'èŠå¤©å†å²',
                    'prompt.regex': 'æ­£åˆ™è¡¨è¾¾å¼å¤„ç†',
                    'prompt.totalTokens': 'æ€»Tokenæ•°ï¼š',
                    'prompt.systemTokens': 'ç³»ç»Ÿæç¤ºï¼š',
                    'prompt.chatTokens': 'èŠå¤©å†å²ï¼š',
                    'prompt.worldTokens': 'ä¸–ç•Œä¹¦ï¼š',
                    'prompt.copy': 'å¤åˆ¶',

                    // æ¶ˆæ¯æ“ä½œ
                    'msg.edit': 'ç¼–è¾‘',
                    'msg.regenerate': 'é‡æ–°ç”Ÿæˆ',
                    'msg.delete': 'åˆ é™¤',
                    'msg.deleteConfirm': 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ',
                    'msg.send': 'å‘é€',
                    'msg.placeholder': 'è¾“å…¥æ¶ˆæ¯...',
                    'msg.imageRecognizing': 'æ­£åœ¨è¯†åˆ«å›¾ç‰‡...',
                    'msg.imageInfo': '[å›¾ç‰‡]',

                    // ç¼–è¾‘æ¨¡æ€æ¡†
                    'edit.promptTitle': 'ç¼–è¾‘æç¤ºè¯æ¡ç›®',
                    'edit.promptName': 'åç§°',
                    'edit.promptPosition': 'ä½ç½®',
                    'edit.promptDepth': 'æ·±åº¦ (Depth)',
                    'edit.promptContent': 'å†…å®¹',
                    'edit.saveChanges': 'ä¿å­˜æ›´æ”¹',
                    'edit.delete': 'åˆ é™¤',
                    'edit.positionRelative': 'ç›¸å¯¹ (Relative)',
                    'edit.positionInChat': 'åœ¨èŠå¤©ä¸­ (In-chat)',

                    // æ­£åˆ™ç¼–è¾‘æ¨¡æ€æ¡†
                    'regexEdit.title': 'æ­£åˆ™è„šæœ¬ç¼–è¾‘å™¨',
                    'regexEdit.scriptName': 'è„šæœ¬åç§°',
                    'regexEdit.findPattern': 'æŸ¥æ‰¾æ­£åˆ™è¡¨è¾¾å¼',
                    'regexEdit.replaceWith': 'æ›¿æ¢ä¸º',
                    'regexEdit.scope': 'ä½œç”¨èŒƒå›´',
                    'regexEdit.scopeUserInput': 'ç”¨æˆ·è¾“å…¥ (User Input)',
                    'regexEdit.scopeAIOutput': 'AIè¾“å‡º (AI Output)',
                    'regexEdit.scopeQuickReply': 'å¿«æ·å‘½ä»¤ (Quick Reply)',
                    'regexEdit.scopeWorldInfo': 'ä¸–ç•Œä¿¡æ¯ (World Info)',
                    'regexEdit.options': 'å…¶ä»–é€‰é¡¹',
                    'regexEdit.markdownOnly': 'ä»…å·²ç¦ç”¨ (Markdown Only)',
                    'regexEdit.promptOnly': 'åœ¨ç¼–è¾‘æ—¶è¿è¡Œ (Prompt Only)',
                    'regexEdit.minDepth': 'æœ€å°æ·±åº¦',
                    'regexEdit.maxDepth': 'æœ€å¤§æ·±åº¦',
                    'regexEdit.noLimit': 'æ— é™',
                    'regexEdit.save': 'ä¿å­˜',
                    'regexEdit.delete': 'åˆ é™¤',

                    // å¯¼å…¥æ­£åˆ™ä½ç½®æ¨¡æ€æ¡†
                    'regexImport.title': 'å¯¼å…¥è‡³:',
                    'regexImport.global': 'å…¨å±€æ­£åˆ™è„šæœ¬',
                    'regexImport.local': 'å±€éƒ¨æ­£åˆ™è„šæœ¬',
                    'regexImport.confirm': 'ç¡®è®¤',
                    'regexImport.cancel': 'å–æ¶ˆ',

                    // æ–‡æœ¬ç¼–è¾‘æ¨¡æ€æ¡†
                    'textEdit.title': 'ç¼–è¾‘æ–‡æœ¬',
                    'textEdit.save': 'ä¿å­˜',
                    'textEdit.cancel': 'å–æ¶ˆ',

                    // æ¶ˆæ¯ç¼–è¾‘æ¨¡æ€æ¡†
                    'msgEdit.title': 'ç¼–è¾‘æ¶ˆæ¯',
                    'msgEdit.content': 'æ¶ˆæ¯å†…å®¹',
                    'msgEdit.expandWindow': 'æ‰©å¤§/ç¼©å°çª—å£',
                    'msgEdit.save': 'ä¿å­˜',
                    'msgEdit.cancel': 'å–æ¶ˆ',

                    // å¼€åœºç™½ç¼–è¾‘æ¨¡æ€æ¡†
                    'greetingEdit.title': 'ç¼–è¾‘å¼€åœºç™½',
                    'greetingEdit.placeholder': 'è¾“å…¥å¼€åœºç™½å†…å®¹...',
                    'greetingEdit.save': 'ä¿å­˜',
                    'greetingEdit.cancel': 'å–æ¶ˆ',

                    // ç”¨æˆ·é€‰æ‹©æ¨¡æ€æ¡†
                    'userSelector.title': 'é€‰æ‹©ç”¨æˆ·',

                    // è§’è‰²é€‰æ‹©æ¨¡æ€æ¡†
                    'charSelector.title': 'é€‰æ‹©è§’è‰²',
                    'charSelector.searchPlaceholder': 'æœç´¢è§’è‰²åç§°...',
                    'charSelector.tagFilterPlaceholder': 'æŒ‰æ ‡ç­¾ç­›é€‰ï¼ˆè¾“å…¥æ ‡ç­¾åç§°ï¼‰',

                    // å¼€åœºç™½é€‰æ‹©æ¨¡æ€æ¡†
                    'greetingSelector.title': 'é€‰æ‹©å¼€åœºç™½',

                    // é€šç”¨
                    'common.save': 'ä¿å­˜',
                    'common.cancel': 'å–æ¶ˆ',
                    'common.confirm': 'ç¡®è®¤',
                    'common.close': 'å…³é—­',
                    'common.loading': 'åŠ è½½ä¸­...',
                    'common.success': 'æˆåŠŸ',
                    'common.error': 'é”™è¯¯',
                    'common.upload': 'ä¸Šä¼ ',
                    'common.use': 'ä½¿ç”¨',
                    'common.clone': 'å…‹éš†',
                    'common.copy': 'å¤åˆ¶',
                    'common.invisible': 'å ä½',
                },
                en: {
                    // Sidebar
                    'sidebar.api': 'API Settings',
                    'sidebar.character': 'Character',
                    'sidebar.presets': 'AI Presets',
                    'sidebar.worldInfo': 'World Info',
                    'sidebar.regex': 'Regex',
                    'sidebar.theme': 'Theme',
                    'sidebar.preferences': 'Preferences',
                    'sidebar.user': 'User/UI',
                    'sidebar.newChat': 'New Chat',
                    'sidebar.summarize': 'Summarize',
                    'sidebar.promptPreview': 'Prompt Preview',

                    // API Settings
                    'api.title': 'API Settings',
                    'api.configManage': 'API Configuration Management',
                    'api.configName': 'Configuration Name',
                    'api.configNamePlaceholder': 'Name this configuration',
                    'api.loadSelected': 'Load selected configuration',
                    'api.deleteSelected': 'Delete selected configuration',
                    'api.selectConfig': 'Select configuration',
                    'api.url': 'API URL (OpenAI format)',
                    'api.key': 'API Key',
                    'api.model': 'Model List',
                    'api.modelPlaceholder': 'e.g. gpt-4-turbo',
                    'api.loadModels': 'Refresh',
                    'api.streaming': 'Streaming',
                    'api.temperature': 'Temperature',
                    'api.maxTokens': 'Max Tokens',
                    'api.supportedFormats': 'Supported formats:',
                    'api.note': 'Note:',
                    'api.googleKeyNote': 'Google API keys start with `AIza...`.',
                    'api.visionTitle': 'ğŸ–¼ï¸ Vision API Settings (Optional)',
                    'api.visionDescription': 'For AI to understand image content when sending pictures.',
                    'api.visionUrl': 'Vision API URL',
                    'api.visionKey': 'Vision API Key',
                    'api.visionModel': 'Vision Model',
                    'api.loadVisionModels': 'Load Vision Models',
                    'api.saveAsNew': 'Save as New Configuration',
                    'api.updateCurrent': 'Update Current Configuration',
                    'api.testConnection': 'Test Connection',
                    'api.debugModels': 'Debug Models',
                    'api.directChatTest': 'Direct Chat Test',
                    'api.save': 'Save Settings',
                    'api.test': 'Test API',
                    'api.placeholder.url': 'e.g., https://api.openai.com/v1',
                    'api.placeholder.key': 'Enter API Key',

                    // Character Management
                    'char.title': 'Character Management',
                    'char.current': 'Current Character',
                    'char.noSelect': 'No Character Selected',
                    'char.clickSelect': 'Click to select or create a character',
                    'char.new': 'New Character',
                    'char.switch': 'Switch Character',
                    'char.import': 'Import Character',
                    'char.export': 'Export Character',
                    'char.selectTip': 'Select a character to edit, or import/create a new one.',
                    'char.name': 'Character Name',
                    'char.uploadAvatar': 'Upload Avatar',
                    'char.tags': 'Tags (comma-separated, e.g.: female, assistant, fantasy)',
                    'char.save': 'Save',
                    'char.delete': 'Delete',
                    'char.duplicate': 'Duplicate',
                    'char.description': 'Character Description (personality, appearance, dialogue examples, etc.)',
                    'char.personality': 'Personality',
                    'char.scenario': 'Scenario',
                    'char.firstMessage': 'First Message',
                    'char.alternateGreetings': 'Alternate Greetings',
                    'char.addGreeting': 'Add',
                    'char.creatorNotes': 'Creator Notes',
                    'char.expandEdit': 'Expand Editor',

                    // AI Presets
                    'presets.title': 'AI Presets',
                    'presets.import': 'Import',
                    'presets.export': 'Export',
                    'presets.saveAsNew': 'Save as New Preset',
                    'presets.samplingParams': 'Sampling Parameters',
                    'presets.estimatedTokens': 'Estimated Tokens',
                    'presets.remainingContext': 'Remaining Context:',
                    'presets.promptEntries': 'Prompt Entries',
                    'presets.addEntry': 'Add New Entry',
                    'presets.restoreDefaults': 'Restore Defaults',

                    // World Info
                    'worldInfo.title': 'World Info',
                    'worldInfo.select': 'Select World Info',
                    'worldInfo.newWorld': 'New World',
                    'worldInfo.import': 'Import',
                    'worldInfo.export': 'Export',
                    'worldInfo.delete': 'Delete',
                    'worldInfo.newEntry': 'New Entry',
                    'worldInfo.selectTip': 'Select an entry to edit, or create a new one.',
                    'worldInfo.enabled': 'Enabled',
                    'worldInfo.entryTitle': 'Entry Title (optional)',
                    'worldInfo.clone': 'Clone',
                    'worldInfo.primaryKeys': 'Primary Keywords (comma-separated)',
                    'worldInfo.caseSensitive': 'Case Sensitive',
                    'worldInfo.wholeWord': 'Whole Word',
                    'worldInfo.content': 'Content',
                    'worldInfo.insertPosition': 'Insert Position',
                    'worldInfo.role': 'Role',
                    'worldInfo.depth': 'Depth',
                    'worldInfo.priority': 'Priority',
                    'worldInfo.constant': 'Always Enabled (Constant)',
                    'worldInfo.selective': 'Selective',
                    'worldInfo.excludeRecursion': 'Exclude Recursion',
                    'worldInfo.additionalSources': 'Additional Match Sources',
                    'worldInfo.charDesc': 'Character Description',
                    'worldInfo.charPersonality': 'Character Personality',
                    'worldInfo.scenario': 'Scenario',
                    'worldInfo.userProfile': 'User Profile Description',
                    'worldInfo.charNotes': 'Character Notes',
                    'worldInfo.creatorNotes': 'Creator Notes',

                    // Regex
                    'regex.title': 'Regular Expressions',
                    'regex.newGlobal': 'New Global Regex',
                    'regex.newLocal': 'New Local Regex',
                    'regex.import': 'Import Regex',
                    'regex.globalScripts': 'Global Regex Scripts',
                    'regex.globalTitle': 'Global Regex Scripts',
                    'regex.globalDesc': 'Affects all characters, saved in local settings.',
                    'regex.localScripts': 'Local Regex Scripts',
                    'regex.localTitle': 'Local Regex Scripts',
                    'regex.localDesc': 'Only affects current character, saved in character card.',
                    'regex.enable': 'Enable',

                    // Theme Settings
                    'theme.title': 'Theme Settings',
                    'theme.tabPresets': 'Presets',
                    'theme.tabCustom': 'Custom CSS',
                    'theme.tabSaved': 'Saved',
                    'theme.presetThemes': 'Preset Themes',
                    'theme.customCSS': 'Custom CSS',
                    'theme.savedThemes': 'Saved Themes',
                    'theme.default': 'Default',
                    'theme.dark': 'Dark',
                    'theme.blue': 'Ocean',
                    'theme.ocean': 'Ocean',
                    'theme.green': 'Forest',
                    'theme.forest': 'Forest',
                    'theme.purple': 'Violet',
                    'theme.violet': 'Violet',
                    'theme.pink': 'Sakura',
                    'theme.sakura': 'Sakura',
                    'theme.colorSettings': 'Color Settings',
                    'theme.primary': 'Primary Color',
                    'theme.primaryColor': 'Primary Color',
                    'theme.userBubble': 'User Bubble',
                    'theme.bg': 'Background',
                    'theme.aiBubble': 'AI Bubble',
                    'theme.cardBg': 'Card Background',
                    'theme.text': 'Text Color',
                    'theme.border': 'Border Color',
                    'theme.inputBg': 'Input Background',
                    'theme.textSecondary': 'Secondary Text',
                    'theme.primaryHover': 'Primary Hover',
                    'theme.format': 'Format',
                    'theme.minify': 'Minify',
                    'theme.preview': 'Preview',
                    'theme.customCSSPlaceholder': '/* Enter your custom CSS */',
                    'theme.customCSSHint': 'Tip: You can override all existing CSS variables and classes. Use preview to see effects.',
                    'theme.cssVarsRef': 'CSS Variables Reference',
                    'theme.myThemes': 'My Themes',
                    'theme.saveCurrentTheme': 'Save Current Theme',
                    'theme.noSavedThemes': 'No saved themes yet',
                    'theme.apply': 'Apply',
                    'theme.saveAsNew': 'Save as New Theme',
                    'theme.exportTheme': 'Export Theme',
                    'theme.importTheme': 'Import Theme',
                    'theme.reset': 'Reset to Default',
                    'theme.save': 'Save Theme',

                    // User Settings
                    'user.title': 'User Management',
                    'user.currentUser': 'Current User',
                    'user.defaultUser': 'Default User',
                    'user.online': 'Online',
                    'user.new': 'New User',
                    'user.newUser': 'New User',
                    'user.switch': 'Switch User',
                    'user.switchUser': 'Switch User',
                    'user.selectTip': 'Select a user to edit, or create a new one.',
                    'user.uploadAvatar': 'Upload Avatar',
                    'user.name': 'User Name',
                    'user.avatar': 'Avatar URL',
                    'user.status': 'Status/Mood',
                    'user.save': 'Save',
                    'user.use': 'Use',
                    'user.duplicate': 'Duplicate',
                    'user.delete': 'Delete',
                    'user.description': 'User Persona (sent to AI)',
                    'user.descriptionPlaceholder': 'Describe your persona, e.g.: You are a programmer who enjoys tech discussions...',
                    'user.systemPrompt': 'System Prompt (optional, added to system message)',
                    'user.systemPromptPlaceholder': 'E.g.: Please answer technical questions professionally...',
                    'user.expandEdit': 'Expand Edit',
                    'user.preferences': 'Preferences',
                    'user.language': 'Interface Language',
                    'user.autoAnnounce': 'Auto-send user description',
                    'user.showTyping': 'Show typing indicator',

                    // Chat Interface
                    'chat.reselectGreeting': 'Reselect Greeting',
                    'chat.moreOptions': 'More Options',
                    'chat.viewPrompt': 'View Prompt',
                    'chat.newChat': 'New Chat',
                    'chat.sendImage': 'Send Image',
                    'chat.summarize': 'Summarize Chat',
                    'chat.exportConfig': 'Export Configuration',
                    'chat.importConfig': 'Import Configuration',
                    'chat.exportChat': 'Export Chat History',
                    'chat.importChat': 'Import Chat History',
                    'chat.inputPlaceholder': 'Type a message...',
                    'chat.sendMessage': 'Send Message',

                    // Preferences
                    'preferences.title': 'Preferences',
                    'preferences.language': 'Interface Language',
                    'preferences.behavior': 'User Behavior',
                    'preferences.autoAnnounce': 'Auto-send user description',
                    'preferences.showTyping': 'Show typing indicator',
                    'preferences.save': 'Save Settings',

                    // Summarize Chat
                    'summary.title': 'Summarize Chat Settings',
                    'summary.apiConfig': 'Summary API Configuration',
                    'summary.apiUrl': 'API URL',
                    'summary.apiUrlPlaceholder': 'https://api.openai.com/v1/chat/completions',
                    'summary.apiKey': 'API Key',
                    'summary.apiKeyPlaceholder': 'sk-...',
                    'summary.model': 'Model',
                    'summary.selectModel': 'Select model...',
                    'summary.customModel': 'Custom...',
                    'summary.customModelPlaceholder': 'Enter custom model name',
                    'summary.saveConfig': 'Save Configuration',
                    'summary.loadConfig': 'Load Configuration',
                    'summary.settings': 'Summary Settings',
                    'summary.messageCount': 'Message Count',
                    'summary.messageCountHint': 'Summarize the last N messages',
                    'summary.autoEnable': 'Enable auto-summarize',
                    'summary.autoEnableHint': 'Auto-trigger summary when reaching set message count',
                    'summary.autoHide': 'Auto-hide summarized messages',
                    'summary.autoHideHint': 'Hidden messages won\'t be sent to AI',
                    'summary.promptTemplates': 'Prompt Templates',
                    'summary.selectTemplate': 'Select template...',
                    'summary.loadTemplate': 'Load template',
                    'summary.saveTemplate': 'Save as new template',
                    'summary.deleteTemplate': 'Delete template',
                    'summary.prompt': 'Summary Prompt',
                    'summary.promptPlaceholder': 'Please summarize the following conversation...',
                    'summary.start': 'Start Summary',
                    'summary.test': 'Test API',
                    'summary.processing': 'Summarizing...',
                    'summary.result': 'Summary Result',

                    // Prompt Preview
                    'prompt.title': 'Prompt Preview',
                    'prompt.checkTitle': 'Prompt Components Check:',
                    'prompt.checkSystemPrompt': 'System Prompt',
                    'prompt.checkUserProfile': 'User Persona',
                    'prompt.checkCharDesc': 'Character Description',
                    'prompt.checkWorldInfo': 'World Info',
                    'prompt.checkChatHistory': 'Chat History',
                    'prompt.checkRegex': 'Regex Processing',
                    'prompt.refresh': 'Refresh Preview',
                    'prompt.system': 'System Prompt',
                    'prompt.userPersona': 'User Persona',
                    'prompt.charDesc': 'Character Description',
                    'prompt.worldInfo': 'World Info',
                    'prompt.chatHistory': 'Chat History',
                    'prompt.regex': 'Regex Processing',
                    'prompt.totalTokens': 'Total Tokens: ',
                    'prompt.systemTokens': 'System: ',
                    'prompt.chatTokens': 'Chat: ',
                    'prompt.worldTokens': 'World: ',
                    'prompt.copy': 'Copy',

                    // Message Actions
                    'msg.edit': 'Edit',
                    'msg.regenerate': 'Regenerate',
                    'msg.delete': 'Delete',
                    'msg.deleteConfirm': 'Delete this message?',
                    'msg.send': 'Send',
                    'msg.placeholder': 'Type a message...',
                    'msg.imageRecognizing': 'Recognizing image...',
                    'msg.imageInfo': '[Image]',

                    // Message Edit Modal
                    'msgEdit.title': 'Edit Message',
                    'msgEdit.content': 'Message Content',
                    'msgEdit.expandWindow': 'Expand/Collapse window',
                    'msgEdit.save': 'Save',
                    'msgEdit.cancel': 'Cancel',

                    // Greeting Edit Modal
                    'greetingEdit.title': 'Edit Greeting',
                    'greetingEdit.placeholder': 'Enter greeting content...',
                    'greetingEdit.save': 'Save',
                    'greetingEdit.cancel': 'Cancel',

                    // User Selector Modal
                    'userSelector.title': 'Select User',

                    // Character Selector Modal
                    'charSelector.title': 'Select Character',
                    'charSelector.searchPlaceholder': 'Search character name...',
                    'charSelector.tagFilterPlaceholder': 'Filter by tag (enter tag name)',

                    // Greeting Selector Modal
                    'greetingSelector.title': 'Select Greeting',

                    // Edit Modals
                    'edit.promptTitle': 'Edit Prompt Entry',
                    'edit.promptName': 'Name',
                    'edit.promptPosition': 'Position',
                    'edit.promptDepth': 'Depth',
                    'edit.promptContent': 'Content',
                    'edit.saveChanges': 'Save Changes',
                    'edit.delete': 'Delete',
                    'edit.positionRelative': 'Relative',
                    'edit.positionInChat': 'In-chat',

                    // Regex Edit Modal
                    'regexEdit.title': 'Regex Script Editor',
                    'regexEdit.scriptName': 'Script Name',
                    'regexEdit.findPattern': 'Find Regex',
                    'regexEdit.replaceWith': 'Replace With',
                    'regexEdit.scope': 'Scope',
                    'regexEdit.scopeUserInput': 'User Input',
                    'regexEdit.scopeAIOutput': 'AI Output',
                    'regexEdit.scopeQuickReply': 'Quick Reply',
                    'regexEdit.scopeWorldInfo': 'World Info',
                    'regexEdit.options': 'Other Options',
                    'regexEdit.markdownOnly': 'Markdown Only',
                    'regexEdit.promptOnly': 'Prompt Only',
                    'regexEdit.minDepth': 'Min Depth',
                    'regexEdit.maxDepth': 'Max Depth',
                    'regexEdit.noLimit': 'Unlimited',
                    'regexEdit.save': 'Save',
                    'regexEdit.delete': 'Delete',

                    // Regex Import Modal
                    'regexImport.title': 'Import to:',
                    'regexImport.global': 'Global Regex Scripts',
                    'regexImport.local': 'Local Regex Scripts',
                    'regexImport.confirm': 'Confirm',
                    'regexImport.cancel': 'Cancel',

                    // Text Edit Modal
                    'textEdit.title': 'Edit Text',
                    'textEdit.save': 'Save',
                    'textEdit.cancel': 'Cancel',

                    // Common
                    'common.save': 'Save',
                    'common.cancel': 'Cancel',
                    'common.confirm': 'Confirm',
                    'common.close': 'Close',
                    'common.loading': 'Loading...',
                    'common.success': 'Success',
                    'common.error': 'Error',
                }
            },

            // è·å–ç¿»è¯‘æ–‡æœ¬
            t(key, lang = null) {
                const targetLang = lang || this.currentLang;
                return this.translations[targetLang]?.[key] || key;
            },

            // åˆ‡æ¢è¯­è¨€
            setLanguage(lang) {
                this.currentLang = lang;
                localStorage.setItem('app_language', lang);
                this.updatePageTexts();
            },

            // æ›´æ–°é¡µé¢æ‰€æœ‰æ–‡æœ¬
            updatePageTexts() {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    const attr = el.getAttribute('data-i18n-attr');
                    if (attr) {
                        el.setAttribute(attr, this.t(key));
                    } else {
                        el.textContent = this.t(key);
                    }
                });

                // æ›´æ–° placeholder
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    el.placeholder = this.t(key);
                });

                // æ›´æ–° title
                document.querySelectorAll('[data-i18n-title]').forEach(el => {
                    const key = el.getAttribute('data-i18n-title');
                    el.title = this.t(key);
                });
            },

            // åˆå§‹åŒ–
            init() {
                const savedLang = localStorage.getItem('app_language') || 'zh';
                this.currentLang = savedLang;
                // é¡µé¢åŠ è½½å®Œæˆåæ›´æ–°æ–‡æœ¬
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.updatePageTexts());
                } else {
                    this.updatePageTexts();
                }
            }
        };

        // åˆå§‹åŒ–å¤šè¯­è¨€ç³»ç»Ÿ
        i18n.init();

        // --- IndexedDB å°è£…ç±» ---
        class IndexedDBStorage {
            constructor(dbName = 'SillyTavernDB', storeName = 'keyValueStore', version = 1) {
                this.dbName = dbName;
                this.storeName = storeName;
                this.version = version;
                this.db = null;
                this.initPromise = this.init();
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => {
                        console.error('IndexedDB æ‰“å¼€å¤±è´¥:', request.error);
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('IndexedDB åˆå§‹åŒ–æˆåŠŸ');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName, { keyPath: 'key' });
                            console.log('IndexedDB å¯¹è±¡å­˜å‚¨åˆ›å»ºæˆåŠŸ');
                        }
                    };
                });
            }

            async setItem(key, value) {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put({ key, value });

                    request.onsuccess = () => resolve();
                    request.onerror = () => {
                        console.error('IndexedDB setItem å¤±è´¥:', request.error);
                        reject(request.error);
                    };
                });
            }

            async getItem(key) {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);

                    request.onsuccess = () => {
                        resolve(request.result ? request.result.value : null);
                    };
                    request.onerror = () => {
                        console.error('IndexedDB getItem å¤±è´¥:', request.error);
                        reject(request.error);
                    };
                });
            }

            async removeItem(key) {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(key);

                    request.onsuccess = () => resolve();
                    request.onerror = () => {
                        console.error('IndexedDB removeItem å¤±è´¥:', request.error);
                        reject(request.error);
                    };
                });
            }

            async clear() {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve();
                    request.onerror = () => {
                        console.error('IndexedDB clear å¤±è´¥:', request.error);
                        reject(request.error);
                    };
                });
            }

            async getAllKeys() {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAllKeys();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => {
                        console.error('IndexedDB getAllKeys å¤±è´¥:', request.error);
                        reject(request.error);
                    };
                });
            }

            // ä» localStorage è¿ç§»æ•°æ®åˆ° IndexedDB
            async migrateFromLocalStorage() {
                console.log('[æ•°æ®è¿ç§»] å¼€å§‹ä» localStorage è¿ç§»åˆ° IndexedDB...');
                let migratedCount = 0;

                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        await this.setItem(key, value);
                        migratedCount++;
                    }
                    console.log(`[æ•°æ®è¿ç§»] æˆåŠŸè¿ç§» ${migratedCount} æ¡æ•°æ®`);

                    // å¯é€‰ï¼šæ¸…ç©º localStorageï¼ˆè°¨æ…æ“ä½œï¼‰
                    // localStorage.clear();

                    return { success: true, count: migratedCount };
                } catch (error) {
                    console.error('[æ•°æ®è¿ç§»] è¿ç§»å¤±è´¥:', error);
                    return { success: false, error, count: migratedCount };
                }
            }

            // è®¡ç®—å½“å‰å­˜å‚¨ä½¿ç”¨æƒ…å†µ
            async getStorageStats() {
                await this.initPromise;
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const items = request.result;
                        let totalSize = 0;
                        items.forEach(item => {
                            totalSize += JSON.stringify(item).length;
                        });

                        resolve({
                            itemCount: items.length,
                            totalSize: totalSize,
                            totalSizeKB: (totalSize / 1024).toFixed(2),
                            totalSizeMB: (totalSize / 1024 / 1024).toFixed(2)
                        });
                    };
                    request.onerror = () => {
                        console.error('IndexedDB getStorageStats å¤±è´¥:', request.error);
                        reject(request.error);
                    };
                });
            }
        }

        // åˆ›å»ºå…¨å±€ IndexedDB å­˜å‚¨å®ä¾‹
        const idbStorage = new IndexedDBStorage();

        // å…¨å±€èŠå¤©å†å²è®°å½•æ•°ç»„
        let chatHistory = []; // Array of { role: 'user'/'assistant', content: '...' }

        document.addEventListener('DOMContentLoaded', async () => {
            // ç­‰å¾… IndexedDB åˆå§‹åŒ–å®Œæˆ
            await idbStorage.initPromise;
            console.log('IndexedDB å·²å°±ç»ª');

            // æ£€æŸ¥æ˜¯å¦éœ€è¦ä» localStorage è¿ç§»æ•°æ®
            const hasMigrated = await idbStorage.getItem('_migration_completed');
            if (!hasMigrated && localStorage.length > 0) {
                console.log('[åˆå§‹åŒ–] æ£€æµ‹åˆ° localStorage æ•°æ®ï¼Œå¼€å§‹è¿ç§»...');
                const result = await idbStorage.migrateFromLocalStorage();
                if (result.success) {
                    await idbStorage.setItem('_migration_completed', 'true');
                    console.log('[åˆå§‹åŒ–] æ•°æ®è¿ç§»å®Œæˆ');

                    // æ˜¾ç¤ºè¿ç§»ç»Ÿè®¡
                    const stats = await idbStorage.getStorageStats();
                    console.log('[å­˜å‚¨ç»Ÿè®¡]', stats);
                }
            }

            // --- è‡ªåŠ¨ä¿å­˜åŠŸèƒ½ ---
            let saveTimeout = null;
            const saveToast = document.getElementById('save-toast');

            // æ˜¾ç¤ºä¿å­˜æç¤º
            function showSaveToast(message = 'å·²è‡ªåŠ¨ä¿å­˜') {
                const messageEl = saveToast.querySelector('.message');
                messageEl.textContent = message;
                saveToast.classList.add('show');
                setTimeout(() => {
                    saveToast.classList.remove('show');
                }, 2000);
            }

            // é˜²æŠ–ä¿å­˜å‡½æ•°
            function triggerAutoSave() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    console.log('[è‡ªåŠ¨ä¿å­˜] æ­£åœ¨ä¿å­˜æ•°æ®...');
                    showSaveToast('å·²è‡ªåŠ¨ä¿å­˜');
                }, 1000); // 1ç§’åä¿å­˜
            }

            // ç›‘å¬æ‰€æœ‰å¯èƒ½ä¿®æ”¹æ•°æ®çš„äº‹ä»¶
            // æ³¨æ„ï¼šç”±äºsaveCharactersç­‰å‡½æ•°åœ¨åé¢å®šä¹‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åé¢å†è®¾ç½®ç›‘å¬

            // --- Sidebar Logic ---
            const sidebar = document.getElementById('sidebar');
            const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
            const appWrapper = document.getElementById('app-wrapper');

            mobileSidebarToggle.addEventListener('click', () => {
                sidebar.classList.remove('collapsed');
            });

            document.addEventListener('click', function(event) {
                if (!sidebar.contains(event.target) && !mobileSidebarToggle.contains(event.target)) {
                    sidebar.classList.add('collapsed');
                }
            });

            // --- Modal Logic ---
            const mainModals = ['api-settings-modal', 'presets-modal', 'character-modal', 'world-info-modal', 'regex-modal', 'user-profile-modal', 'theme-settings-modal', 'preferences-modal'];
            
            document.querySelectorAll('#main-nav button').forEach(button => {
                button.addEventListener('click', () => { showModal(button.dataset.modal); });
            });
            function showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    closeAllModals();
                    modal.classList.add('active');
                    document.querySelector(`[data-modal="${modalId}"]`).classList.add('active');
                    sidebar.classList.add('collapsed');
                }
            }
            function closeAllModals() {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    if (!modal.classList.contains('sub-modal') && !modal.classList.contains('super-sub-modal')) modal.classList.remove('active');
                });
                document.querySelectorAll('#main-nav button').forEach(btn => btn.classList.remove('active'));
            }
            
            document.querySelectorAll('.modal-overlay:not(.sub-modal):not(.super-sub-modal)').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) closeAllModals(); });
            });
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeAllModals));

            const editPromptModal = document.getElementById('edit-prompt-modal');
            editPromptModal.addEventListener('click', (e) => { if (e.target === editPromptModal) closeEditPromptModal(); });
            document.querySelectorAll('#edit-prompt-modal .close-sub-modal-btn').forEach(btn => btn.addEventListener('click', closeEditPromptModal));
            
            const editRegexModal = document.getElementById('edit-regex-modal');
            editRegexModal.addEventListener('click', (e) => { if (e.target === editRegexModal) closeEditRegexModal(); });
            document.querySelectorAll('#edit-regex-modal .close-sub-modal-btn').forEach(btn => btn.addEventListener('click', closeEditRegexModal));

            function openEditPromptModal(promptData, index) {
                document.getElementById('edit-prompt-index').value = index;
                document.getElementById('prompt-name-input').value = promptData.name || '';
                document.getElementById('prompt-position-select').value = promptData.injection_position ?? 0;
                document.getElementById('prompt-depth-input').value = promptData.injection_depth ?? 4;
                document.getElementById('prompt-content-input').value = promptData.content || '';
                editPromptModal.classList.add('active');
            }

            function closeEditPromptModal() {
                editPromptModal.classList.remove('active');
            }
            
            function openEditRegexModal() { editRegexModal.classList.add('active'); }
            function closeEditRegexModal() { editRegexModal.classList.remove('active'); }

            // --- PNG tEXt Chunk Reader ---
            // Based on https://github.com/sillytavern/sillytavern-extras/blob/main/png-metadata-reader/main.js
            async function extractPNGChunk(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const arr = new Uint8Array(event.target.result);
                        // Find the tEXt chunk for "chara"
                        const keyword = "chara";
                        let PngMagic = [137, 80, 78, 71, 13, 10, 26, 10];
                        if (!arr.slice(0, 8).every((val, i) => val === PngMagic[i])) {
                           return reject(new Error('Not a valid PNG file.'));
                        }

                        const decoder = new TextDecoder('utf-8');
                        let i = 8;
                        while (i < arr.length) {
                            const length = (arr[i] << 24) | (arr[i + 1] << 16) | (arr[i + 2] << 8) | arr[i + 3];
                            const type = String.fromCharCode(arr[i + 4], arr[i + 5], arr[i + 6], arr[i + 7]);

                            if (type === 'tEXt') {
                                const chunkData = arr.slice(i + 8, i + 8 + length);
                                let j = 0;
                                while (j < chunkData.length && chunkData[j] !== 0) { j++; }
                                const currentKeyword = decoder.decode(chunkData.slice(0, j));

                                if (currentKeyword === keyword) {
                                    const content = decoder.decode(chunkData.slice(j + 1));
                                    try {
                                        // Decode base64 to binary string
                                        const base64decoded = atob(content);
                                        // Convert binary string to UTF-8 bytes
                                        const bytes = new Uint8Array(base64decoded.length);
                                        for (let k = 0; k < base64decoded.length; k++) {
                                            bytes[k] = base64decoded.charCodeAt(k);
                                        }
                                        // Decode UTF-8 bytes to string
                                        const utf8String = new TextDecoder('utf-8').decode(bytes);
                                        const charData = JSON.parse(utf8String);
                                        return resolve({ charData, png: file });
                                    } catch (e) {
                                        return reject(new Error(`Failed to parse character data from PNG: ${e.message}`));
                                    }
                                }
                            }
                            i += 12 + length;
                        }
                        return reject(new Error('No "chara" metadata found in PNG file.'));
                    };
                    reader.onerror = () => reject(new Error('Failed to read file.'));
                    reader.readAsArrayBuffer(file);
                });
            }
            
            // --- Advanced API Logic (Enhanced from Tea House) ---
            const api = {
                configName: document.getElementById('apiConfigNameInput'),
                url: document.getElementById('api-url'),
                key: document.getElementById('api-key'),
                modelName: document.getElementById('model-name'),
                streaming: document.getElementById('api-streaming-toggle'),
                visionUrl: document.getElementById('vision-api-url'),
                visionKey: document.getElementById('vision-api-key'),
                
                savedSelect: document.getElementById('savedApiSelect'),
                modelSelect: document.getElementById('model-select'),
                visionModelSelect: document.getElementById('vision-model-select'),
                
                loadBtn: document.getElementById('loadApiBtn'),
                deleteBtn: document.getElementById('deleteApiBtn'),
                saveAsNewBtn: document.getElementById('saveAsNewBtn'),
                updateCurrentBtn: document.getElementById('updateCurrentBtn'),
                testBtn: document.getElementById('testApiConnection'),
                debugModelsBtn: document.getElementById('debugModelsBtn'),
                directChatTestBtn: document.getElementById('directChatTestBtn'),
                loadModelsBtn: document.getElementById('load-models-btn'),
                loadVisionModelsBtn: document.getElementById('load-vision-models-btn'),
                
                resultDiv: document.getElementById('api-test-result'),
                visionResultDiv: document.getElementById('vision-api-test-result'),
                
                configs: {},
                currentId: null,
            };

            async function loadApiConfigs() {
                const configsData = await idbStorage.getItem('api_configs_v1');
                api.configs = configsData ? JSON.parse(configsData) : {};
                api.currentId = await idbStorage.getItem('current_api_id_v1');
                updateApiSelect();
                if (api.currentId && api.configs[api.currentId]) {
                    loadApiConfig(api.currentId);
                } else {
                    const firstId = Object.keys(api.configs)[0];
                    if(firstId) loadApiConfig(firstId);
                }
            }

            async function saveApiConfigs() {
                await idbStorage.setItem('api_configs_v1', JSON.stringify(api.configs));
                await idbStorage.setItem('current_api_id_v1', api.currentId);
            }

            function updateApiSelect() {
                api.savedSelect.innerHTML = '<option value="">é€‰æ‹©é…ç½®</option>';
                Object.keys(api.configs).forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = api.configs[id].name;
                    api.savedSelect.appendChild(option);
                });
                if (api.currentId) {
                    api.savedSelect.value = api.currentId;
                }
            }
            
            function loadApiConfig(id) {
                const config = api.configs[id];
                if (!config) return;

                api.configName.value = config.name || '';
                api.url.value = config.url || '';
                api.key.value = config.key || '';
                api.modelName.value = config.model || '';
                api.streaming.checked = config.streaming === undefined ? true : config.streaming; // Default to true
                api.visionUrl.value = config.visionUrl || '';
                api.visionKey.value = config.visionKey || '';

                api.modelSelect.innerHTML = '';
                (config.models || []).forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = m;
                    api.modelSelect.appendChild(opt);
                });
                if(config.model) api.modelSelect.value = config.model;

                // å¦‚æœæœ‰æ¨¡å‹åˆ—è¡¨ï¼Œæ˜¾ç¤ºä¸‹æ‹‰æ¡†ï¼Œéšè—è¾“å…¥æ¡†ï¼›å¦åˆ™ç›¸å
                const hasModels = config.models && config.models.length > 0;
                api.modelSelect.classList.toggle('hidden', !hasModels);
                api.modelName.classList.toggle('hidden', hasModels);

                api.visionModelSelect.innerHTML = '';
                 (config.visionModels || []).forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = m;
                    api.visionModelSelect.appendChild(opt);
                });
                if(config.visionModel) api.visionModelSelect.value = config.visionModel;
                api.visionModelSelect.classList.toggle('hidden', !(config.visionModels && config.visionModels.length > 0));

                api.currentId = id;
                api.savedSelect.value = id;
                updateApiButtons();
            }

            function getCurrentApiConfigFromForm() {
                return {
                    name: api.configName.value.trim(),
                    url: api.url.value.trim(),
                    key: api.key.value.trim(),
                    model: api.modelName.value.trim(),
                    streaming: api.streaming.checked,
                    visionUrl: api.visionUrl.value.trim(),
                    visionKey: api.visionKey.value.trim(),
                    visionModel: api.visionModelSelect.value,
                    models: [...api.modelSelect.options].map(o => o.value).filter(o => o),
                    visionModels: [...api.visionModelSelect.options].map(o => o.value).filter(o => o),
                };
            }

            function updateApiButtons() {
                const hasSelection = !!api.savedSelect.value;
                const hasName = !!api.configName.value.trim();
                api.loadBtn.disabled = !hasSelection;
                api.deleteBtn.disabled = !hasSelection;
                api.updateCurrentBtn.disabled = !api.currentId || !hasName;
                api.saveAsNewBtn.disabled = !hasName;
            }

            api.savedSelect.addEventListener('change', updateApiButtons);
            api.configName.addEventListener('input', updateApiButtons);

            api.loadBtn.addEventListener('click', () => {
                if (api.savedSelect.value) loadApiConfig(api.savedSelect.value);
            });
            api.deleteBtn.addEventListener('click', async () => {
                const id = api.savedSelect.value;
                if(id && confirm(`ç¡®å®šè¦åˆ é™¤é…ç½® "${api.configs[id].name}" å—?`)){
                    delete api.configs[id];
                    if(api.currentId === id) {
                         api.currentId = null;
                         Object.keys(api).forEach(key => {
                             if (api[key].tagName === 'INPUT' || api[key].tagName === 'SELECT') {
                                 if (api[key].type === 'checkbox') api[key].checked = false;
                                 else api[key].value = '';
                             }
                         });
                    }
                    await saveApiConfigs();
                    await loadApiConfigs();
                }
            });
            api.saveAsNewBtn.addEventListener('click', async () => {
                const newConfig = getCurrentApiConfigFromForm();
                if(!newConfig.name) { alert("è¯·è¾“å…¥é…ç½®åç§°"); return; }
                const newId = `api_${Date.now()}`;
                api.configs[newId] = newConfig;
                api.currentId = newId;
                await saveApiConfigs();
                updateApiSelect();
                api.savedSelect.value = newId;
                updateApiButtons();
                showApiResult("é…ç½®å·²ä¿å­˜ï¼", "success", "resultDiv");
            });
            api.updateCurrentBtn.addEventListener('click', async () => {
                const id = api.currentId;
                if (!id) { alert("æ²¡æœ‰æ´»åŠ¨çš„é…ç½®å¯æ›´æ–°ã€‚è¯·å…ˆåŠ è½½ä¸€ä¸ªæˆ–æ–°å»ºã€‚"); return; }
                const updatedConfig = getCurrentApiConfigFromForm();
                if(!updatedConfig.name) { alert("è¯·è¾“å…¥é…ç½®åç§°"); return; }

                console.log('[APIé…ç½®] å‡†å¤‡æ›´æ–°é…ç½®:', id, updatedConfig);
                api.configs[id] = updatedConfig;
                await saveApiConfigs();
                console.log('[APIé…ç½®] é…ç½®å·²ä¿å­˜åˆ°å­˜å‚¨');

                updateApiSelect();
                showApiResult("é…ç½®å·²æ›´æ–°ï¼", "success", "resultDiv");

                // éªŒè¯ä¿å­˜
                const savedConfigs = await idbStorage.getItem('api_configs_v1');
                console.log('[APIé…ç½®] éªŒè¯ä¿å­˜åçš„é…ç½®:', JSON.parse(savedConfigs));
            });

            function showApiResult(message, type, elementId) {
                const div = document.getElementById(elementId);
                div.innerHTML = message;
                div.className = `text-sm mt-2 text-center h-auto min-h-[1rem] ${type === 'success' ? 'text-green-500' : type === 'error' ? 'text-red-500' : 'text-yellow-500'}`;
            }

            async function testConnection(isVision = false, isDebug = false) {
                const url = isVision ? api.visionUrl.value.trim() : api.url.value.trim();
                const key = isVision ? api.visionKey.value.trim() : api.key.value.trim();
                const resultDivId = isVision ? 'vision-api-test-result' : 'api-test-result';
                const btn = isDebug ? api.debugModelsBtn : api.testBtn;

                if (!url || !key) {
                    showApiResult('è¯·å¡«å†™ API URL å’Œ Keyã€‚', 'error', resultDivId);
                    return;
                }
                showApiResult('æµ‹è¯•ä¸­...', 'info', resultDivId);
                btn.disabled = true;
                
                try {
                    let modelsUrl;
                    let headers = {};
                    const urlObj = new URL(url);

                    if (urlObj.hostname.includes('google')) {
                         modelsUrl = `${urlObj.origin}/v1beta/models?key=${key}`;
                    } else {
                        modelsUrl = `${url.replace(/\/$/, '')}/models`;
                        headers['Authorization'] = `Bearer ${key}`;
                    }
                    
                    const response = await fetch(modelsUrl, { headers });
                    if (response.ok) {
                        const data = await response.json();
                        let models = [];
                        if (data.data) models = data.data; // OpenAI format
                        else if (data.models) models = data.models.map(m => ({ id: m.name.replace('models/', '') })); // Google format

                        if (isDebug) {
                             const allModelIds = models.map(m => m.id).sort();
                             const debugHtml = `<details class="text-left"><summary>å‘ç° ${allModelIds.length} ä¸ªæ¨¡å‹</summary><pre class="bg-gray-100 p-2 rounded-md max-h-40 overflow-y-auto text-xs">${JSON.stringify(allModelIds, null, 2)}</pre></details>`;
                             showApiResult(debugHtml, 'success', resultDivId);
                        } else {
                            showApiResult(`è¿æ¥æˆåŠŸï¼å‘ç° ${models.length} ä¸ªæ¨¡å‹`, 'success', resultDivId);
                        }
                    } else {
                        const error = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        throw new Error(`HTTP ${response.status}: ${error.error?.message || response.statusText}`);
                    }
                } catch (error) {
                    showApiResult(`è¿æ¥å¤±è´¥: ${error.message}`, 'error', resultDivId);
                } finally {
                    btn.disabled = false;
                }
            }

            async function loadModels(isVision = false) {
                const url = isVision ? api.visionUrl.value.trim() : api.url.value.trim();
                const key = isVision ? api.visionKey.value.trim() : api.key.value.trim();
                const btn = isVision ? api.loadVisionModelsBtn : api.loadModelsBtn;
                const select = isVision ? api.visionModelSelect : api.modelSelect;
                const input = isVision ? null : api.modelName; // ä¸»æ¨¡å‹æœ‰è¾“å…¥æ¡†
                const resultDivId = isVision ? 'vision-api-test-result' : 'api-test-result';

                const originalBtnText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>åŠ è½½ä¸­...';
                btn.disabled = true;
                select.classList.add('hidden');
                if (input) input.classList.remove('hidden');

                try {
                    let modelsUrl;
                    let headers = {};
                    const urlObj = new URL(url);

                    if (urlObj.hostname.includes('google')) {
                         modelsUrl = `${urlObj.origin}/v1beta/models?key=${key}`;
                    } else {
                        modelsUrl = `${url.replace(/\/$/, '')}/models`;
                        headers['Authorization'] = `Bearer ${key}`;
                    }

                    const response = await fetch(modelsUrl, { headers });
                    if (!response.ok) throw new Error('æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨');

                    const data = await response.json();
                    let models = [];
                    if (data.data) models = data.data; // OpenAI format
                    else if (data.models) models = data.models.map(m => ({ id: m.name.replace('models/', '') })); // Google format

                    select.innerHTML = '<option value="">--é€‰æ‹©ä¸€ä¸ªæ¨¡å‹--</option>';
                    models.sort((a,b) => a.id.localeCompare(b.id)).forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id;
                        select.appendChild(option);
                    });

                    if (api.currentId && api.configs[api.currentId]) {
                        const currentConfig = api.configs[api.currentId];
                        const modelToSelect = isVision ? currentConfig.visionModel : currentConfig.model;
                        if(modelToSelect) select.value = modelToSelect;
                    }

                    select.classList.remove('hidden');
                    if (input) input.classList.add('hidden'); // åŠ è½½æˆåŠŸåéšè—è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºä¸‹æ‹‰æ¡†
                    showApiResult(`æ¨¡å‹åŠ è½½æˆåŠŸï¼å…± ${models.length} ä¸ª`, 'success', resultDivId);

                    // Save to current config
                     const currentConfig = getCurrentApiConfigFromForm();
                     if (isVision) {
                        currentConfig.visionModels = models.map(m => m.id);
                     } else {
                        currentConfig.models = models.map(m => m.id);
                     }
                      if (api.currentId) {
                         api.configs[api.currentId] = {...api.configs[api.currentId], ...currentConfig};
                         await saveApiConfigs();
                     }


                } catch(e) {
                    showApiResult(`åŠ è½½æ¨¡å‹å¤±è´¥: ${e.message}`, 'error', resultDivId);
                } finally {
                    btn.innerHTML = originalBtnText;
                    btn.disabled = false;
                }
            }
            
            async function directChatTest() {
                 const url = api.url.value.trim();
                 const key = api.key.value.trim();

                 if (!url || !key) {
                     showApiResult('è¯·å¡«å†™ API URL å’Œ Keyã€‚', 'error', 'api-test-result');
                     return;
                 }

                 showApiResult('ç›´æ¥æµ‹è¯•ä¸­...', 'info', 'api-test-result');
                 api.directChatTestBtn.disabled = true;

                 // ä¼˜å…ˆä½¿ç”¨å·²åŠ è½½çš„æ¨¡å‹åˆ—è¡¨
                 let testModels = [];
                 const selectedConfig = api.currentId ? api.configs[api.currentId] : null;
                 if (selectedConfig?.models?.length) {
                     testModels = selectedConfig.models.slice();
                 } else if (api.modelSelect && api.modelSelect.options?.length) {
                     testModels = Array.from(api.modelSelect.options)
                        .map(opt => opt.value)
                        .filter(v => v);
                 }

                 // è‹¥æ²¡æœ‰å¯ç”¨æ¨¡å‹åˆ—è¡¨ï¼Œå›é€€åˆ°å¸¸è§æ¨¡å‹
                 if (testModels.length === 0) {
                     testModels = [
                         'gpt-3.5-turbo',
                         'gpt-4',
                         'gpt-4-turbo-preview',
                         'deepseek-chat',
                         'gemini-pro',
                         'gemini-1.5-flash',
                         'qwen-turbo',
                         'claude-3-haiku',
                         'llama-3.1-8b-instant',
                         'mixtral-8x7b-instruct'
                     ];
                 }

                 let successModel = null;
                 let successResponse = null;

                 for (const model of testModels) {
                     try {
                         console.log(`Testing model: ${model}`);
                         const urlObj = new URL(url);
                         let endpoint, headers, body;

                         if (urlObj.hostname.includes('google')) {
                             endpoint = `${urlObj.origin}/v1beta/models/${model}:generateContent?key=${key}`;
                             headers = { 'Content-Type': 'application/json' };
                             body = {
                                 contents: [{
                                     role: 'user',
                                     parts: [{ text: 'Say "Hello" and nothing else.' }]
                                 }],
                                 generationConfig: {
                                     maxOutputTokens: 10,
                                     temperature: 0.1
                                 }
                             };
                         } else {
                             endpoint = `${url.replace(/\/$/, '')}/chat/completions`;
                             headers = {
                                 'Content-Type': 'application/json',
                                 'Authorization': `Bearer ${key}`
                             };
                             body = {
                                 model: model,
                                 messages: [{role: 'user', content: 'Say "Hello" and nothing else.'}],
                                 max_tokens: 10,
                                 temperature: 0.1
                             };
                         }

                         const response = await fetch(endpoint, {
                             method: 'POST',
                             headers: headers,
                             body: JSON.stringify(body)
                         });

                         if (response.ok) {
                             successModel = model;
                             successResponse = await response.json();
                             console.log(`Success with model: ${model}`);
                             break;
                         }
                     } catch (e) {
                         console.log(`Failed with model ${model}:`, e.message);
                     }
                 }

                 if (successModel) {
                     api.modelName.value = successModel;

                     // è‡ªåŠ¨ä¿å­˜é…ç½®
                     const newConfig = getCurrentApiConfigFromForm();
                     if (!api.currentId) {
                         const newId = `api_${Date.now()}`;
                         api.configs[newId] = newConfig;
                         api.currentId = newId;
                     } else {
                         api.configs[api.currentId] = newConfig;
                     }
                     await saveApiConfigs();
                     updateApiSelect();

                     showApiResult(`âœ… ç›´æ¥æµ‹è¯•æˆåŠŸï¼å¯ç”¨æ¨¡å‹: ${successModel}`, 'success', 'api-test-result');
                 } else {
                     showApiResult('âŒ ç›´æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥URL/Keyæˆ–æ‰‹åŠ¨æŒ‡å®šæ¨¡å‹', 'error', 'api-test-result');
                 }
                 api.directChatTestBtn.disabled = false;
            }

            api.testBtn.addEventListener('click', () => testConnection(false));
            api.debugModelsBtn.addEventListener('click', () => testConnection(false, true));
            api.directChatTestBtn.addEventListener('click', directChatTest);
            api.loadModelsBtn.addEventListener('click', () => loadModels(false));
            api.loadVisionModelsBtn.addEventListener('click', () => loadModels(true));
            api.modelSelect.addEventListener('change', () => { if (api.modelSelect.value) api.modelName.value = api.modelSelect.value; });
            api.visionModelSelect.addEventListener('change', () => { 
                const config = api.configs[api.currentId];
                if(config) config.visionModel = api.visionModelSelect.value;
             });

            function getCurrentApiConfig() {
                if (api.currentId && api.configs[api.currentId]) {
                    return api.configs[api.currentId];
                }
                return null;
            }

            // --- Preset Logic ---
            const presetList = document.getElementById('preset-list'), 
                  saveAsPresetBtn = document.getElementById('save-as-preset-btn'), 
                  presetImportInput = document.getElementById('preset-import-json'), 
                  presetExportBtn = document.getElementById('preset-export-json'), 
                  promptListContainer = document.getElementById('prompt-list'), 
                  addPromptBtn = document.getElementById('add-prompt-btn'),
                  restorePromptsBtn = document.getElementById('restore-prompts-btn');

            const paramInputs = {
                temp: { slider: document.getElementById('param-temp'), number: document.getElementById('param-temp-value') },
                top_p: { slider: document.getElementById('param-top-p'), number: document.getElementById('param-top-p-value') },
                top_k: { slider: document.getElementById('param-top-k'), number: document.getElementById('param-top-k-value') },
                freq_pen: { slider: document.getElementById('param-freq-pen'), number: document.getElementById('param-freq-pen-value') },
                pres_pen: { slider: document.getElementById('param-pres-pen'), number: document.getElementById('param-pres-pen-value') },
                rep_pen: { slider: document.getElementById('param-rep-pen'), number: document.getElementById('param-rep-pen-value') },
                max_tokens: { number: document.getElementById('param-max-tokens') },
                context_size: { number: document.getElementById('param-context-size') },
            };

            const defaultPrompts = [
                {"identifier":"main","name":"Main Prompt","enabled":true,"role":"system","content":"...","system_prompt":true,"marker":false},
                {"identifier":"jailbreak","name":"Post-History Instructions","enabled":false,"role":"system","content":"","system_prompt":true,"marker":false},
                {"identifier":"nsfw","name":"Auxiliary Prompt","enabled":false,"role":"system","content":"","system_prompt":true,"marker":false},
                {"identifier":"personaDescription","name":"Persona","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"worldInfoBefore","name":"World Info (before)","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"charDescription","name":"Char Description","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"charPersonality","name":"Char Personality","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"scenario","name":"Scenario","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"dialogueExamples","name":"Chat Examples","enabled":true,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"worldInfoAfter","name":"World Info (after)","enabled":true,"injection_position":0,"role":"system","system_prompt":true,"marker":true},
                {"identifier":"chatHistory","name":"Chat History","enabled":true,"role":"system","system_prompt":true,"marker":true},
            ].map(p => ({...p, injection_depth: 4, injection_order: 100}));
            
            async function getPresets() {
                const data = await idbStorage.getItem('presets_v4');
                return data ? JSON.parse(data) : {};
            }
            async function savePresets(presets, newPresetName = null) {
                // åœ¨æ¸…ç©ºDOMä¹‹å‰å…ˆè·å–å½“å‰é€‰ä¸­çš„é¢„è®¾å
                const current = newPresetName || document.querySelector('.preset-item.active')?.dataset.name || 'é»˜è®¤';
                await idbStorage.setItem('presets_v4', JSON.stringify(presets));
                await loadPresetsList();
                await selectPreset(current);
                triggerAutoSave();
            }
            
            async function loadPresetsList() {
                let presets = await getPresets();
                presetList.innerHTML = '';
                if (!presets['é»˜è®¤']) {
                    presets['é»˜è®¤'] = { temp: 1, top_p: 1, top_k: 50, freq_pen: 0, pres_pen: 0, rep_pen: 1.1, max_tokens: 1024, context_size: 4096, prompts: JSON.parse(JSON.stringify(defaultPrompts)) };
                    await idbStorage.setItem('presets_v4', JSON.stringify(presets));
                }

                if (Array.isArray(presets)) {
                    const newPresets = {};
                    presets.forEach(p => newPresets[p.name || 'æœªå‘½åé¢„è®¾'] = p);
                    presets = newPresets;
                    await idbStorage.setItem('presets_v4', JSON.stringify(presets));
                }

                Object.keys(presets).forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'preset-item p-2 rounded-md cursor-pointer hover:bg-gray-100 flex justify-between items-center';
                    item.dataset.name = name;

                    item.innerHTML = `<div class="flex items-center gap-2"><i class="fas fa-grip-vertical drag-handle text-gray-400"></i><span>${name}</span></div>`;

                    const buttons = document.createElement('div');
                    const saveBtn = document.createElement('button');
                    saveBtn.innerHTML = '<i class="fas fa-save"></i>';
                    saveBtn.className = 'px-2 py-1 text-xs text-gray-500 hover:text-primary-color';
                    saveBtn.title = 'ä¿å­˜';
                    saveBtn.onclick = (e) => { e.stopPropagation(); saveCurrentPreset(name); };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.className = 'px-2 py-1 text-xs text-gray-500 hover:text-red-500';
                    deleteBtn.title = 'åˆ é™¤';
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deletePreset(name); };

                    buttons.appendChild(saveBtn);
                    if (name !== 'é»˜è®¤') buttons.appendChild(deleteBtn);
                    item.appendChild(buttons);
                    item.addEventListener('click', () => selectPreset(name));
                    presetList.appendChild(item);
                });
                const currentPreset = await idbStorage.getItem('currentPreset_v4') || 'é»˜è®¤';
                await selectPreset(currentPreset);
                new Sortable(presetList, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: onPresetSort });
            }

            async function onPresetSort(evt) {
                const presets = await getPresets();
                const orderedNames = [...presetList.children].map(item => item.dataset.name);
                const orderedPresets = {};
                orderedNames.forEach(name => { orderedPresets[name] = presets[name]; });
                await idbStorage.setItem('presets_v4', JSON.stringify(orderedPresets));
            }

            async function selectPreset(name) {
                const presets = await getPresets();
                if (!presets[name]) name = 'é»˜è®¤';
                 document.querySelectorAll('.preset-item').forEach(item => {
                    if (item.dataset.name === name) {
                        item.style.backgroundColor = 'var(--bg-color)';
                        item.style.fontWeight = '500';
                        item.classList.add('active');
                    } else {
                        item.style.backgroundColor = 'transparent';
                         item.style.fontWeight = '400';
                        item.classList.remove('active');
                    }
                });
                await idbStorage.setItem('currentPreset_v4', name);
                await updateFullPresetForm(name);
            }

            async function updateFullPresetForm(presetName) {
                const presets = await getPresets();
                const preset = presets[presetName] || presets['é»˜è®¤'];
                if (!preset) return;

                Object.keys(paramInputs).forEach(key => {
                    const value = preset[key];
                    if (paramInputs[key].slider) paramInputs[key].slider.value = value ?? 0;
                    if (paramInputs[key].number) paramInputs[key].number.value = value ?? 0;
                });
                paramInputs.context_size.number.value = preset.context_size ?? (preset.openai_max_context || 4096);
                
                promptListContainer.innerHTML = '';
                (preset.prompts || []).forEach((promptData, index) => {
                    const entry = document.createElement('div');
                    entry.className = 'prompt-entry rounded-lg p-2 flex justify-between items-center transition-colors';
                    entry.dataset.originalIndex = index;
                    entry.innerHTML = `
                        <div class="flex items-center gap-2 flex-1">
                             <i class="fas fa-grip-vertical drag-handle text-gray-400"></i>
                             <label class="flex items-center gap-2 cursor-pointer flex-1">
                                <input type="checkbox" ${promptData.enabled ? 'checked' : ''} class="prompt-enabled-toggle w-4 h-4 accent-primary-color">
                                <span class="font-medium text-sm">${promptData.name}</span>
                            </label>
                        </div>
                        <div class="text-xs text-gray-500 flex items-center gap-3">
                            <span>${promptData.role || 'system'}</span>
                            <button class="edit-prompt-entry-btn w-8 h-8 flex items-center justify-center btn-secondary rounded-md" data-index="${index}" title="ç¼–è¾‘"><i class="fas fa-pen"></i></button>
                        </div>`;
                    promptListContainer.appendChild(entry);
                });

                promptListContainer.querySelectorAll('.edit-prompt-entry-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                         e.stopPropagation();
                         const index = parseInt(btn.dataset.index);
                         const currentPresetName = document.querySelector('.preset-item.active')?.dataset.name || 'é»˜è®¤';
                         const currentPreset = (await getPresets())[currentPresetName];
                         openEditPromptModal(currentPreset.prompts[index], index);
                    });
                });
                new Sortable(promptListContainer, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: onPromptSort });
            }
            
            async function onPromptSort() {
                const presetName = document.querySelector('.preset-item.active').dataset.name;
                const presets = await getPresets();
                const prompts = presets[presetName].prompts;

                const newOrderIndices = [...promptListContainer.children].map(item => parseInt(item.dataset.originalIndex));
                const reorderedPrompts = newOrderIndices.map(index => prompts[index]);

                presets[presetName].prompts = reorderedPrompts;
                await savePresets(presets);
                updateFullPresetForm(presetName); // Redraw to update indices
            }
            
            document.getElementById('save-prompt-changes-btn').addEventListener('click', async () => {
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                const index = parseInt(document.getElementById('edit-prompt-index').value);
                const presets = await getPresets();
                if (presets[presetName] && presets[presetName].prompts[index] != null) {
                    const promptData = presets[presetName].prompts[index];
                    promptData.name = document.getElementById('prompt-name-input').value;
                    promptData.injection_position = parseInt(document.getElementById('prompt-position-select').value);
                    promptData.injection_depth = parseInt(document.getElementById('prompt-depth-input').value);
                    promptData.content = document.getElementById('prompt-content-input').value;
                    await savePresets(presets);
                    closeEditPromptModal();
                }
            });

            document.getElementById('delete-prompt-btn').addEventListener('click', async () => {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºè¯æ¡ç›®å—ï¼Ÿ')) return;
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                const index = parseInt(document.getElementById('edit-prompt-index').value);
                const presets = await getPresets();
                if (presets[presetName] && presets[presetName].prompts[index] != null) {
                     presets[presetName].prompts.splice(index, 1);
                     await savePresets(presets);
                     closeEditPromptModal();
                }
            });
            
            addPromptBtn.addEventListener('click', async () => {
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                const presets = await getPresets();
                if (presets[presetName]) {
                    const newPrompt = { name: "æ–°æç¤ºè¯", content: "", enabled: true, role: "system", injection_position: 0, injection_depth: 4, injection_order: 100 };
                    if (!presets[presetName].prompts) presets[presetName].prompts = [];
                    presets[presetName].prompts.push(newPrompt);
                    await savePresets(presets);
                }
            });

            restorePromptsBtn.addEventListener('click', async () => {
                if (!confirm('æ‚¨ç¡®å®šè¦å°†æç¤ºè¯åˆ—è¡¨æ¢å¤ä¸ºé»˜è®¤è®¾ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                const presets = await getPresets();
                if (presets[presetName]) {
                    presets[presetName].prompts = JSON.parse(JSON.stringify(defaultPrompts));
                    await savePresets(presets);
                }
            });

            promptListContainer.addEventListener('change', async (e) => {
                if (e.target.classList.contains('prompt-enabled-toggle')) {
                    const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                    if (!presetName) return;
                    const index = parseInt(e.target.closest('.prompt-entry').dataset.originalIndex);
                    const presets = await getPresets();
                    if (presets[presetName] && presets[presetName].prompts[index] != null) {
                        presets[presetName].prompts[index].enabled = e.target.checked;
                        await savePresets(presets);
                    }
                }
            });
            
            async function getCurrentPresetData() {
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                const presets = await getPresets();
                let existingPrompts = (presets[presetName] && presets[presetName].prompts) ? [...presets[presetName].prompts] : [];

                const data = { prompts: existingPrompts };
                Object.keys(paramInputs).forEach(key => {
                    if (paramInputs[key].number) {
                        data[key] = paramInputs[key].number.type === 'number' ? parseFloat(paramInputs[key].number.value) : paramInputs[key].number.value;
                    }
                });
                return data;
            }

            async function saveCurrentPreset(name) {
                const presets = await getPresets();
                presets[name] = await getCurrentPresetData();
                await savePresets(presets);
                alert(`é¢„è®¾ "${name}" å·²ä¿å­˜!`);
            }

            async function deletePreset(name) {
                if (name === 'é»˜è®¤') { alert('ä¸èƒ½åˆ é™¤é»˜è®¤é¢„è®¾!'); return; }
                if (confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${name}" å—?`)) {
                    const presets = await getPresets();
                    delete presets[name];
                    await savePresets(presets);
                }
            }
            saveAsPresetBtn.addEventListener('click', async () => {
                const newName = prompt("è¾“å…¥æ–°é¢„è®¾çš„åç§°:");
                if (newName && newName.trim() !== '') {
                    const presets = await getPresets();
                    presets[newName.trim()] = await getCurrentPresetData();
                    await savePresets(presets, newName.trim());
                }
            });

            presetImportInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedPreset = JSON.parse(e.target.result);
                        if (typeof importedPreset.temperature === 'undefined' && !importedPreset.prompts) { throw new Error('æ–‡ä»¶ä¼¼ä¹ä¸æ˜¯æœ‰æ•ˆçš„é¢„è®¾æ ¼å¼ã€‚'); }
                        const presetName = file.name.replace(/\.json$/i, '');
                        const presets = await getPresets();
                        presets[presetName] = {
                            temp: importedPreset.temperature ?? 1, top_p: importedPreset.top_p ?? 1,
                            top_k: importedPreset.top_k ?? 50, freq_pen: importedPreset.frequency_penalty ?? 0,
                            pres_pen: importedPreset.presence_penalty ?? 0, rep_pen: importedPreset.repetition_penalty ?? 1.1,
                            max_tokens: importedPreset.openai_max_tokens ?? 1024, context_size: importedPreset.openai_max_context ?? 4096,
                            prompts: importedPreset.prompts || []
                        };
                        await savePresets(presets, presetName);
                        alert(`é¢„è®¾ "${presetName}" å·²æˆåŠŸå¯¼å…¥!`);
                    } catch (err) { alert(`å¯¼å…¥å¤±è´¥: ${err.message}`); console.error("Preset import error:", err); }
                    finally { event.target.value = ''; }
                };
                reader.onerror = () => { alert('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™ã€‚'); event.target.value = ''; };
                reader.readAsText(file);
            });

            presetExportBtn.addEventListener('click', () => {
                const presetName = document.querySelector('.preset-item.active')?.dataset.name;
                if(!presetName) { alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¢„è®¾"); return; }
                const presets = getPresets();
                const data = presets[presetName];
                 const exportData = {
                    temperature: data.temp, top_p: data.top_p, top_k: data.top_k,
                    frequency_penalty: data.freq_pen, presence_penalty: data.pres_pen,
                    repetition_penalty: data.rep_pen, openai_max_tokens: data.max_tokens,
                    openai_max_context: data.context_size, prompts: data.prompts
                };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${presetName}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
            });

            Object.values(paramInputs).forEach(inputs => {
                if (inputs.slider) {
                    inputs.slider.addEventListener('input', () => inputs.number.value = inputs.slider.value);
                    inputs.number.addEventListener('input', () => { if (inputs.slider) inputs.slider.value = inputs.number.value; });
                }
            });
            
            // --- Character Logic ---
            const char = {
                importBtn: document.getElementById('char-import-btn'),
                importFile: document.getElementById('char-import-file'),
                newBtn: document.getElementById('char-new-btn'),
                editor: {
                    panel: document.getElementById('char-editor-panel'),
                    placeholder: document.getElementById('char-editor-placeholder'),
                    content: document.getElementById('char-editor-content'),
                    id: document.getElementById('char-editing-id'),
                    avatarImg: document.getElementById('char-editor-avatar'),
                    avatarUpload: document.getElementById('char-avatar-upload'),
                    name: document.getElementById('char-editor-name'),
                    desc: document.getElementById('char-editor-desc'),
                    firstMes: document.getElementById('char-editor-first-mes'),
                    creatorNotes: document.getElementById('char-editor-creator-notes'),
                    saveBtn: document.getElementById('char-save-btn'),
                    exportBtn: document.getElementById('char-export-btn'),
                    duplicateBtn: document.getElementById('char-duplicate-btn'),
                    deleteBtn: document.getElementById('char-delete-btn'),
                },
                data: {},
                activeCharacterId: null
            };

            async function getCharacters() {
                const data = await idbStorage.getItem('characters_v2');
                return data ? JSON.parse(data) : {};
            }
            async function saveCharacters() {
                try {
                    console.log('[ä¿å­˜è§’è‰²] ä¿å­˜è§’è‰²æ•°æ®:', Object.keys(char.data).length, 'ä¸ªè§’è‰²');
                    const dataStr = JSON.stringify(char.data);
                    console.log('[ä¿å­˜è§’è‰²] æ•°æ®å¤§å°:', (dataStr.length / 1024).toFixed(2), 'KB');

                    await idbStorage.setItem('characters_v2', dataStr);

                    // éªŒè¯ä¿å­˜
                    const saved = await idbStorage.getItem('characters_v2');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        console.log('[ä¿å­˜è§’è‰²] âœ“ éªŒè¯æˆåŠŸ: IndexedDBä¸­æœ‰', Object.keys(parsed).length, 'ä¸ªè§’è‰²');
                    } else {
                        console.error('[ä¿å­˜è§’è‰²] âœ— éªŒè¯å¤±è´¥: IndexedDBä¸­æ²¡æœ‰æ•°æ®!');
                        throw new Error('ä¿å­˜éªŒè¯å¤±è´¥');
                    }

                    triggerAutoSave();
                    return true;
                } catch (e) {
                    console.error('[ä¿å­˜è§’è‰²] âœ— ä¿å­˜å¤±è´¥:', e);
                    if (e.name === 'QuotaExceededError' || e.code === 22) {
                        // è®¡ç®—å½“å‰å­˜å‚¨ä½¿ç”¨æƒ…å†µ
                        let totalSize = 0;
                        const allKeys = await idbStorage.getAllKeys();
                        for (let key of allKeys) {
                            const value = await idbStorage.getItem(key);
                            if (value) {
                                totalSize += value.length + key.length;
                            }
                        }
                        const usedMB = (totalSize / (1024 * 1024)).toFixed(2);

                        const message = `å­˜å‚¨ç©ºé—´å·²æ»¡ï¼\n\nå½“å‰å·²ä½¿ç”¨: ${usedMB} MB\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. å¯¼å‡ºå¹¶åˆ é™¤ä¸éœ€è¦çš„è§’è‰²\n2. å¯¼å‡ºå¹¶æ¸…ç†èŠå¤©è®°å½•\n3. å‹ç¼©è§’è‰²å¤´åƒå›¾ç‰‡\n4. æ¸…ç†æ—§çš„èŠå¤©å†å²è®°å½•\n\næ˜¯å¦è¦æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨è¯¦æƒ…ï¼Ÿ`;

                        if (confirm(message)) {
                            // æ˜¾ç¤ºè¯¦ç»†çš„å­˜å‚¨ä¿¡æ¯
                            let details = 'å­˜å‚¨è¯¦æƒ…ï¼š\n\n';
                            const characterData = await idbStorage.getItem('characters_v2');
                            const characterSize = characterData?.length || 0;
                            details += `è§’è‰²æ•°æ®: ${(characterSize / 1024).toFixed(2)} KB\n`;

                            let chatHistorySize = 0;
                            for (let key of allKeys) {
                                if (key.startsWith('chat_history_')) {
                                    const value = await idbStorage.getItem(key);
                                    if (value) chatHistorySize += value.length;
                                }
                            }
                            details += `èŠå¤©è®°å½•: ${(chatHistorySize / 1024).toFixed(2)} KB\n`;
                            details += `\nè§’è‰²æ•°é‡: ${Object.keys(char.data).length}\n`;
                            alert(details);
                        }
                    } else {
                        alert('ä¿å­˜å¤±è´¥: ' + e.message);
                    }
                    return false;
                }
            }

            function renderCharacterSelect(filterTags = [], nameSearch = '') {
                const charList = document.getElementById('char-list');
                if (!charList) return;

                charList.innerHTML = '';

                // æ”¶é›†æ‰€æœ‰æ ‡ç­¾
                const allTags = new Set();
                Object.values(char.data).forEach(character => {
                    if (character.tags && Array.isArray(character.tags)) {
                        character.tags.forEach(tag => allTags.add(tag));
                    }
                });

                // æ¸²æŸ“æ ‡ç­¾åˆ—è¡¨
                const tagList = document.getElementById('char-tag-list');
                if (tagList) {
                    tagList.innerHTML = '';
                    Array.from(allTags).sort().forEach(tag => {
                        const tagBtn = document.createElement('button');
                        tagBtn.className = `px-3 py-1 rounded-full text-sm transition-all ${
                            filterTags.includes(tag)
                                ? 'bg-primary-color text-white'
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`;
                        tagBtn.textContent = tag;
                        tagBtn.addEventListener('click', () => {
                            const newFilterTags = filterTags.includes(tag)
                                ? filterTags.filter(t => t !== tag)
                                : [...filterTags, tag];
                            renderCharacterSelect(newFilterTags, nameSearch);
                        });
                        tagList.appendChild(tagBtn);
                    });
                }

                const sortedChars = Object.values(char.data).sort((a, b) => (b.fav ? 1 : 0) - (a.fav ? 1 : 0) || a.name.localeCompare(b.name));

                // æ ¹æ®æ ‡ç­¾å’Œåç§°ç­›é€‰è§’è‰²
                let filteredChars = sortedChars;

                // æ ‡ç­¾ç­›é€‰
                if (filterTags.length > 0) {
                    filteredChars = filteredChars.filter(character => {
                        if (!character.tags || !Array.isArray(character.tags)) return false;
                        return filterTags.every(tag => character.tags.includes(tag));
                    });
                }

                // åç§°æœç´¢
                if (nameSearch.trim()) {
                    const searchLower = nameSearch.toLowerCase().trim();
                    filteredChars = filteredChars.filter(character => {
                        const name = (character.name || '').toLowerCase();
                        const desc = (character.description || '').toLowerCase();
                        return name.includes(searchLower) || desc.includes(searchLower);
                    });
                }

                if (filteredChars.length === 0) {
                    charList.innerHTML = '<div class="text-center text-gray-500 py-8">æ²¡æœ‰åŒ¹é…çš„è§’è‰²</div>';
                    return;
                }

                filteredChars.forEach(character => {
                    const item = document.createElement('div');
                    item.className = 'char-item p-3 rounded-lg cursor-pointer border-2 transition-all';
                    item.dataset.charId = character.id;

                    if (character.id === char.activeCharacterId) {
                        item.className += ' border-primary-color bg-primary-color bg-opacity-10';
                    } else {
                        item.className += ' border-gray-200 hover:border-primary-color hover:bg-gray-50';
                    }

                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${character.avatar && character.avatar !== 'none' ? character.avatar : 'https://placehold.co/48x48/5E5B9D/ffffff?text=AI'}"
                                 class="w-12 h-12 rounded-full object-cover border-2 ${character.id === char.activeCharacterId ? 'border-primary-color' : 'border-gray-300'}">
                            <div class="flex-1">
                                <p class="font-bold text-base">${(character.fav ? 'â˜… ' : '') + (character.name || 'æ— åè§’è‰²')}</p>
                                <p class="text-xs text-gray-500 truncate">${character.description ? character.description.substring(0, 50) + '...' : 'æš‚æ— æè¿°'}</p>
                            </div>
                            ${character.id === char.activeCharacterId ? '<i class="fas fa-check-circle text-primary-color text-xl"></i>' : ''}
                        </div>
                    `;

                    item.addEventListener('click', () => {
                        selectCharacter(character.id);
                        closeCharacterSelector();
                    });
                    charList.appendChild(item);
                });
            }

            function openCharacterSelector() {
                const modal = document.getElementById('char-selector-modal');
                if (modal) {
                    renderCharacterSelect();
                    modal.classList.add('active');
                }
            }

            function closeCharacterSelector() {
                const modal = document.getElementById('char-selector-modal');
                if (modal) {
                    modal.classList.remove('active');
                }
            }

            function updateCharPreviewCard() {
                const character = char.data[char.activeCharacterId];
                const avatarEl = document.getElementById('current-char-avatar-preview');
                const nameEl = document.getElementById('current-char-name-preview');

                if (character) {
                    if (avatarEl) avatarEl.src = (character.avatar && character.avatar !== 'none') ? character.avatar : 'https://placehold.co/48x48/5E5B9D/ffffff?text=AI';
                    if (nameEl) nameEl.textContent = character.name || 'æ— åè§’è‰²';
                } else {
                    if (avatarEl) avatarEl.src = 'https://placehold.co/48x48/5E5B9D/ffffff?text=AI';
                    if (nameEl) nameEl.textContent = 'æœªé€‰æ‹©è§’è‰²';
                }
            }

            async function selectCharacter(id) {
                // ä¿å­˜å½“å‰è§’è‰²çš„èŠå¤©è®°å½•
                if (char.activeCharacterId && chatHistory.length > 0) {
                    await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                    triggerAutoSave();
                }

                if (!char.data[id]) {
                    hideCharacterEditor();
                    char.activeCharacterId = null;
                    await idbStorage.removeItem('active_character_v2');
                    updateCharPreviewCard();
                    document.getElementById('char-name-header').textContent = 'No Character Loaded';
                    document.getElementById('char-avatar-header').src = 'https://placehold.co/40x40/5E5B9D/ffffff?text=AI';
                    await loadWiData(null);
                    await loadRegexData([], false);
                    startNewChat();
                    return;
                }
                char.activeCharacterId = id;
                await idbStorage.setItem('active_character_v2', id);

                const character = char.data[id];
                document.getElementById('char-name-header').textContent = character.name;
                const avatarHeader = document.getElementById('char-avatar-header');
                avatarHeader.src = (character.avatar && character.avatar !== 'none') ? character.avatar : 'https://placehold.co/40x40/5E5B9D/ffffff?text=AI';

                populateCharacterEditor(character);
                updateCharPreviewCard();

                // Reload other modals with character-specific data
                await loadWiData(character.data?.character_book);
                await loadRegexData(character.data?.regex, character.data?.regex_enabled);

                // å°è¯•åŠ è½½è¯¥è§’è‰²çš„èŠå¤©è®°å½•
                await loadChatHistory(id);
            }
            
            function showCharacterEditor(character) {
                char.editor.id.value = character.id;
                char.editor.avatarImg.src = character.avatar || 'https://placehold.co/128x128/5E5B9D/ffffff?text=AI';
                char.editor.name.value = character.name || '';
                char.editor.desc.value = character.description || (character.data?.description || '');
                char.editor.firstMes.value = character.first_mes || (character.data?.first_mes || '');
                char.editor.creatorNotes.value = character.creatorcomment || (character.data?.creator_notes || '');

                // æ˜¾ç¤ºæ ‡ç­¾
                const tags = character.tags || character.data?.tags || [];
                document.getElementById('char-editor-tags').value = tags.join(', ');

                char.editor.placeholder.classList.add('hidden');
                char.editor.content.classList.remove('hidden');
                char.editor.content.classList.add('flex');
            }
            function hideCharacterEditor() {
                char.editor.id.value = '';
                char.editor.placeholder.classList.remove('hidden');
                char.editor.content.classList.add('hidden');
                char.editor.content.classList.remove('flex');
            }

            function populateCharacterEditor(character) {
                showCharacterEditor(character);
                renderAlternateGreetings(character);
            }

            // æ¸²æŸ“å¤‡é€‰å¼€åœºç™½åˆ—è¡¨
            function renderAlternateGreetings(character) {
                const list = document.getElementById('alternate-greetings-list');
                list.innerHTML = '';

                const greetings = character.data?.alternate_greetings || [];

                if (greetings.length === 0) {
                    list.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">æš‚æ— å¤‡é€‰å¼€åœºç™½</p>';
                    return;
                }

                greetings.forEach((greeting, index) => {
                    const item = document.createElement('div');
                    item.className = 'p-3 border border-gray-200 rounded-lg hover:bg-gray-50 flex items-start gap-2';

                    const badge = document.createElement('div');
                    badge.className = 'flex-shrink-0 w-6 h-6 bg-primary-color text-white rounded-full flex items-center justify-center text-xs font-bold';
                    badge.textContent = index + 1;

                    const content = document.createElement('div');
                    content.className = 'flex-1 min-w-0';
                    const preview = greeting.length > 100 ? greeting.substring(0, 100) + '...' : greeting;
                    const textNode = document.createElement('p');
                    textNode.className = 'text-sm text-gray-700 break-words';
                    textNode.textContent = preview;
                    content.appendChild(textNode);

                    const actions = document.createElement('div');
                    actions.className = 'flex-shrink-0 flex gap-1';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'text-primary-color hover:text-primary-hover-color p-1';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = 'ç¼–è¾‘';
                    editBtn.onclick = () => openGreetingEditModal(index, greeting);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-500 hover:text-red-700 p-1';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.title = 'åˆ é™¤';
                    deleteBtn.onclick = () => deleteGreeting(index);

                    actions.appendChild(editBtn);
                    actions.appendChild(deleteBtn);

                    item.appendChild(badge);
                    item.appendChild(content);
                    item.appendChild(actions);
                    list.appendChild(item);
                });

                // ä½¿åˆ—è¡¨å¯æ‹–åŠ¨æ’åº
                new Sortable(list, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: onGreetingSort
                });
            }

            // æ‰“å¼€å¼€åœºç™½ç¼–è¾‘å¼¹çª—
            function openGreetingEditModal(index, content) {
                const modal = document.getElementById('greeting-edit-modal');
                const textarea = document.getElementById('greeting-edit-textarea');
                const indexInput = document.getElementById('greeting-edit-index');

                indexInput.value = index;
                textarea.value = content || '';
                modal.style.display = 'flex';
            }

            // æ·»åŠ æ–°å¼€åœºç™½
            document.getElementById('add-greeting-btn').addEventListener('click', () => {
                const id = char.editor.id.value;
                if (!char.data[id]) return;

                const character = char.data[id];
                if (!character.data) character.data = {};
                if (!character.data.alternate_greetings) character.data.alternate_greetings = [];

                character.data.alternate_greetings.push('');
                renderAlternateGreetings(character);
                openGreetingEditModal(character.data.alternate_greetings.length - 1, '');
            });

            // ä¿å­˜å¼€åœºç™½ç¼–è¾‘
            document.getElementById('save-greeting-edit-btn').addEventListener('click', async () => {
                const id = char.editor.id.value;
                if (!char.data[id]) return;

                const character = char.data[id];
                const index = parseInt(document.getElementById('greeting-edit-index').value);
                const content = document.getElementById('greeting-edit-textarea').value;

                if (!character.data) character.data = {};
                if (!character.data.alternate_greetings) character.data.alternate_greetings = [];

                character.data.alternate_greetings[index] = content;

                await saveCharacters();
                renderAlternateGreetings(character);

                // å…³é—­å¼¹çª—
                document.getElementById('greeting-edit-modal').style.display = 'none';
            });

            // åˆ é™¤å¼€åœºç™½
            async function deleteGreeting(index) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¼€åœºç™½å—ï¼Ÿ')) return;

                const id = char.editor.id.value;
                if (!char.data[id]) return;

                const character = char.data[id];
                if (!character.data?.alternate_greetings) return;

                character.data.alternate_greetings.splice(index, 1);

                await saveCharacters();
                renderAlternateGreetings(character);
            }

            // å¼€åœºç™½æ’åº
            async function onGreetingSort(evt) {
                const id = char.editor.id.value;
                if (!char.data[id]) return;

                const character = char.data[id];
                if (!character.data?.alternate_greetings) return;

                const list = document.getElementById('alternate-greetings-list');
                const newOrder = [];

                Array.from(list.children).forEach(item => {
                    const index = Array.from(list.children).indexOf(item);
                    const badge = item.querySelector('.bg-primary-color');
                    if (badge) {
                        const originalIndex = parseInt(badge.textContent) - 1;
                        if (character.data.alternate_greetings[originalIndex]) {
                            newOrder.push(character.data.alternate_greetings[originalIndex]);
                        }
                    }
                });

                character.data.alternate_greetings = newOrder;
                await saveCharacters();
                renderAlternateGreetings(character);
            }
            
            async function saveCharacterFromEditor() {
                const id = char.editor.id.value;
                if (!char.data[id]) return;
                const character = char.data[id];

                character.name = char.editor.name.value;
                character.description = char.editor.desc.value;
                character.first_mes = char.editor.firstMes.value;
                character.creatorcomment = char.editor.creatorNotes.value;

                if (!character.data) character.data = {};
                character.data.name = character.name;
                character.data.description = character.description;
                character.data.first_mes = character.first_mes;
                character.data.creator_notes = character.creatorcomment;

                // ä¿å­˜æ ‡ç­¾
                const tagsInput = document.getElementById('char-editor-tags').value;
                const tagsArray = tagsInput.split(',').map(t => t.trim()).filter(t => t);
                character.data.tags = tagsArray;
                character.tags = tagsArray; // åŒæ—¶ä¿å­˜åˆ°é¡¶å±‚

                // **FIX**: Save character-specific world book if it was being edited
                if (wi.charBook && wi.worldSelect.value === 'char_book') {
                    character.data.character_book = wi.charBook;
                }

                await saveCharacters();
                renderCharacterSelect();
                updateCharPreviewCard();
                if (id === char.activeCharacterId) {
                    // Update header
                    document.getElementById('char-name-header').textContent = character.name;
                    const avatarHeader = document.getElementById('char-avatar-header');
                    avatarHeader.src = (character.avatar && character.avatar !== 'none') ? character.avatar : 'https://placehold.co/40x40/5E5B9D/ffffff?text=AI';
                }
                alert(`è§’è‰² "${character.name}" å·²ä¿å­˜!`);
            }

            function processAndAddCharacter(charData, pngFile = null) {
                console.log('[å¯¼å…¥è§’è‰²] å¼€å§‹å¤„ç†è§’è‰²æ•°æ®:', charData.name || charData.data?.name);

                const newChar = {
                    id: `char_${Date.now()}`,
                    fav: false,
                    avatar: charData.avatar || 'none',
                    name: charData.name || charData.data?.name || 'æœªå‘½åè§’è‰²',
                    description: charData.description || charData.data?.description || '',
                    first_mes: charData.first_mes || charData.data?.first_mes || '',
                    creatorcomment: charData.creatorcomment || charData.data?.creator_notes || '',
                    tags: charData.tags || charData.data?.tags || [], // å¤„ç†tagså­—æ®µ
                    data: {
                        character_book: null,
                        regex: [],
                        regex_enabled: false,
                        tags: charData.tags || charData.data?.tags || [] // åŒæ—¶ä¿å­˜åˆ°dataä¸­
                    },
                };

                // å¤„ç†å®Œæ•´çš„ data å¯¹è±¡
                if (charData.data) {
                    newChar.data = {
                        ...charData.data,
                        character_book: charData.data.character_book || null,
                        regex: charData.data.regex || [],
                        regex_enabled: charData.data.regex_enabled || false,
                        tags: charData.data.tags || charData.tags || [] // ç¡®ä¿tagsè¢«ä¿å­˜
                    };
                    // æ›´æ–°é¡¶å±‚çš„tags
                    if (charData.data.tags || charData.tags) {
                        newChar.tags = charData.data.tags || charData.tags || [];
                    }
                }

                // å¤„ç† V3 å¡ç‰‡æ ¼å¼çš„æ­£åˆ™
                if (charData.data?.extensions?.regex_scripts) {
                    newChar.data.regex = charData.data.extensions.regex_scripts;
                    newChar.data.regex_enabled = true;
                }

                // å¤„ç† V3 å¡ç‰‡æ ¼å¼çš„ä¸–ç•Œä¹¦
                if (charData.data?.character_book) {
                    newChar.data.character_book = charData.data.character_book;
                }

                if (newChar.avatar === 'none' && pngFile) {
                    // å°†å›¾ç‰‡è½¬æ¢ä¸ºbase64ä»¥ä¾¿æŒä¹…åŒ–
                    console.log('[å¯¼å…¥è§’è‰²] æ­£åœ¨è¯»å–PNGå¤´åƒ...');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            newChar.avatar = e.target.result;
                            console.log('[å¯¼å…¥è§’è‰²] å¤´åƒè¯»å–å®Œæˆï¼Œå‡†å¤‡ä¿å­˜è§’è‰²:', newChar.name);
                            char.data[newChar.id] = newChar;
                            console.log('[å¯¼å…¥è§’è‰²] æ·»åŠ åˆ°char.dataåï¼Œæ€»è§’è‰²æ•°:', Object.keys(char.data).length);

                            const success = saveCharacters();
                            if (success) {
                                renderCharacterSelect();
                                selectCharacter(newChar.id);
                                alert(`è§’è‰² "${newChar.name}" å¯¼å…¥æˆåŠŸï¼`);
                            } else {
                                // ä¿å­˜å¤±è´¥ï¼Œå›æ»š
                                delete char.data[newChar.id];
                                console.error('[å¯¼å…¥è§’è‰²] âœ— ä¿å­˜å¤±è´¥ï¼Œå·²å›æ»š');
                            }
                        } catch (error) {
                            console.error('[å¯¼å…¥è§’è‰²] ä¿å­˜è¿‡ç¨‹å‡ºé”™:', error);
                            delete char.data[newChar.id];
                            alert(`è§’è‰²ä¿å­˜å¤±è´¥: ${error.message}`);
                        }
                    };
                    reader.onerror = function(error) {
                        console.error('[å¯¼å…¥è§’è‰²] å¤´åƒè¯»å–å¤±è´¥:', error);
                        // å³ä½¿å¤´åƒè¯»å–å¤±è´¥ï¼Œä¹Ÿå°è¯•ä¿å­˜è§’è‰²ï¼ˆä¸å«å¤´åƒï¼‰
                        char.data[newChar.id] = newChar;
                        const success = saveCharacters();
                        if (success) {
                            renderCharacterSelect();
                            selectCharacter(newChar.id);
                            alert(`è§’è‰² "${newChar.name}" å·²å¯¼å…¥ï¼ˆå¤´åƒè¯»å–å¤±è´¥ï¼‰`);
                        } else {
                            delete char.data[newChar.id];
                            alert(`è§’è‰²ä¿å­˜å¤±è´¥`);
                        }
                    };
                    reader.readAsDataURL(pngFile);
                    return; // ç­‰å¾…å¼‚æ­¥è¯»å–å®Œæˆ
                }

                console.log('[å¯¼å…¥è§’è‰²] å‡†å¤‡ä¿å­˜è§’è‰²ï¼ˆæ— PNGï¼‰:', newChar.name);
                char.data[newChar.id] = newChar;
                console.log('[å¯¼å…¥è§’è‰²] æ·»åŠ åˆ°char.dataåï¼Œæ€»è§’è‰²æ•°:', Object.keys(char.data).length);

                const success = saveCharacters();
                if (success) {
                    renderCharacterSelect();
                    selectCharacter(newChar.id);
                    alert(`è§’è‰² "${newChar.name}" å¯¼å…¥æˆåŠŸï¼`);
                } else {
                    // ä¿å­˜å¤±è´¥ï¼Œå›æ»š
                    delete char.data[newChar.id];
                    console.error('[å¯¼å…¥è§’è‰²] âœ— ä¿å­˜å¤±è´¥ï¼Œå·²å›æ»š');
                }
            }

            // æ–‡æœ¬ç¼–è¾‘å¼¹çª—ç›¸å…³å‡½æ•°
            window.openTextEditModal = function(fieldName, title) {
                const modal = document.getElementById('text-edit-modal');
                const titleEl = document.getElementById('text-edit-modal-title');
                const fieldNameEl = document.getElementById('text-edit-field-name');
                const textarea = document.getElementById('text-edit-textarea');

                let fieldMap = {
                    'desc': char.editor.desc,
                    'firstMes': char.editor.firstMes,
                    'creatorNotes': char.editor.creatorNotes
                };

                const targetField = fieldMap[fieldName];
                if (!targetField) return;

                titleEl.textContent = title;
                fieldNameEl.value = fieldName;
                textarea.value = targetField.value;

                modal.classList.add('active');
            };

            // ç”¨æˆ·æ–‡æœ¬ç¼–è¾‘å¼¹çª—
            window.openUserTextEditModal = function(fieldName, title) {
                const modal = document.getElementById('text-edit-modal');
                const titleEl = document.getElementById('text-edit-modal-title');
                const fieldNameEl = document.getElementById('text-edit-field-name');
                const textarea = document.getElementById('text-edit-textarea');

                let fieldMap = {
                    'description': document.getElementById('user-editor-description'),
                    'systemPrompt': document.getElementById('user-editor-system-prompt')
                };

                const targetField = fieldMap[fieldName];
                if (!targetField) return;

                titleEl.textContent = title;
                fieldNameEl.value = 'user_' + fieldName;
                textarea.value = targetField.value;

                modal.classList.add('active');
            };

            function closeTextEditModal() {
                document.getElementById('text-edit-modal').classList.remove('active');
            }

            document.getElementById('save-text-edit-btn').addEventListener('click', () => {
                const fieldName = document.getElementById('text-edit-field-name').value;
                const textarea = document.getElementById('text-edit-textarea');

                // è§’è‰²ç¼–è¾‘å­—æ®µ
                let fieldMap = {
                    'desc': char.editor.desc,
                    'firstMes': char.editor.firstMes,
                    'creatorNotes': char.editor.creatorNotes
                };

                // ç”¨æˆ·ç¼–è¾‘å­—æ®µ
                let userFieldMap = {
                    'user_description': document.getElementById('user-editor-description'),
                    'user_systemPrompt': document.getElementById('user-editor-system-prompt')
                };

                const targetField = fieldMap[fieldName] || userFieldMap[fieldName];
                if (targetField) {
                    targetField.value = textarea.value;
                }

                closeTextEditModal();
            });

            document.querySelectorAll('#text-edit-modal .close-sub-modal-btn').forEach(btn => {
                btn.addEventListener('click', closeTextEditModal);
            });

            document.getElementById('text-edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'text-edit-modal') {
                    closeTextEditModal();
                }
            });

            char.importBtn.addEventListener('click', () => char.importFile.click());
            char.importFile.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    if (file.name.toLowerCase().endsWith('.json')) {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        processAndAddCharacter(data);
                    } else if (file.name.toLowerCase().endsWith('.png')) {
                        const { charData } = await extractPNGChunk(file);
                        processAndAddCharacter(charData, file);
                    } else {
                        throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·é€‰æ‹© .json æˆ– .png æ–‡ä»¶ã€‚');
                    }
                } catch(e) {
                    alert(`å¯¼å…¥å¤±è´¥: ${e.message}`);
                    console.error("Character import error:", e);
                } finally {
                    event.target.value = ''; // Reset file input
                }
            });

            char.newBtn.addEventListener('click', () => {
                const newChar = {
                    id: `char_${Date.now()}`,
                    fav: false,
                    name: "æ–°è§’è‰²",
                    description: "",
                    first_mes: "ä½ å¥½ï¼",
                    creatorcomment: "",
                    data: {
                        character_book: null,
                        regex: [],
                        regex_enabled: false
                    }
                };
                char.data[newChar.id] = newChar;
                saveCharacters();
                renderCharacterSelect();
                selectCharacter(newChar.id);
            });
            
            char.editor.saveBtn.addEventListener('click', saveCharacterFromEditor);

            char.editor.deleteBtn.addEventListener('click', () => {
                const id = char.editor.id.value;
                if (!char.data[id]) return;
                if (confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰² "${char.data[id].name}" å—?`)) {
                    delete char.data[id];
                    saveCharacters();
                    renderCharacterSelect();
                    const firstCharId = Object.keys(char.data)[0] || null;
                    selectCharacter(firstCharId);
                }
            });

            char.editor.duplicateBtn.addEventListener('click', () => {
                const id = char.editor.id.value;
                if (!char.data[id]) return;
                const originalChar = char.data[id];
                const newChar = JSON.parse(JSON.stringify(originalChar));
                newChar.id = `char_${Date.now()}`;
                newChar.name = `${originalChar.name} (å¤åˆ¶)`;
                char.data[newChar.id] = newChar;
                saveCharacters();
                renderCharacterSelect();
                selectCharacter(newChar.id);
            });
            
            char.editor.exportBtn.addEventListener('click', () => {
                const id = char.editor.id.value;
                if (!char.data[id]) return;
                const character = char.data[id];
                const exportData = {
                    spec: 'chara_card_v2',
                    spec_version: '2.0',
                    data: {
                        name: character.name,
                        description: character.description,
                        personality: "",
                        scenario: "",
                        first_mes: character.first_mes,
                        mes_example: "",
                        creator_notes: character.creatorcomment,
                        system_prompt: "",
                        post_history_instructions: "",
                        tags: [],
                        creator: "",
                        character_version: "1.0",
                        alternate_greetings: [],
                        // **FIX**: Ensure local regex and char book are included in export
                        character_book: character.data.character_book,
                        regex: character.data.regex,
                        regex_enabled: character.data.regex_enabled,
                    }
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${character.name}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
            });

            if (char.editor.avatarUpload) {
                char.editor.avatarUpload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    const id = char.editor.id.value;
                    if (file && char.data[id]) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const imageUrl = event.target.result;
                            char.data[id].avatar = imageUrl;
                            char.editor.avatarImg.src = imageUrl;
                            // æ›´æ–°é¢„è§ˆå¡ç‰‡å’Œåˆ—è¡¨
                            renderCharacterSelect();
                            updateCharPreviewCard();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // è§’è‰²é€‰æ‹©å¼¹çª—äº‹ä»¶ç»‘å®š
            const openCharSelectorBtn = document.getElementById('open-char-selector-btn');
            const charPreviewCard = document.getElementById('char-preview-card');

            if (openCharSelectorBtn) {
                openCharSelectorBtn.addEventListener('click', () => openCharacterSelector());
            }

            if (charPreviewCard) {
                charPreviewCard.addEventListener('click', () => openCharacterSelector());
            }

            // å…³é—­è§’è‰²é€‰æ‹©å™¨
            const closeCharSelectorBtns = document.querySelectorAll('.close-char-selector-btn');
            closeCharSelectorBtns.forEach(btn => {
                btn.addEventListener('click', () => closeCharacterSelector());
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            const charSelectorModal = document.getElementById('char-selector-modal');
            if (charSelectorModal) {
                charSelectorModal.addEventListener('click', (e) => {
                    if (e.target === charSelectorModal) {
                        closeCharacterSelector();
                    }
                });
            }

            // æ ‡ç­¾ç­›é€‰è¾“å…¥æ¡†
            const charTagFilter = document.getElementById('char-tag-filter');
            if (charTagFilter) {
                charTagFilter.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const tagButtons = document.querySelectorAll('#char-tag-list button');

                    if (!searchTerm) {
                        // æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
                        tagButtons.forEach(btn => btn.style.display = '');
                    } else {
                        // ç­›é€‰æ ‡ç­¾
                        tagButtons.forEach(btn => {
                            const tagName = btn.textContent.toLowerCase();
                            btn.style.display = tagName.includes(searchTerm) ? '' : 'none';
                        });
                    }
                });
            }

            // è§’è‰²åç§°æœç´¢
            const charNameSearch = document.getElementById('char-name-search');
            if (charNameSearch) {
                charNameSearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value;
                    // è·å–å½“å‰é€‰ä¸­çš„æ ‡ç­¾
                    const selectedTags = Array.from(document.querySelectorAll('#char-tag-list button.bg-primary-color'))
                        .map(btn => btn.textContent);
                    renderCharacterSelect(selectedTags, searchTerm);
                });
            }

            // å…³é—­å¼€åœºç™½é€‰æ‹©å™¨
            const closeGreetingSelectorBtns = document.querySelectorAll('.close-greeting-selector-btn');
            closeGreetingSelectorBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('greeting-selector-modal').style.display = 'none';
                });
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼€åœºç™½é€‰æ‹©å™¨
            const greetingSelectorModal = document.getElementById('greeting-selector-modal');
            if (greetingSelectorModal) {
                greetingSelectorModal.addEventListener('click', (e) => {
                    if (e.target === greetingSelectorModal) {
                        greetingSelectorModal.style.display = 'none';
                    }
                });
            }

            // é‡æ–°é€‰æ‹©å¼€åœºç™½æŒ‰é’®
            const reselectGreetingBtn = document.getElementById('reselect-greeting-btn');
            if (reselectGreetingBtn) {
                reselectGreetingBtn.addEventListener('click', () => {
                    const activeChar = char.data[char.activeCharacterId];
                    if (!activeChar || !activeChar.first_mes) {
                        alert('å½“å‰æ²¡æœ‰å¯ç”¨çš„è§’è‰²æˆ–å¼€åœºç™½');
                        return;
                    }

                    // æ”¶é›†æ‰€æœ‰å¯ç”¨çš„å¼€åœºç™½
                    const greetings = [activeChar.first_mes];
                    if (activeChar.data && activeChar.data.alternate_greetings) {
                        greetings.push(...activeChar.data.alternate_greetings.filter(g => g && g.trim()));
                    }

                    if (greetings.length === 1) {
                        alert('å½“å‰è§’è‰²åªæœ‰ä¸€æ¡å¼€åœºç™½');
                        return;
                    }

                    // æ˜¾ç¤ºå¼€åœºç™½é€‰æ‹©å™¨
                    showGreetingSelector(greetings);
                });
            }

            async function loadCharacters() {
                char.data = await getCharacters();
                console.log('[åŠ è½½è§’è‰²] ä»IndexedDBåŠ è½½äº†', Object.keys(char.data).length, 'ä¸ªè§’è‰²');
                console.log('[åŠ è½½è§’è‰²] è§’è‰²åˆ—è¡¨:', Object.values(char.data).map(c => c.name));

                char.activeCharacterId = await idbStorage.getItem('active_character_v2');
                renderCharacterSelect();
                if (char.activeCharacterId && char.data[char.activeCharacterId]) {
                    await selectCharacter(char.activeCharacterId);
                } else {
                    const firstCharId = Object.keys(char.data)[0];
                    if (firstCharId) {
                       await selectCharacter(firstCharId);
                    } else {
                        await loadWiData(null);
                        await loadRegexData([], false);
                    }
                }
            }


            // --- World Info Logic ---
            const wi = {
                worldSelect: document.getElementById('wi-world-select'),
                newWorldBtn: document.getElementById('wi-new-world-btn'),
                deleteWorldBtn: document.getElementById('wi-delete-world-btn'),
                importWorldBtn: document.getElementById('wi-import-world-btn'),
                importFileInput: document.getElementById('wi-import-file'),
                exportWorldBtn: document.getElementById('wi-export-world-btn'),
                newEntryBtn: document.getElementById('wi-new-entry-btn'),
                entryList: document.getElementById('wi-entry-list'),
                editor: {
                    panel: document.getElementById('wi-editor-panel'),
                    placeholder: document.getElementById('wi-editor-placeholder'),
                    content: document.getElementById('wi-editor-content'),
                    id: document.getElementById('wi-editing-entry-id'),
                    enabled: document.getElementById('wi-entry-enabled'),
                    name: document.getElementById('wi-entry-name'),
                    keys: document.getElementById('wi-entry-keys'),
                    entryContent: document.getElementById('wi-entry-content'),
                    cloneBtn: document.getElementById('wi-clone-entry-btn'),
                    deleteBtn: document.getElementById('wi-delete-entry-btn'),
                },
                data: {},
                charBook: null
            };

            async function getWiData() {
                const data = await idbStorage.getItem('world_info_v3');
                return data ? JSON.parse(data) : {};
            }
            async function saveWiData(data) {
                await idbStorage.setItem('world_info_v3', JSON.stringify(data));
                triggerAutoSave();
            }
            
            async function loadWiData(characterBook = null) {
                wi.data = await getWiData();
                wi.charBook = characterBook;
                if (Object.keys(wi.data).length === 0) {
                    wi.data = { "é»˜è®¤ä¸–ç•Œ": [] };
                    await saveWiData(wi.data);
                }
                renderWorlds();
                const lastSelected = await idbStorage.getItem('wi_last_selected_world') || Object.keys(wi.data)[0];
                
                const selectExists = [...wi.worldSelect.options].some(opt => opt.value === lastSelected);
                if (selectExists) {
                    wi.worldSelect.value = lastSelected;
                } else if(wi.worldSelect.options.length > 0) {
                    wi.worldSelect.selectedIndex = 0;
                }
                renderEntries(wi.worldSelect.value);
            }

            function renderWorlds() {
                const currentVal = wi.worldSelect.value;
                wi.worldSelect.innerHTML = '';

                if (wi.charBook && wi.charBook.entries?.length > 0) {
                     const charOptGroup = document.createElement('optgroup');
                     charOptGroup.label = "è§’è‰²ä¸–ç•Œä¹¦";
                     const option = document.createElement('option');
                     option.value = `char_book`;
                     option.textContent = wi.charBook.name || "Character Book";
                     charOptGroup.appendChild(option);
                     wi.worldSelect.appendChild(charOptGroup);
                }

                const globalOptGroup = document.createElement('optgroup');
                globalOptGroup.label = "å…¨å±€ä¸–ç•Œä¹¦";
                const worldNames = Object.keys(wi.data);

                if (worldNames.length > 0) {
                    worldNames.forEach(worldName => {
                        const option = document.createElement('option');
                        option.value = worldName;
                        option.textContent = worldName;
                        globalOptGroup.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "æ— å…¨å±€ä¸–ç•Œ";
                    option.disabled = true;
                    globalOptGroup.appendChild(option);
                }
                wi.worldSelect.appendChild(globalOptGroup);

                if([...wi.worldSelect.options].some(opt => opt.value === currentVal)) {
                    wi.worldSelect.value = currentVal;
                }
            }

            function renderEntries(worldName) {
                wi.entryList.innerHTML = '';
                hideWiEditor();
                
                let entries = [];
                if (worldName === 'char_book' && wi.charBook) {
                    entries = wi.charBook.entries.map((entry, index) => ({...entry, id: `char_entry_${entry.id || index}`}));
                } else if (wi.data[worldName]) {
                    entries = wi.data[worldName];
                }

                if (!entries || entries.length === 0) return;

                entries.forEach(entry => {
                    const item = document.createElement('div');
                    item.className = 'wi-entry-item p-2.5 rounded-lg cursor-pointer hover:bg-gray-100 border border-gray-200 transition-colors';
                    item.dataset.id = entry.id;
                    item.innerHTML = `
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium truncate text-sm leading-tight">${entry.name || entry.comment || 'æ— æ ‡é¢˜æ¡ç›®'}</div>
                                <p class="text-xs text-gray-500 mt-0.5 truncate leading-tight">${(Array.isArray(entry.keys) ? entry.keys.join(', ') : entry.keys) || 'æ— å…³é”®å­—'}</p>
                            </div>
                            <input type="checkbox" ${entry.enabled ? 'checked' : ''} class="wi-entry-enable-toggle accent-primary-color w-4 h-4 flex-shrink-0 mt-0.5" data-id="${entry.id}" title="${entry.enabled ? 'ç‚¹å‡»ç¦ç”¨' : 'ç‚¹å‡»å¯ç”¨'}">
                        </div>`;
                    item.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                           selectEntry(worldName, entry.id);
                        }
                    });
                    wi.entryList.appendChild(item);
                });
            }

            function selectEntry(worldName, entryId) {
                let entries = [];
                if (worldName === 'char_book' && wi.charBook) {
                    entries = wi.charBook.entries.map((entry, index) => ({...entry, id: `char_entry_${entry.id || index}`}));
                } else if (wi.data[worldName]) {
                    entries = wi.data[worldName];
                }
                const entry = entries?.find(e => e.id === entryId);
                if (!entry) { hideWiEditor(); return; }

                document.querySelectorAll('.wi-entry-item').forEach(el => el.classList.remove('active'));
                document.querySelector(`.wi-entry-item[data-id="${entryId}"]`)?.classList.add('active');
                
                showWiEditor(entry);
            }

            function showWiEditor(entry) {
                 wi.editor.id.value = entry.id;
                wi.editor.enabled.checked = entry.enabled;
                wi.editor.name.value = entry.name || entry.comment || '';
                wi.editor.keys.value = Array.isArray(entry.keys) ? entry.keys.join(', ') : (entry.keys || '');
                wi.editor.entryContent.value = entry.content;
                wi.editor.placeholder.classList.add('hidden');
                wi.editor.content.classList.remove('hidden');
                wi.editor.content.classList.add('flex');
            }

            function hideWiEditor() {
                wi.editor.id.value = '';
                wi.editor.placeholder.classList.remove('hidden');
                wi.editor.content.classList.add('hidden');
                wi.editor.content.classList.remove('flex');
                document.querySelectorAll('.wi-entry-item').forEach(el => el.classList.remove('active'));
            }

            function saveCurrentEntry() {
                const worldName = wi.worldSelect.value;
                const entryId = wi.editor.id.value;
                const isCharBook = worldName === 'char_book';

                if (!worldName || !entryId || (isCharBook && !wi.charBook)) return;

                let dataSet = isCharBook ? wi.charBook.entries : wi.data[worldName];
                const entryIndex = dataSet.findIndex(e => e.id === entryId || `char_entry_${e.id}` === entryId);
                if (entryIndex === -1) return;

                // æ›´æ–°æ¡ç›®æ•°æ®
                const keysInput = wi.editor.keys.value;
                dataSet[entryIndex] = {
                    ...dataSet[entryIndex],
                    enabled: wi.editor.enabled.checked,
                    name: wi.editor.name.value,
                    comment: wi.editor.name.value, // å…¼å®¹æ€§
                    keys: keysInput.split(',').map(k => k.trim()).filter(k => k), // è½¬ä¸ºæ•°ç»„
                    content: wi.editor.entryContent.value,
                    // ä¿ç•™å…¶ä»–å­—æ®µ
                    case_sensitive: document.getElementById('wi-keys-case-sensitive')?.checked || false,
                    whole_word: document.getElementById('wi-keys-whole-word')?.checked || false,
                    position: parseInt(document.getElementById('wi-entry-position')?.value || '0'),
                    role: parseInt(document.getElementById('wi-entry-role')?.value || '0'),
                    scan_depth: parseInt(document.getElementById('wi-scan-depth')?.value || '50'),
                    use_regex: document.getElementById('wi-use-regex')?.checked || false
                };

                if(isCharBook) {
                    const activeChar = char.data[char.activeCharacterId];
                    if(activeChar) {
                        activeChar.data.character_book = wi.charBook;
                        saveCharacters();
                    }
                } else {
                    saveWiData(wi.data);
                }

                // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤º
                renderEntries(worldName);
                console.log('[ä¸–ç•Œä¹¦] æ¡ç›®å·²ä¿å­˜:', dataSet[entryIndex]);
            }
            
            wi.worldSelect.addEventListener('change', async (e) => {
                const isCharBook = e.target.value === 'char_book';
                const isGlobal = !isCharBook && e.target.value;

                wi.newWorldBtn.disabled = isCharBook;
                wi.importWorldBtn.disabled = isCharBook;
                wi.deleteWorldBtn.disabled = isCharBook || !isGlobal;
                wi.exportWorldBtn.disabled = isCharBook || !isGlobal;
                wi.newEntryBtn.disabled = !e.target.value;

                if (!isCharBook) {
                    await idbStorage.setItem('wi_last_selected_world', e.target.value);
                }
                renderEntries(e.target.value);
            });
            
            wi.newWorldBtn.addEventListener('click', async () => {
                const worldName = prompt("è¾“å…¥æ–°ä¸–ç•Œçš„åç§°:");
                if (worldName && worldName.trim() !== '') {
                    if (wi.data[worldName]) {
                        alert("è¯¥åç§°çš„ä¸–ç•Œå·²å­˜åœ¨ã€‚");
                        return;
                    }
                    wi.data[worldName] = [];
                    await saveWiData(wi.data);
                    await loadWiData(wi.charBook);
                    wi.worldSelect.value = worldName;
                    renderEntries(worldName);
                }
            });

            wi.deleteWorldBtn.addEventListener('click', async () => {
                const worldName = wi.worldSelect.value;
                if (!worldName || worldName === 'char_book' || !wi.data[worldName]) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„å…¨å±€ä¸–ç•Œè¿›è¡Œåˆ é™¤ã€‚');
                    return;
                }

                if (confirm(`ç¡®å®šè¦åˆ é™¤ä¸–ç•Œ "${worldName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                    delete wi.data[worldName];
                    await idbStorage.removeItem('wi_last_selected_world');
                    await saveWiData(wi.data);
                    await loadWiData(wi.charBook);
                }
            });

            wi.importWorldBtn.addEventListener('click', () => wi.importFileInput.click());
            wi.importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        let newEntries;
                        if (importedData.entries && typeof importedData.entries === 'object') {
                             newEntries = Object.values(importedData.entries).map((entry, idx) => ({
                                id: `wi_${Date.now()}_${entry.uid || idx}`,
                                name: entry.comment || 'æ— æ ‡é¢˜',
                                keys: (entry.key || []).join(', '),
                                content: entry.content || '',
                                enabled: !entry.disable,
                            }));
                        } else if (Array.isArray(importedData)) {
                            newEntries = importedData;
                        } else {
                             throw new Error('æ— æ•ˆçš„ä¸–ç•Œä¹¦æ–‡ä»¶æ ¼å¼ã€‚');
                        }

                        const proposedName = file.name.replace(/\.json$/i, '');
                        const worldName = prompt("ä¸ºå¯¼å…¥çš„ä¸–ç•Œä¹¦è¾“å…¥åç§°:", proposedName);

                        if (!worldName) return;
                        if (wi.data[worldName]) {
                            alert(`é”™è¯¯: åä¸º "${worldName}" çš„ä¸–ç•Œå·²å­˜åœ¨ã€‚`);
                            return;
                        }

                        wi.data[worldName] = newEntries;
                        await saveWiData(wi.data);
                        await loadWiData(wi.charBook);
                        wi.worldSelect.value = worldName;
                        renderEntries(worldName);
                        alert(`æˆåŠŸå¯¼å…¥ "${worldName}"!`);

                    } catch (err) { alert(`å¯¼å…¥å¤±è´¥: ${err.message}`); }
                    finally { event.target.value = ''; }
                };
                reader.readAsText(file);
            });

            // æ–°å»ºæ¡ç›®
            wi.newEntryBtn.addEventListener('click', () => {
                const worldName = wi.worldSelect.value;
                if (!worldName) return;

                const isCharBook = worldName === 'char_book';
                const newEntry = {
                    id: `wi_${Date.now()}`,
                    enabled: true,
                    name: 'æ–°æ¡ç›®',
                    keys: [],
                    content: '',
                    case_sensitive: false,
                    whole_word: false,
                    position: 0,
                    role: 0,
                    scan_depth: 50,
                    use_regex: false
                };

                if (isCharBook && wi.charBook) {
                    if (!wi.charBook.entries) wi.charBook.entries = [];
                    wi.charBook.entries.push(newEntry);
                    const activeChar = char.data[char.activeCharacterId];
                    if (activeChar) {
                        activeChar.data.character_book = wi.charBook;
                        saveCharacters();
                    }
                } else if (wi.data[worldName]) {
                    wi.data[worldName].push(newEntry);
                    saveWiData(wi.data);
                }

                renderEntries(worldName);
                selectEntry(worldName, newEntry.id);
            });

            // å…‹éš†æ¡ç›®
            wi.editor.cloneBtn.addEventListener('click', () => {
                const worldName = wi.worldSelect.value;
                const entryId = wi.editor.id.value;
                if (!worldName || !entryId) return;

                const isCharBook = worldName === 'char_book';
                let dataSet = isCharBook ? wi.charBook?.entries : wi.data[worldName];
                const entry = dataSet?.find(e => e.id === entryId || `char_entry_${e.id}` === entryId);
                if (!entry) return;

                const clonedEntry = {
                    ...entry,
                    id: `wi_${Date.now()}`,
                    name: (entry.name || entry.comment || 'æ— æ ‡é¢˜') + ' (å‰¯æœ¬)'
                };

                if (isCharBook && wi.charBook) {
                    wi.charBook.entries.push(clonedEntry);
                    const activeChar = char.data[char.activeCharacterId];
                    if (activeChar) {
                        activeChar.data.character_book = wi.charBook;
                        saveCharacters();
                    }
                } else {
                    wi.data[worldName].push(clonedEntry);
                    saveWiData(wi.data);
                }

                renderEntries(worldName);
                selectEntry(worldName, clonedEntry.id);
            });

            // åˆ é™¤æ¡ç›®
            wi.editor.deleteBtn.addEventListener('click', () => {
                const worldName = wi.worldSelect.value;
                const entryId = wi.editor.id.value;
                if (!worldName || !entryId) return;

                if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¡ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;

                const isCharBook = worldName === 'char_book';
                let dataSet = isCharBook ? wi.charBook?.entries : wi.data[worldName];
                const entryIndex = dataSet?.findIndex(e => e.id === entryId || `char_entry_${e.id}` === entryId);
                if (entryIndex === -1) return;

                dataSet.splice(entryIndex, 1);

                if (isCharBook) {
                    const activeChar = char.data[char.activeCharacterId];
                    if (activeChar) {
                        activeChar.data.character_book = wi.charBook;
                        saveCharacters();
                    }
                } else {
                    saveWiData(wi.data);
                }

                hideWiEditor();
                renderEntries(worldName);
            });

            // è‡ªåŠ¨ä¿å­˜ - ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–
            [wi.editor.enabled, wi.editor.name, wi.editor.keys, wi.editor.entryContent].forEach(element => {
                if (!element) return;
                const eventType = element.type === 'checkbox' ? 'change' : 'input';
                element.addEventListener(eventType, () => {
                    if (wi.editor.id.value) {
                        saveCurrentEntry();
                    }
                });
            });

            // ç›‘å¬å…¶ä»–è¡¨å•å…ƒç´ 
            ['wi-keys-case-sensitive', 'wi-keys-whole-word', 'wi-entry-position', 'wi-entry-role', 'wi-scan-depth', 'wi-use-regex'].forEach(id => {
                const elem = document.getElementById(id);
                if (elem) {
                    const eventType = elem.type === 'checkbox' || elem.tagName === 'SELECT' ? 'change' : 'input';
                    elem.addEventListener(eventType, () => {
                        if (wi.editor.id.value) {
                            saveCurrentEntry();
                        }
                    });
                }
            });


            // --- Regex Logic ---
            const regex = {
                globalList: document.getElementById('global-regex-list'),
                localList: document.getElementById('local-regex-list'),
                newGlobalBtn: document.getElementById('regex-new-global-btn'),
                newLocalBtn: document.getElementById('regex-new-local-btn'),
                importBtn: document.getElementById('regex-import-btn'),
                importFile: document.getElementById('regex-import-file'),
                localEnableToggle: document.getElementById('local-regex-enable-toggle'),
                editor: {
                    id: document.getElementById('edit-regex-id'),
                    scope: document.getElementById('edit-regex-scope'),
                    name: document.getElementById('regex-name-input'),
                    find: document.getElementById('regex-find-input'),
                    replace: document.getElementById('regex-replace-input'),
                    placements: document.querySelectorAll('.regex-placement-cb'),
                    markdownOnly: document.getElementById('regex-markdown-only'),
                    promptOnly: document.getElementById('regex-prompt-only'),
                    minDepth: document.getElementById('regex-min-depth'),
                    maxDepth: document.getElementById('regex-max-depth'),
                    saveBtn: document.getElementById('save-regex-changes-btn'),
                    deleteBtn: document.getElementById('delete-regex-btn'),
                },
                importModal: {
                    modal: document.getElementById('import-regex-location-modal'),
                    confirmBtn: document.getElementById('confirm-regex-import-btn'),
                    cancelBtn: document.getElementById('cancel-regex-import-btn'),
                    location: () => document.querySelector('input[name="import-location"]:checked').value,
                },
                data: { global: [], local: [] },
                importedDataCache: null,
            };

            async function getRegexData() {
                const globalDataStr = await idbStorage.getItem('global_regex_v1');
                const globalData = globalDataStr ? JSON.parse(globalDataStr) : [];
                return { global: globalData };
            }

            async function saveRegexData() {
                await idbStorage.setItem('global_regex_v1', JSON.stringify(regex.data.global));
                const activeChar = char.data[char.activeCharacterId];
                if (activeChar) {
                    if(!activeChar.data) activeChar.data = {};
                    activeChar.data.regex = regex.data.local;
                    activeChar.data.regex_enabled = regex.localEnableToggle.checked;
                    await saveCharacters();
                }
                triggerAutoSave();
            }
            
            function createScriptItem(script, scope) {
                 const item = document.createElement('div');
                 item.className = 'regex-script-item flex items-center justify-between p-2 rounded-lg border cursor-pointer';
                 item.dataset.id = script.id;
                 item.dataset.scope = scope;
                 item.innerHTML = `
                    <div class="flex items-center gap-3 flex-1">
                        <i class="fas fa-grip-vertical drag-handle text-gray-400"></i>
                        <span class="font-medium text-sm truncate">${script.scriptName}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fas fa-eye text-gray-400" title="é¢„è§ˆ"></i>
                        <button class="edit-regex-btn w-8 h-8 flex items-center justify-center btn-secondary rounded-md" title="ç¼–è¾‘"><i class="fas fa-pen"></i></button>
                        <input type="checkbox" class="switch regex-enable-toggle" ${!script.disabled ? 'checked' : ''}>
                    </div>
                 `;
                 item.querySelector('.edit-regex-btn').addEventListener('click', (e) => {
                     e.stopPropagation();
                     populateRegexEditor(script, scope);
                 });
                 item.querySelector('.regex-enable-toggle').addEventListener('click', (e) => {
                     e.stopPropagation();
                     script.disabled = !e.target.checked;
                     saveRegexData();
                 });
                 return item;
            }

            function renderRegexLists() {
                regex.globalList.innerHTML = '';
                regex.localList.innerHTML = '';

                // ç¡®ä¿ global æ•°ç»„å­˜åœ¨
                if (!regex.data.global || regex.data.global.length === 0) {
                    regex.globalList.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">æ²¡æœ‰æ‰¾åˆ°è„šæœ¬</p>';
                } else {
                    regex.data.global.forEach(script => regex.globalList.appendChild(createScriptItem(script, 'global')));
                }

                const activeCharExists = char.activeCharacterId && char.data[char.activeCharacterId];
                document.getElementById('local-regex-section').style.opacity = activeCharExists ? '1' : '0.5';
                document.getElementById('regex-new-local-btn').disabled = !activeCharExists;

                if (activeCharExists && regex.data.local && regex.data.local.length > 0) {
                    regex.data.local.forEach(script => regex.localList.appendChild(createScriptItem(script, 'local')));
                } else {
                     regex.localList.innerHTML = `<p class="text-sm text-gray-400 text-center py-4">${activeCharExists ? 'æ²¡æœ‰æ‰¾åˆ°è„šæœ¬' : 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²'}</p>`;
                }

                new Sortable(regex.globalList, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: (e) => onRegexSort(e, 'global') });
                new Sortable(regex.localList, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: (e) => onRegexSort(e, 'local') });
            }

            function onRegexSort(evt, scope) {
                const reorderedData = Array.from(evt.to.children).map(item => {
                    return regex.data[scope].find(script => script.id === item.dataset.id);
                });
                regex.data[scope] = reorderedData;
                saveRegexData();
            }

            async function loadRegexData(characterRegex = [], characterRegexEnabled = false) {
                const data = await getRegexData();
                regex.data.global = data.global || [];
                regex.data.local = characterRegex || [];
                regex.localEnableToggle.checked = characterRegexEnabled;
                renderRegexLists();
            }
            
            function populateRegexEditor(script, scope) {
                regex.editor.id.value = script.id;
                regex.editor.scope.value = scope;
                regex.editor.name.value = script.scriptName || '';
                regex.editor.find.value = script.findRegex || '';
                regex.editor.replace.value = script.replaceString || '';
                regex.editor.markdownOnly.checked = script.markdownOnly || false;
                regex.editor.promptOnly.checked = script.promptOnly || false;
                regex.editor.minDepth.value = script.minDepth ?? '';
                regex.editor.maxDepth.value = script.maxDepth ?? '';
                
                regex.editor.placements.forEach(cb => {
                    const placementVal = parseInt(cb.dataset.placement);
                    cb.checked = (script.placement || []).includes(placementVal);
                });
                openEditRegexModal();
            }
            
            function saveRegexFromEditor() {
                const id = regex.editor.id.value;
                const scope = regex.editor.scope.value;
                if (!regex.data[scope]) return;
                const scriptIndex = regex.data[scope].findIndex(s => s.id === id);
                if (scriptIndex === -1) return;
                
                const script = regex.data[scope][scriptIndex];
                script.scriptName = regex.editor.name.value;
                script.findRegex = regex.editor.find.value;
                script.replaceString = regex.editor.replace.value;
                script.markdownOnly = regex.editor.markdownOnly.checked;
                script.promptOnly = regex.editor.promptOnly.checked;
                script.minDepth = regex.editor.minDepth.value ? parseInt(regex.editor.minDepth.value) : null;
                script.maxDepth = regex.editor.maxDepth.value ? parseInt(regex.editor.maxDepth.value) : null;
                
                script.placement = [];
                regex.editor.placements.forEach(cb => {
                    if (cb.checked) {
                        script.placement.push(parseInt(cb.dataset.placement));
                    }
                });
                
                saveRegexData();
                renderRegexLists();
                closeEditRegexModal();
            }
            
            function deleteRegexFromEditor() {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ­£åˆ™è„šæœ¬å—ï¼Ÿ')) return;
                const id = regex.editor.id.value;
                const scope = regex.editor.scope.value;
                if (!regex.data[scope]) return;
                regex.data[scope] = regex.data[scope].filter(s => s.id !== id);
                saveRegexData();
                renderRegexLists();
                closeEditRegexModal();
            }
            
            function createNewRegex(scope) {
                const newScript = {
                    id: `regex_${Date.now()}`,
                    scriptName: 'æ–°æ­£åˆ™è„šæœ¬',
                    findRegex: '',
                    replaceString: '',
                    placement: [1], // Default to AI Output
                    disabled: false,
                    markdownOnly: false,
                    promptOnly: false,
                    minDepth: null,
                    maxDepth: null
                };
                if (!regex.data[scope]) regex.data[scope] = [];
                regex.data[scope].push(newScript);
                saveRegexData();
                renderRegexLists();
                populateRegexEditor(newScript, scope);
            }
            
            regex.newGlobalBtn.addEventListener('click', () => createNewRegex('global'));
            regex.newLocalBtn.addEventListener('click', () => {
                 if (!char.activeCharacterId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²ä»¥æ·»åŠ å±€éƒ¨æ­£åˆ™ã€‚');
                    return;
                }
                createNewRegex('local')
            });
            regex.editor.saveBtn.addEventListener('click', saveRegexFromEditor);
            regex.editor.deleteBtn.addEventListener('click', deleteRegexFromEditor);
            regex.localEnableToggle.addEventListener('change', saveRegexData);
            
            regex.importBtn.addEventListener('click', () => regex.importFile.click());
            regex.importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        regex.importedDataCache = Array.isArray(imported) ? imported : [imported];
                        
                        if (!regex.importedDataCache.every(item => item.id && item.scriptName && item.findRegex !== undefined)) {
                            throw new Error('JSON æ–‡ä»¶æ ¼å¼æ— æ•ˆæˆ–ç¼ºå°‘å¿…è¦å­—æ®µã€‚');
                        }
                        
                        regex.importModal.modal.classList.add('active');
                        document.querySelector('input[name="import-location"][value="local"]').disabled = !char.activeCharacterId;

                    } catch(err) {
                        alert(`å¯¼å…¥å¤±è´¥: ${err.message}`);
                        regex.importedDataCache = null;
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            });

            regex.importModal.confirmBtn.addEventListener('click', () => {
                if (!regex.importedDataCache) return;
                const location = regex.importModal.location();
                
                regex.importedDataCache.forEach(script => {
                    if (!regex.data[location]) regex.data[location] = [];
                    if (!regex.data[location].some(s => s.id === script.id)) {
                        regex.data[location].push(script);
                    }
                });
                
                saveRegexData();
                renderRegexLists();
                alert(`æˆåŠŸå¯¼å…¥ ${regex.importedDataCache.length} ä¸ªè„šæœ¬åˆ°${location === 'global' ? 'å…¨å±€' : 'å±€éƒ¨'}åˆ—è¡¨!`);
                regex.importModal.modal.classList.remove('active');
                regex.importedDataCache = null;
            });
            
            regex.importModal.cancelBtn.addEventListener('click', () => {
                regex.importModal.modal.classList.remove('active');
                regex.importedDataCache = null;
            });

            // --- Tokenè®¡ç®—å’Œæç¤ºè¯é¢„è§ˆ ---
            function estimateTokens(text) {
                // ç®€å•çš„Tokenä¼°ç®—ï¼šå¹³å‡æ¯4ä¸ªå­—ç¬¦ä¸º1ä¸ªtokenï¼ˆè‹±æ–‡ï¼‰
                // ä¸­æ–‡å¤§çº¦æ¯ä¸ªå­—2-3ä¸ªtoken
                if (!text) return 0;

                const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
                const englishChars = text.length - chineseChars;

                // ä¸­æ–‡å­—ç¬¦æŒ‰2.5ä¸ªtokenè®¡ç®—ï¼Œè‹±æ–‡æŒ‰0.25ä¸ªtokenè®¡ç®—
                return Math.ceil(chineseChars * 2.5 + englishChars * 0.25);
            }

            function updatePromptPreview(messages) {
                if (!messages || messages.length === 0) return;

                const previewContent = document.getElementById('prompt-preview-content');
                if (!previewContent) return;

                let systemTokens = 0;
                let chatTokens = 0;
                let worldTokens = 0;
                let html = '';

                // æ£€æŸ¥æ¸…å•çŠ¶æ€
                let hasSystemPrompt = false;
                let hasUserProfile = false;
                let hasCharDesc = false;
                let hasWorldInfo = false;
                let hasChatHistory = false;
                let hasRegex = regex.data.global.length > 0 || (regex.localEnableToggle?.checked && regex.data.local.length > 0);

                messages.forEach((msg, index) => {
                    const tokens = estimateTokens(msg.content);

                    if (msg.role === 'system') {
                        hasSystemPrompt = true;

                        // æ£€æŸ¥ç³»ç»Ÿæ¶ˆæ¯ä¸­çš„å„ç§å†…å®¹
                        if (msg.content.includes('User:')) {
                            hasUserProfile = true;
                        }
                        if (msg.content.includes('Character:') || msg.content.includes('You are')) {
                            hasCharDesc = true;
                        }

                        // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸–ç•Œä¹¦ä¿¡æ¯
                        if (msg.content.includes('World Information:')) {
                            hasWorldInfo = true;
                            const worldInfoStart = msg.content.indexOf('World Information:');
                            const beforeWorld = msg.content.substring(0, worldInfoStart);
                            const worldInfo = msg.content.substring(worldInfoStart);

                            systemTokens += estimateTokens(beforeWorld);
                            worldTokens += estimateTokens(worldInfo);
                        } else {
                            systemTokens += tokens;
                        }
                    } else {
                        chatTokens += tokens;
                        if (msg.role === 'user' || msg.role === 'assistant') {
                            hasChatHistory = true;
                        }
                    }

                    // æ„å»ºé¢„è§ˆHTML
                    const roleColor = msg.role === 'system' ? 'bg-blue-50 border-blue-300' :
                                     msg.role === 'user' ? 'bg-green-50 border-green-300' :
                                     'bg-purple-50 border-purple-300';

                    const roleIcon = msg.role === 'system' ? 'fa-cog' :
                                    msg.role === 'user' ? 'fa-user' :
                                    'fa-robot';

                    const roleLabel = msg.role === 'system' ? 'ç³»ç»Ÿ' :
                                     msg.role === 'user' ? 'ç”¨æˆ·' :
                                     'AIåŠ©æ‰‹';

                    html += `
                        <div class="border rounded-lg p-4 ${roleColor}">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="fas ${roleIcon}"></i>
                                    <span class="font-bold">${roleLabel}</span>
                                </div>
                                <span class="text-sm text-gray-600">${tokens} tokens</span>
                            </div>
                            <div class="text-sm whitespace-pre-wrap font-mono bg-white p-3 rounded border">${escapeHtml(msg.content)}</div>
                        </div>
                    `;
                });

                previewContent.innerHTML = html;

                // æ›´æ–°Tokenç»Ÿè®¡
                document.getElementById('total-tokens').textContent = systemTokens + chatTokens + worldTokens;
                document.getElementById('system-tokens').textContent = systemTokens;
                document.getElementById('chat-tokens').textContent = chatTokens;
                document.getElementById('world-tokens').textContent = worldTokens;

                // æ›´æ–°æ£€æŸ¥æ¸…å•
                updateCheckItem('check-system-prompt', hasSystemPrompt);
                updateCheckItem('check-user-profile', hasUserProfile);
                updateCheckItem('check-char-desc', hasCharDesc);
                updateCheckItem('check-world-info', hasWorldInfo);
                updateCheckItem('check-chat-history', hasChatHistory);
                updateCheckItem('check-regex', hasRegex);
            }

            function updateCheckItem(id, status) {
                const element = document.getElementById(id);
                if (!element) return;

                const icon = element.querySelector('i');
                if (status) {
                    icon.className = 'fas fa-check-circle text-green-500';
                    element.style.opacity = '1';
                } else {
                    icon.className = 'fas fa-times-circle text-gray-400';
                    element.style.opacity = '0.6';
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async function showPromptPreview() {
                const modal = document.getElementById('prompt-preview-modal');
                // å¦‚æœè¿˜æ²¡æœ‰æ„å»ºè¿‡æç¤ºè¯ï¼Œå…ˆæ„å»ºä¸€æ¬¡
                if (!window.lastConstructedPrompt) {
                    const messages = await constructFinalPrompt();
                    window.lastConstructedPrompt = messages;
                }
                if (window.lastConstructedPrompt) {
                    updatePromptPreview(window.lastConstructedPrompt);
                }
                modal.classList.add('active');
            }

            // å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿ onclick å¯ä»¥è®¿é—®
            window.showPromptPreview = showPromptPreview;

            // æç¤ºè¯é¢„è§ˆæ¨¡æ€æ¡†äº‹ä»¶
            document.getElementById('close-prompt-preview')?.addEventListener('click', () => {
                document.getElementById('prompt-preview-modal').classList.remove('active');
            });

            document.getElementById('copy-prompt-btn')?.addEventListener('click', () => {
                if (window.lastConstructedPrompt) {
                    const text = window.lastConstructedPrompt.map(m => `[${m.role}]\n${m.content}`).join('\n\n');
                    navigator.clipboard.writeText(text).then(() => {
                        const btn = document.getElementById('copy-prompt-btn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-check mr-2"></i>å·²å¤åˆ¶';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                        }, 2000);
                    });
                }
            });

            // --- Chat Logic ---
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');

            // chatHistory å·²åœ¨å…¨å±€ä½œç”¨åŸŸå£°æ˜
            let currentReply = null; // å½“å‰å›å¤çš„æ¶ˆæ¯

            function startNewChat(greetingContent = null) {
                chatHistory = [];
                chatMessages.innerHTML = '';

                // æ¸…ç†æ‰€æœ‰æ³¨å…¥çš„æ ·å¼å…ƒç´ 
                document.querySelectorAll('style[id^="style-"]').forEach(style => {
                    style.remove();
                });

                const activeChar = char.data[char.activeCharacterId];

                // å¦‚æœæŒ‡å®šäº†å¼€åœºç™½å†…å®¹,ç›´æ¥ä½¿ç”¨
                if (greetingContent) {
                    addMessageToHistory({role: 'assistant', content: greetingContent, type: 'text'});
                    return;
                }

                // å¦‚æœæ²¡æœ‰æ¿€æ´»è§’è‰²æˆ–æ²¡æœ‰å¼€åœºç™½,ç›´æ¥è¿”å›
                if (!activeChar || !activeChar.first_mes) {
                    return;
                }

                // æ”¶é›†æ‰€æœ‰å¯ç”¨çš„å¼€åœºç™½
                const greetings = [activeChar.first_mes];
                if (activeChar.data && activeChar.data.alternate_greetings) {
                    greetings.push(...activeChar.data.alternate_greetings.filter(g => g && g.trim()));
                }

                // å¦‚æœåªæœ‰ä¸€æ¡å¼€åœºç™½,ç›´æ¥ä½¿ç”¨
                if (greetings.length === 1) {
                    addMessageToHistory({role: 'assistant', content: greetings[0], type: 'text'});
                } else {
                    // å¦‚æœæœ‰å¤šæ¡å¼€åœºç™½,æ˜¾ç¤ºé€‰æ‹©å¼¹çª—
                    showGreetingSelector(greetings);
                }
            }

            function showGreetingSelector(greetings) {
                const modal = document.getElementById('greeting-selector-modal');
                const list = document.getElementById('greeting-list');
                list.innerHTML = '';

                // æ¸…ç†ä¹‹å‰å¯èƒ½æ³¨å…¥åˆ°headçš„æ—§æ ·å¼
                document.querySelectorAll('style[id^="style-preview-"]').forEach(style => {
                    style.remove();
                });

                greetings.forEach((greeting, index) => {
                    const item = document.createElement('div');
                    item.className = 'p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors';

                    // åº”ç”¨regexè½¬æ¢åè·å–é¢„è§ˆ
                    const processedGreeting = applyRegex(greeting);

                    // åˆ›å»ºå…ƒç´ è€Œä¸æ˜¯ç”¨innerHTMLé¿å…XSS
                    const flexDiv = document.createElement('div');
                    flexDiv.className = 'flex items-start gap-3';

                    const badge = document.createElement('div');
                    badge.className = 'flex-shrink-0 w-8 h-8 bg-primary-color text-white rounded-full flex items-center justify-center font-bold';
                    badge.textContent = index + 1;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'flex-1 min-w-0';

                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'text-sm font-medium text-gray-900 mb-1';
                    titleDiv.textContent = `å¼€åœºç™½ ${index + 1}`;

                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'text-sm text-gray-600 break-words';
                    previewDiv.style.maxHeight = '200px';
                    previewDiv.style.overflow = 'hidden';
                    previewDiv.style.overflowWrap = 'break-word';
                    previewDiv.style.wordBreak = 'break-word';
                    previewDiv.style.maxWidth = '100%';

                    // æ£€æŸ¥æ˜¯å¦åŒ…å«HTMLå†…å®¹
                    if (containsHTML(processedGreeting)) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œæ•´çš„HTMLæ–‡æ¡£ï¼ˆåŒ…å«<!DOCTYPE, <html>, <body>ç­‰ï¼‰
                        const isFullHTMLDoc = /<!DOCTYPE|<html|<body/i.test(processedGreeting);

                        if (isFullHTMLDoc) {
                            // å¯¹äºå®Œæ•´çš„HTMLæ–‡æ¡£ï¼Œä¸ç›´æ¥æ¸²æŸ“ï¼Œè€Œæ˜¯æ˜¾ç¤ºæç¤ºä¿¡æ¯
                            // é¿å…åŒæ—¶æ¸²æŸ“å¤šä¸ªå¤æ‚iframeå¯¼è‡´é¡µé¢å¡é¡¿
                            const placeholder = document.createElement('div');
                            placeholder.className = 'p-4 bg-purple-50 border border-purple-200 rounded-lg text-center';
                            placeholder.innerHTML = `
                                <div class="text-purple-700 mb-2">
                                    <i class="fas fa-code text-2xl"></i>
                                </div>
                                <div class="text-sm text-purple-600 font-medium">åŒ…å«å®Œæ•´HTMLæ–‡æ¡£</div>
                                <div class="text-xs text-purple-500 mt-1">ç‚¹å‡»æ­¤å¼€åœºç™½å¯æŸ¥çœ‹å®Œæ•´å†…å®¹</div>
                            `;
                            previewDiv.appendChild(placeholder);
                        } else {
                            // éå®Œæ•´HTMLæ–‡æ¡£ï¼Œä½¿ç”¨åŸæœ‰çš„divéš”ç¦»æ–¹æ¡ˆ
                            const sandbox = document.createElement('div');
                            sandbox.style.maxHeight = '200px';
                            sandbox.style.overflow = 'hidden';
                            sandbox.style.position = 'relative';
                            sandbox.style.maxWidth = '100%';

                            // å¤„ç†<style>æ ‡ç­¾
                            const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
                            const styles = [];
                            let match;

                            // æå–æ‰€æœ‰<style>æ ‡ç­¾å†…å®¹
                            while ((match = styleRegex.exec(processedGreeting)) !== null) {
                                styles.push(match[1]);
                            }

                            if (styles.length > 0) {
                                // ç§»é™¤åŸå†…å®¹ä¸­çš„<style>æ ‡ç­¾
                                const contentWithoutStyles = processedGreeting.replace(styleRegex, '');

                                // åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„æ ·å¼å®¹å™¨ID
                                const styleId = `greeting-preview-${index}`;

                                // ä½¿ç”¨ä½œç”¨åŸŸé™å®šçš„æ ·å¼ - æ·»åŠ å‰ç¼€åˆ°æ‰€æœ‰é€‰æ‹©å™¨
                                let scopedStyles = styles.join('\n');
                                // ä¸ºæ¯ä¸ªCSSè§„åˆ™æ·»åŠ ä½œç”¨åŸŸå‰ç¼€
                                scopedStyles = scopedStyles.replace(/([^\r\n,{}]+)(,(?=[^}]*{)|\s*{)/g, (match, selector, separator) => {
                                    // è·³è¿‡ @è§„åˆ™ (å¦‚ @media, @keyframes)
                                    if (selector.trim().startsWith('@')) {
                                        return match;
                                    }
                                    // æ·»åŠ ä½œç”¨åŸŸå‰ç¼€
                                    return `#${styleId} ${selector.trim()}${separator}`;
                                });

                                // åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å”¯ä¸€IDçš„wrapper
                                const styledWrapper = document.createElement('div');
                                styledWrapper.id = styleId;
                                styledWrapper.style.maxHeight = '200px';
                                styledWrapper.style.overflow = 'hidden';
                                styledWrapper.style.position = 'relative';
                                styledWrapper.style.maxWidth = '100%';

                                // åˆ›å»º<style>å…ƒç´ å¹¶æ’å…¥åˆ°wrapperå†…éƒ¨
                                const styleElement = document.createElement('style');
                                styleElement.textContent = scopedStyles;
                                styledWrapper.appendChild(styleElement);

                                // æ’å…¥ä¸å«<style>çš„HTMLå†…å®¹
                                const contentContainer = document.createElement('div');
                                contentContainer.innerHTML = contentWithoutStyles;
                                styledWrapper.appendChild(contentContainer);

                                sandbox.appendChild(styledWrapper);
                            } else {
                                // æ²¡æœ‰æ ·å¼,ç›´æ¥ä½¿ç”¨innerHTML
                                sandbox.innerHTML = processedGreeting;
                            }

                            previewDiv.appendChild(sandbox);
                        }
                    } else {
                        // çº¯æ–‡æœ¬å†…å®¹
                        const textPreview = processedGreeting.length > 300 ? processedGreeting.substring(0, 300) + '...' : processedGreeting;
                        previewDiv.textContent = textPreview;
                        previewDiv.style.whiteSpace = 'pre-wrap';
                    }

                    contentDiv.appendChild(titleDiv);
                    contentDiv.appendChild(previewDiv);
                    flexDiv.appendChild(badge);
                    flexDiv.appendChild(contentDiv);
                    item.appendChild(flexDiv);

                    item.addEventListener('click', () => {
                        modal.style.display = 'none';
                        startNewChat(greeting);
                    });

                    list.appendChild(item);
                });

                modal.style.display = 'flex';
            }
            
            async function addMessageToHistory(messageData) {
                const messageId = `msg_${Date.now()}`;
                const message = { id: messageId, ...messageData };
                chatHistory.push(message);
                renderMessage(message);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // è‡ªåŠ¨ä¿å­˜èŠå¤©è®°å½•
                if (char.activeCharacterId) {
                    await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                    triggerAutoSave();
                }
            }

            async function loadChatHistory(characterId) {
                // å°è¯•ä»IndexedDBåŠ è½½è¯¥è§’è‰²çš„èŠå¤©è®°å½•
                const savedHistory = await idbStorage.getItem(`chat_history_${characterId}`);
                if (savedHistory) {
                    try {
                        chatHistory = JSON.parse(savedHistory);
                        // æ¸…ç©ºèŠå¤©ç•Œé¢
                        chatMessages.innerHTML = '';
                        // æ¸…ç†æ‰€æœ‰æ³¨å…¥çš„æ ·å¼å…ƒç´ 
                        document.querySelectorAll('style[id^="style-"]').forEach(style => {
                            style.remove();
                        });
                        // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯(è·³è¿‡éšè—çš„æ¶ˆæ¯)
                        chatHistory.forEach(message => {
                            if (!message.hidden) {
                                renderMessage(message);
                            }
                        });
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } catch (e) {
                        console.error('Failed to load chat history:', e);
                        // å¦‚æœåŠ è½½å¤±è´¥ï¼Œåˆ™å¼€å§‹æ–°èŠå¤©
                        startNewChat();
                    }
                } else {
                    // æ²¡æœ‰ä¿å­˜çš„èŠå¤©è®°å½•ï¼Œå¼€å§‹æ–°èŠå¤©
                    startNewChat();
                }
            }

            // ä¿å­˜èŠå¤©è®°å½•
            async function saveChat() {
                if (char.activeCharacterId) {
                    try {
                        await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                        triggerAutoSave();
                    } catch (e) {
                        console.error('ä¿å­˜èŠå¤©è®°å½•å¤±è´¥:', e);
                    }
                }
            }

            // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
            function renderMessages() {
                // æ¸…ç©ºèŠå¤©ç•Œé¢
                chatMessages.innerHTML = '';
                // æ¸…ç†æ‰€æœ‰æ³¨å…¥çš„æ ·å¼å…ƒç´ 
                document.querySelectorAll('style[id^="style-"]').forEach(style => {
                    style.remove();
                });
                // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯ï¼ˆè·³è¿‡éšè—çš„æ¶ˆæ¯ï¼‰
                chatHistory.forEach(message => {
                    if (!message.hidden) {
                        renderMessage(message);
                    }
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // æ£€æµ‹æ˜¯å¦åŒ…å«HTMLæ ‡ç­¾ï¼ˆä»…ç”¨äºregexæ›¿æ¢åçš„å†…å®¹ï¼‰
            function containsHTML(text) {
                // æ£€æµ‹æ˜¯å¦åŒ…å«HTMLæ ‡ç­¾ï¼Œæ’é™¤å¸¸è§çš„ç¬¦å·ç»„åˆ
                return /<[a-z][\s\S]*>/i.test(text);
            }

            // ä¸ºiframeæ³¨å…¥é€æ˜èƒŒæ™¯æ ·å¼
            function injectTransparentStyles(iframeDoc) {
                if (!iframeDoc || !iframeDoc.head) return;
                try {
                    const transparentStyle = iframeDoc.createElement('style');
                    transparentStyle.textContent = `
                        /* è®©iframeçš„bodyèƒŒæ™¯é€æ˜,ä½†ä¸å½±å“çŠ¶æ€æ ç»„ä»¶æœ¬èº«çš„æ ·å¼ */
                        html, body {
                            background-color: transparent !important;
                        }
                    `;
                    iframeDoc.head.appendChild(transparentStyle);
                } catch (e) {
                    console.log('[iframe] æ— æ³•æ³¨å…¥é€æ˜æ ·å¼:', e);
                }
            }

            function applyRegex(text) {
                let processedText = text;
                const allScripts = [
                    ...(regex.data.global || []),
                    ...(regex.localEnableToggle.checked ? (regex.data.local || []) : [])
                ];

                for (const script of allScripts) {
                    if (script.disabled || !script.findRegex) continue;
                    try {
                        let pattern = script.findRegex;
                        let flags = 'g'; // Default global flag

                        // Check if findRegex is in /pattern/flags format
                        if (pattern.startsWith('/')) {
                            const lastSlashIndex = pattern.lastIndexOf('/');
                            if (lastSlashIndex > 0) {
                                // Extract flags (everything after last slash)
                                const extractedFlags = pattern.substring(lastSlashIndex + 1);
                                // Extract pattern (between first and last slash)
                                pattern = pattern.substring(1, lastSlashIndex);
                                // Combine extracted flags with default 'g' flag
                                flags = extractedFlags.includes('g') ? extractedFlags : extractedFlags + 'g';
                            }
                        }

                        const re = new RegExp(pattern, flags);
                        // ä½¿ç”¨å‡½æ•°å½¢å¼çš„replaceæ¥æ­£ç¡®å¤„ç†æ•è·ç»„
                        processedText = processedText.replace(re, function(match, ...groups) {
                            let result = script.replaceString;
                            // æ›¿æ¢ $1, $2, $3 ç­‰æ•è·ç»„
                            groups.forEach((group, index) => {
                                if (group !== undefined) {
                                    // ä½¿ç”¨æ­£åˆ™æ›¿æ¢æ‰€æœ‰å‡ºç°çš„ $1, $2 ç­‰
                                    const placeholder = new RegExp('\\$' + (index + 1), 'g');
                                    result = result.replace(placeholder, group);
                                }
                            });
                            return result;
                        });
                    } catch (e) {
                        console.error(`Regex error in script "${script.scriptName}":`, e);
                    }
                }
                return processedText;
            }

            function renderMessage(message) {
                 const { id, role, content, type = 'text', replyTo, imageUrl, description } = message;

                const isUser = role === 'user';

                const group = document.createElement('div');
                group.id = id;
                group.className = `chat-message-group flex flex-col items-center gap-1 mb-3`;
                group.style.position = 'relative';

                // è·å–ç”¨æˆ·å¤´åƒ
                const currentUser = userManagement.getCurrentUser();
                const charAvatar = char.data[char.activeCharacterId]?.avatar;
                const charAvatarSrc = (charAvatar && charAvatar !== 'none') ? charAvatar : 'https://placehold.co/40x40/5E5B9D/ffffff?text=AI';
                let avatarSrc = isUser ? (currentUser?.avatar || 'https://placehold.co/40x40/E4E6EB/1A1A1D?text=U') : charAvatarSrc;

                // å¤´åƒå’Œåç§°
                const avatarContainer = document.createElement('div');
                avatarContainer.className = 'flex flex-col items-center gap-1';

                const avatarImg = document.createElement('img');
                avatarImg.src = avatarSrc;
                avatarImg.className = 'w-12 h-12 rounded-full object-cover';
                avatarImg.addEventListener('dblclick', () => {
                    avatarImg.classList.add('patted');
                    setTimeout(() => avatarImg.classList.remove('patted'), 600);
                });

                const userName = document.createElement('span');
                userName.className = 'text-xs text-gray-500 font-medium';
                userName.textContent = isUser ? (userManagement.getCurrentUser()?.name || 'ç”¨æˆ·') : (char.data[char.activeCharacterId]?.name || 'AI');

                // æ·»åŠ æ¶ˆæ¯æ“ä½œæ ï¼ˆæ”¾åœ¨å¤´åƒä¸‹æ–¹ï¼Œæ¨ªå‘æ’åˆ—ï¼‰
                const actionsBar = document.createElement('div');
                actionsBar.className = 'message-actions flex flex-row gap-1 mt-1';

                // ç¼–è¾‘æŒ‰é’®
                const editBtn = document.createElement('button');
                editBtn.className = 'message-action-btn text-xs px-1.5 py-1';
                editBtn.innerHTML = '<i class="fas fa-pen text-xs"></i>';
                editBtn.title = 'ç¼–è¾‘';
                editBtn.onclick = () => startEditMessage(id);
                actionsBar.appendChild(editBtn);

                // é‡æ–°ç”ŸæˆæŒ‰é’® (ä»…AIæ¶ˆæ¯)
                if (!isUser) {
                    const regenBtn = document.createElement('button');
                    regenBtn.className = 'message-action-btn text-xs px-1.5 py-1';
                    regenBtn.innerHTML = '<i class="fas fa-sync-alt text-xs"></i>';
                    regenBtn.title = 'é‡æ–°ç”Ÿæˆ';
                    regenBtn.onclick = () => regenerateMessage(id);
                    actionsBar.appendChild(regenBtn);
                }

                // åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'message-action-btn danger text-xs px-1.5 py-1';
                deleteBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
                deleteBtn.title = 'åˆ é™¤';
                deleteBtn.onclick = () => {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                        deleteMessage(id);
                    }
                };
                actionsBar.appendChild(deleteBtn);

                avatarContainer.appendChild(avatarImg);
                avatarContainer.appendChild(userName);
                avatarContainer.appendChild(actionsBar);
                group.appendChild(avatarContainer);

                const messageContentContainer = document.createElement('div');
                messageContentContainer.className = `flex flex-col w-full`;

                const messageBubble = document.createElement('div');
                messageBubble.className = `chat-bubble rounded-lg p-3 w-full ${isUser ? 'user-bubble' : 'ai-bubble'}`;
                messageBubble.dataset.messageId = id;

                if (replyTo) {
                    const replyRef = document.createElement('div');
                    replyRef.className = 'reply-reference';
                    replyRef.innerHTML = `<div class="reply-from">å›å¤ ${replyTo.fromName}</div>
                                          <div>${replyTo.content.substring(0, 50)}...</div>`;
                    messageBubble.appendChild(replyRef);
                }

                let finalContent = content;

                if (type === 'text') {
                    // åªå¯¹AIæ¶ˆæ¯åº”ç”¨regex
                    if (!isUser) {
                        finalContent = applyRegex(content);
                    }

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content text-left whitespace-pre-wrap';

                    // æ£€æŸ¥æ˜¯å¦æ˜¯HTMLä»£ç å—æˆ–å®Œæ•´çš„HTMLæ–‡æ¡£
                    if (finalContent.trim().startsWith('```html') || finalContent.trim().startsWith('<!DOCTYPE html>') || finalContent.trim().startsWith('```\n<!DOCTYPE html>')) {
                        // ç§»é™¤markdownä»£ç å—æ ‡è®°
                        let htmlContent = finalContent.trim();
                        // ç§»é™¤å¼€å¤´çš„ ```html æˆ– ```
                        htmlContent = htmlContent.replace(/^```html\s*\n?/, '').replace(/^```\s*\n?/, '');
                        // ç§»é™¤ç»“å°¾çš„ ```
                        htmlContent = htmlContent.replace(/\n?```\s*$/, '');
                        htmlContent = htmlContent.trim();

                        console.log('[iframe] å‡†å¤‡æ¸²æŸ“HTMLå†…å®¹ï¼Œé•¿åº¦:', htmlContent.length);

                        // åˆ›å»ºiframeå®¹å™¨
                        const iframeContainer = document.createElement('div');
                        iframeContainer.className = 'iframe-container';
                        iframeContainer.style.cssText = 'width: 100%; position: relative; min-height: 400px; background: transparent;';

                        // åˆ›å»ºiframeå¹¶è®¾ç½®é€‚å½“çš„sandboxæƒé™ï¼ˆå‚è€ƒSillyTavernï¼‰
                        const iframe = document.createElement('iframe');
                        iframe.className = 'rendered-html-iframe';
                        // è®¾ç½®sandboxæƒé™ï¼šå…è®¸è„šæœ¬ã€åŒæºè®¿é—®ã€è¡¨å•å’Œæ¨¡æ€æ¡†
                        iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox';

                        // è®¾ç½®iframeæ ·å¼
                        iframe.style.cssText = 'width: 100%; border: none; display: block; background: transparent; min-height: 400px;';

                        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
                        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                        console.log('[iframe] è®¾å¤‡ç±»å‹:', isMobile ? 'ç§»åŠ¨ç«¯' : 'PCç«¯');

                        // ç»Ÿä¸€ä½¿ç”¨srcdocæ–¹å¼åŠ è½½ï¼Œé¿å…Blob URLçš„è·¨åŸŸå®‰å…¨é—®é¢˜
                        console.log('[iframe] ä½¿ç”¨srcdocåŠ è½½');
                        iframe.srcdoc = htmlContent;

                        // æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤º
                        const loadingIndicator = document.createElement('div');
                        loadingIndicator.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;';
                        loadingIndicator.textContent = 'åŠ è½½ä¸­...';
                        iframeContainer.appendChild(loadingIndicator);

                        // ç›‘å¬iframeåŠ è½½
                        iframe.addEventListener('load', function() {
                            console.log('[iframe] åŠ è½½å®Œæˆ');
                            loadingIndicator.remove();

                            try {
                                const iframeWindow = iframe.contentWindow;
                                if (iframeWindow) {
                                    // æ³¨å…¥é€æ˜èƒŒæ™¯æ ·å¼
                                    const iframeDoc = iframe.contentDocument || iframeWindow.document;
                                    injectTransparentStyles(iframeDoc);

                                    // æ•è·iframeå†…éƒ¨çš„JavaScripté”™è¯¯
                                    iframeWindow.addEventListener('error', function(event) {
                                        console.error('[iframe] å†…éƒ¨é”™è¯¯:', event.error || event.message);
                                    });

                                    // æ•è·æœªå¤„ç†çš„Promiseæ‹’ç»
                                    iframeWindow.addEventListener('unhandledrejection', function(event) {
                                        console.error('[iframe] Promiseé”™è¯¯:', event.reason);
                                    });

                                    // éŸ³é¢‘æ’­æ”¾ä¿®å¤ï¼ˆç§»åŠ¨ç«¯å’ŒPCç«¯ï¼‰
                                    console.log('[iframe] æ³¨å…¥éŸ³é¢‘æ’­æ”¾æ”¯æŒä»£ç ');

                                    // æ³¨å…¥éŸ³é¢‘æ’­æ”¾è§£é”ä»£ç 
                                    const audioFix = iframeWindow.document.createElement('script');
                                    audioFix.textContent = `
                                            (function() {
                                                console.log('[Mobile Audio Fix] åˆå§‹åŒ–ç§»åŠ¨ç«¯éŸ³é¢‘æ”¯æŒ');

                                                // ç­‰å¾…ç”¨æˆ·çš„ç¬¬ä¸€æ¬¡äº¤äº’æ¥è§£é”éŸ³é¢‘
                                                let hasInteracted = false;

                                                function markInteraction() {
                                                    if (hasInteracted) return;
                                                    hasInteracted = true;
                                                    console.log('[Mobile Audio Fix] ç”¨æˆ·å·²äº¤äº’ï¼ŒéŸ³é¢‘å·²è§£é”');
                                                    tryPlayMusic();
                                                }

                                                function tryPlayMusic() {
                                                    if (!hasInteracted) return;

                                                    const bgmPlayer = document.getElementById('bgMusic');
                                                    if (!bgmPlayer) return;

                                                    if (bgmPlayer.paused && bgmPlayer.src && bgmPlayer.src !== window.location.href) {
                                                        bgmPlayer.play().catch(e => console.error("Autoplay prevent after interaction:", e));
                                                    }
                                                }

                                                // åœ¨ç¬¬ä¸€æ¬¡ç”¨æˆ·äº¤äº’æ—¶è§£é”ï¼ˆä½¿ç”¨æ•è·é˜¶æ®µï¼‰
                                                document.addEventListener('click', (e) => {
                                                    markInteraction();
                                                }, true); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿åœ¨å…¶ä»–äº‹ä»¶ä¹‹å‰è§¦å‘

                                                document.addEventListener('touchstart', (e) => {
                                                    markInteraction();
                                                }, true);

                                                document.addEventListener('touchend', (e) => {
                                                    markInteraction();
                                                }, true);

                                                // ç›‘å¬å…¶ä»–å¯èƒ½çš„äº¤äº’äº‹ä»¶
                                                document.addEventListener('touchmove', (e) => {
                                                    markInteraction();
                                                }, { once: true, capture: true });

                                                // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å°è¯•æ¢å¤æ’­æ”¾
                                                document.addEventListener('visibilitychange', () => {
                                                    if (!document.hidden && hasInteracted) {
                                                        tryPlayMusic();
                                                    }
                                                });

                                                // è¦†ç›–åŸæœ‰çš„éŸ³é¢‘æ’­æ”¾å‡½æ•°ï¼Œæ·»åŠ ç§»åŠ¨ç«¯æ”¯æŒ
                                                if (window.toggleMusic) {
                                                    const originalToggleMusic = window.toggleMusic;
                                                    window.toggleMusic = function() {
                                                        markInteraction(); // ç¡®ä¿æ ‡è®°äº¤äº’
                                                        console.log('[Mobile Audio Fix] toggleMusic è¢«è°ƒç”¨');

                                                        const music = document.getElementById('bgMusic');
                                                        if (!music) {
                                                            console.log('[Mobile Audio Fix] æœªæ‰¾åˆ°bgMusicå…ƒç´ ');
                                                            return;
                                                        }

                                                        if (!music.src || music.src === window.location.href) {
                                                            console.log('[Mobile Audio Fix] éŸ³ä¹æºæœªè®¾ç½®');
                                                            return;
                                                        }

                                                        if (music.paused) {
                                                            console.log('[Mobile Audio Fix] å°è¯•æ’­æ”¾éŸ³ä¹:', music.src);
                                                            const playPromise = music.play();
                                                            if (playPromise !== undefined) {
                                                                playPromise.then(() => {
                                                                    console.log('[Mobile Audio Fix] éŸ³ä¹æ’­æ”¾æˆåŠŸ');
                                                                }).catch(err => {
                                                                    console.error('[Mobile Audio Fix] æ’­æ”¾å¤±è´¥:', err);
                                                                });
                                                            }
                                                        } else {
                                                            console.log('[Mobile Audio Fix] æš‚åœéŸ³ä¹');
                                                            music.pause();
                                                        }

                                                        // æ›´æ–°æŒ‰é’®å›¾æ ‡
                                                        const playIcon = document.getElementById('musicIconPlay');
                                                        const pauseIcon = document.getElementById('musicIconPause');
                                                        if (playIcon && pauseIcon) {
                                                            if (music.paused) {
                                                                playIcon.style.display = 'block';
                                                                pauseIcon.style.display = 'none';
                                                            } else {
                                                                playIcon.style.display = 'none';
                                                                pauseIcon.style.display = 'block';
                                                            }
                                                        }
                                                    };
                                                }

                                                // ç›‘å¬nextSceneå‡½æ•°ï¼Œåœ¨åˆ‡æ¢åœºæ™¯æ—¶ä¹Ÿå°è¯•æ’­æ”¾éŸ³ä¹
                                                if (window.nextScene) {
                                                    const originalNextScene = window.nextScene;
                                                    window.nextScene = function() {
                                                        const result = originalNextScene.apply(this, arguments);

                                                        // å»¶è¿Ÿæ£€æŸ¥æ˜¯å¦éœ€è¦æ’­æ”¾æ–°éŸ³ä¹
                                                        setTimeout(() => {
                                                            if (hasInteracted) {
                                                                const music = document.getElementById('bgMusic');
                                                                if (music && music.src && !music.paused) {
                                                                    // å¦‚æœéŸ³ä¹æ­£åœ¨æ’­æ”¾ä½†è¢«é˜»æ­¢äº†ï¼Œé‡æ–°å°è¯•
                                                                    if (music.readyState > 0) {
                                                                        const playPromise = music.play();
                                                                        if (playPromise !== undefined) {
                                                                            playPromise.catch(err => {
                                                                                console.log('[Mobile Audio Fix] åœºæ™¯åˆ‡æ¢åéŸ³ä¹æ’­æ”¾å¤±è´¥:', err);
                                                                            });
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }, 100);

                                                        return result;
                                                    };
                                                }

                                                console.log('[Mobile Audio Fix] éŸ³é¢‘æ’­æ”¾æ”¯æŒå·²å®‰è£…');
                                            })();
                                        `;
                                        iframeWindow.document.body.appendChild(audioFix);
                                }
                            } catch (e) {
                                console.log('[iframe] æ— æ³•è®¿é—®iframeçª—å£:', e);
                            }
                        });

                        // ç›‘å¬åŠ è½½é”™è¯¯
                        iframe.addEventListener('error', function(e) {
                            console.error('[iframe] åŠ è½½é”™è¯¯:', e);
                            loadingIndicator.textContent = 'åŠ è½½å¤±è´¥';
                            loadingIndicator.style.color = 'red';
                        });

                        // ç­‰å¾…iframeåŠ è½½å®Œæˆåè°ƒæ•´é«˜åº¦
                        iframe.addEventListener('load', function() {
                            try {
                                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                if (iframeDoc && iframeDoc.body) {
                                    // æ³¨å…¥é€æ˜èƒŒæ™¯æ ·å¼
                                    injectTransparentStyles(iframeDoc);

                                    // ç­‰å¾…iframeå†…å®¹å®Œå…¨æ¸²æŸ“
                                    setTimeout(() => {
                                        try {
                                            const height = Math.max(
                                                iframeDoc.body.scrollHeight,
                                                iframeDoc.documentElement.scrollHeight,
                                                iframeDoc.body.offsetHeight,
                                                iframeDoc.documentElement.offsetHeight,
                                                400 // æœ€å°é«˜åº¦
                                            );
                                            console.log('[iframe] è°ƒæ•´é«˜åº¦ä¸º:', height);
                                            iframe.style.height = height + 'px';
                                            iframeContainer.style.minHeight = height + 'px';
                                        } catch (e) {
                                            console.log('[iframe] æ— æ³•è®¿é—®iframeé«˜åº¦:', e);
                                            // ä½¿ç”¨é»˜è®¤é«˜åº¦
                                            iframe.style.height = '600px';
                                        }
                                    }, 100);
                                }
                            } catch (e) {
                                console.log('[iframe] æ— æ³•è®¿é—®iframeæ–‡æ¡£:', e);
                                iframe.style.height = '600px';
                            }
                        });

                        iframeContainer.appendChild(iframe);
                        messageBubble.appendChild(iframeContainer);
                        messageBubble.className += ' p-0 overflow-hidden';
                    } else if (containsHTML(finalContent)) {
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«å®Œæ•´çš„HTMLæ–‡æ¡£
                        const hasFullHTMLDoc = /<!DOCTYPE|<html[^>]*>|<head[^>]*>|<body[^>]*>/i.test(finalContent);

                        if (hasFullHTMLDoc) {
                            // å¦‚æœåŒ…å«å®Œæ•´HTMLæ–‡æ¡£,å¯èƒ½æ˜¯æ–‡æœ¬+HTMLçš„æ··åˆå†…å®¹
                            // å°è¯•åˆ†ç¦»æ–‡æœ¬éƒ¨åˆ†å’ŒHTMLéƒ¨åˆ†
                            const htmlDocMatch = finalContent.match(/(<!DOCTYPE[\s\S]*|<html[\s\S]*)/i);

                            if (htmlDocMatch && htmlDocMatch.index > 0) {
                                // æœ‰æ–‡æœ¬éƒ¨åˆ†åœ¨HTMLä¹‹å‰
                                const textPart = finalContent.substring(0, htmlDocMatch.index).trim();
                                const htmlPart = htmlDocMatch[0];

                                // å¤„ç†æ–‡æœ¬éƒ¨åˆ† - è½¬æ¢æ¢è¡Œç¬¦
                                if (textPart) {
                                    const textDiv = document.createElement('div');
                                    textDiv.className = 'mb-4';
                                    const textWithBreaks = textPart
                                        .replace(/\r\n/g, '<br>')
                                        .replace(/\r/g, '<br>')
                                        .replace(/\n/g, '<br>');
                                    textDiv.innerHTML = textWithBreaks;
                                    messageBubble.appendChild(textDiv);
                                }

                                // å¤„ç†HTMLéƒ¨åˆ† - ä½¿ç”¨iframe
                                if (htmlPart) {
                                    const iframeContainer = document.createElement('div');
                                    iframeContainer.className = 'iframe-container mt-4';
                                    iframeContainer.style.cssText = 'width: 100%; position: relative; min-height: 400px; background: transparent;';

                                    const iframe = document.createElement('iframe');
                                    iframe.className = 'rendered-html-iframe';
                                    iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox';
                                    iframe.style.cssText = 'width: 100%; border: none; display: block; background: transparent; min-height: 400px;';

                                    iframe.srcdoc = htmlPart;

                                    // ç›‘å¬iframeåŠ è½½å®Œæˆåè°ƒæ•´é«˜åº¦
                                    iframe.addEventListener('load', function() {
                                        try {
                                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                            if (iframeDoc && iframeDoc.body) {
                                                // æ³¨å…¥CSSä½¿ç™½è‰²èƒŒæ™¯é€æ˜
                                                injectTransparentStyles(iframeDoc);

                                                setTimeout(() => {
                                                    try {
                                                        const height = Math.max(
                                                            iframeDoc.body.scrollHeight,
                                                            iframeDoc.documentElement.scrollHeight,
                                                            400
                                                        );
                                                        iframe.style.height = height + 'px';
                                                        iframeContainer.style.minHeight = height + 'px';
                                                    } catch (e) {
                                                        iframe.style.height = '600px';
                                                    }
                                                }, 100);
                                            }
                                        } catch (e) {
                                            iframe.style.height = '600px';
                                        }
                                    });

                                    iframeContainer.appendChild(iframe);
                                    messageBubble.appendChild(iframeContainer);
                                    messageBubble.className += ' p-0 overflow-hidden';
                                }
                            } else {
                                // æ•´ä¸ªå†…å®¹éƒ½æ˜¯HTMLæ–‡æ¡£,ä½¿ç”¨åŸæœ‰çš„iframeæ¸²æŸ“é€»è¾‘
                                const iframeContainer = document.createElement('div');
                                iframeContainer.className = 'iframe-container';
                                iframeContainer.style.cssText = 'width: 100%; position: relative; min-height: 400px; background: transparent;';

                                const iframe = document.createElement('iframe');
                                iframe.className = 'rendered-html-iframe';
                                iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox';
                                iframe.style.cssText = 'width: 100%; border: none; display: block; background: transparent; min-height: 400px;';
                                iframe.srcdoc = finalContent;

                                // ç›‘å¬iframeåŠ è½½å®Œæˆåæ³¨å…¥é€æ˜æ ·å¼
                                iframe.addEventListener('load', function() {
                                    try {
                                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                        if (iframeDoc) {
                                            injectTransparentStyles(iframeDoc);
                                        }
                                    } catch (e) {
                                        console.log('[iframe] æ— æ³•æ³¨å…¥é€æ˜æ ·å¼:', e);
                                    }
                                });

                                iframeContainer.appendChild(iframe);
                                messageBubble.appendChild(iframeContainer);
                                messageBubble.className += ' p-0 overflow-hidden';
                            }
                        } else {
                            // ä¸æ˜¯å®Œæ•´HTMLæ–‡æ¡£,æ£€æŸ¥æ˜¯å¦åŒ…å«éœ€è¦iframeçš„ç‰¹æ®Šå…ƒç´ 
                            const needsIframe = /<audio[^>]*>/i.test(finalContent) ||
                                              /<video[^>]*>/i.test(finalContent) ||
                                              /<iframe[^>]*>/i.test(finalContent) ||
                                              /<script[^>]*>/i.test(finalContent);

                            if (needsIframe) {
                                // ä½¿ç”¨iframeæ¸²æŸ“
                                const iframeContainer = document.createElement('div');
                                iframeContainer.className = 'iframe-container';
                                iframeContainer.style.cssText = 'width: 100%; position: relative; min-height: 400px; background: transparent;';

                                const iframe = document.createElement('iframe');
                                iframe.className = 'rendered-html-iframe';
                                iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox';
                                iframe.style.cssText = 'width: 100%; border: none; display: block; background: transparent; min-height: 400px;';

                                // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
                                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                                let loadSuccess = false;

                                // PCç«¯ä¼˜å…ˆä½¿ç”¨Blob URL
                                if (!isMobile) {
                                    try {
                                        const blob = new Blob([finalContent], { type: 'text/html; charset=utf-8' });
                                        const blobUrl = URL.createObjectURL(blob);
                                        iframe.src = blobUrl;

                                        iframe.addEventListener('load', function() {
                                            setTimeout(() => {
                                                URL.revokeObjectURL(blobUrl);
                                            }, 1000);
                                        });

                                        loadSuccess = true;
                                    } catch (e) {
                                        console.error('[iframe] Blob URLåŠ è½½å¤±è´¥:', e);
                                    }
                                }

                                // ç§»åŠ¨ç«¯æˆ–å¤±è´¥æ—¶ä½¿ç”¨srcdoc
                                if (!loadSuccess) {
                                    iframe.srcdoc = finalContent;
                                }

                                // ç›‘å¬iframeå†…éƒ¨é”™è¯¯
                                iframe.addEventListener('load', function() {
                                    try {
                                    const iframeWindow = iframe.contentWindow;
                                    if (iframeWindow) {
                                        // æ³¨å…¥é€æ˜èƒŒæ™¯æ ·å¼
                                        const iframeDoc = iframe.contentDocument || iframeWindow.document;
                                        injectTransparentStyles(iframeDoc);

                                        iframeWindow.addEventListener('error', function(event) {
                                            console.error('[iframe] å†…éƒ¨é”™è¯¯:', event.error || event.message);
                                        });
                                        iframeWindow.addEventListener('unhandledrejection', function(event) {
                                            console.error('[iframe] Promiseé”™è¯¯:', event.reason);
                                        });

                                        // éŸ³é¢‘æ’­æ”¾ä¿®å¤ï¼ˆç§»åŠ¨ç«¯å’ŒPCç«¯ï¼‰
                                        console.log('[iframe] æ³¨å…¥éŸ³é¢‘æ’­æ”¾æ”¯æŒä»£ç ');

                                        const audioFix = iframeWindow.document.createElement('script');
                                        audioFix.textContent = `
                                                (function() {
                                                    console.log('[Mobile Audio Fix] åˆå§‹åŒ–ç§»åŠ¨ç«¯éŸ³é¢‘æ”¯æŒ');

                                                    let hasInteracted = false;

                                                    function markInteraction() {
                                                        if (hasInteracted) return;
                                                        hasInteracted = true;
                                                        console.log('[Mobile Audio Fix] ç”¨æˆ·å·²äº¤äº’ï¼ŒéŸ³é¢‘å·²è§£é”');
                                                        tryPlayMusic();
                                                    }

                                                    function tryPlayMusic() {
                                                        if (!hasInteracted) return;

                                                        const bgmPlayer = document.getElementById('bgMusic');
                                                        if (!bgmPlayer) return;

                                                        if (bgmPlayer.paused && bgmPlayer.src && bgmPlayer.src !== window.location.href) {
                                                            bgmPlayer.play().catch(e => console.error("Autoplay prevent after interaction:", e));
                                                        }
                                                    }

                                                    // åœ¨ç¬¬ä¸€æ¬¡ç”¨æˆ·äº¤äº’æ—¶è§£é”ï¼ˆä½¿ç”¨æ•è·é˜¶æ®µï¼‰
                                                    document.addEventListener('click', (e) => {
                                                        markInteraction();
                                                    }, true);

                                                    document.addEventListener('touchend', (e) => {
                                                        markInteraction();
                                                    }, true);

                                                    if (window.toggleMusic) {
                                                        const originalToggleMusic = window.toggleMusic;
                                                        window.toggleMusic = function() {
                                                            markInteraction();
                                                            console.log('[Mobile Audio Fix] toggleMusic è¢«è°ƒç”¨');

                                                            const music = document.getElementById('bgMusic');
                                                            if (!music) {
                                                                console.log('[Mobile Audio Fix] æœªæ‰¾åˆ°bgMusicå…ƒç´ ');
                                                                return;
                                                            }

                                                            if (!music.src || music.src === window.location.href) {
                                                                console.log('[Mobile Audio Fix] éŸ³ä¹æºæœªè®¾ç½®');
                                                                return;
                                                            }

                                                            if (music.paused) {
                                                                console.log('[Mobile Audio Fix] å°è¯•æ’­æ”¾éŸ³ä¹:', music.src);
                                                                const playPromise = music.play();
                                                                if (playPromise !== undefined) {
                                                                    playPromise.then(() => {
                                                                        console.log('[Mobile Audio Fix] éŸ³ä¹æ’­æ”¾æˆåŠŸ');
                                                                    }).catch(err => {
                                                                        console.error('[Mobile Audio Fix] æ’­æ”¾å¤±è´¥:', err);
                                                                    });
                                                                }
                                                            } else {
                                                                console.log('[Mobile Audio Fix] æš‚åœéŸ³ä¹');
                                                                music.pause();
                                                            }

                                                            const playIcon = document.getElementById('musicIconPlay');
                                                            const pauseIcon = document.getElementById('musicIconPause');
                                                            if (playIcon && pauseIcon) {
                                                                if (music.paused) {
                                                                    playIcon.style.display = 'block';
                                                                    pauseIcon.style.display = 'none';
                                                                } else {
                                                                    playIcon.style.display = 'none';
                                                                    pauseIcon.style.display = 'block';
                                                                }
                                                            }
                                                        };
                                                    }

                                                    if (window.nextScene) {
                                                        const originalNextScene = window.nextScene;
                                                        window.nextScene = function() {
                                                            const result = originalNextScene.apply(this, arguments);

                                                            setTimeout(() => {
                                                                if (hasInteracted) {
                                                                    const music = document.getElementById('bgMusic');
                                                                    if (music && music.src && !music.paused) {
                                                                        if (music.readyState > 0) {
                                                                            const playPromise = music.play();
                                                                            if (playPromise !== undefined) {
                                                                                playPromise.catch(err => {
                                                                                    console.log('[Mobile Audio Fix] åœºæ™¯åˆ‡æ¢åéŸ³ä¹æ’­æ”¾å¤±è´¥:', err);
                                                                                });
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }, 100);

                                                            return result;
                                                        };
                                                    }

                                                    console.log('[Mobile Audio Fix] éŸ³é¢‘æ’­æ”¾æ”¯æŒå·²å®‰è£…');
                                                })();
                                            `;
                                            iframeWindow.document.body.appendChild(audioFix);
                                    }
                                } catch (e) {
                                    console.log('[iframe] æ— æ³•è®¿é—®iframeçª—å£:', e);
                                }
                            });

                                iframe.addEventListener('load', function() {
                                    try {
                                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                        if (iframeDoc && iframeDoc.body) {
                                            // æ³¨å…¥é€æ˜èƒŒæ™¯æ ·å¼
                                            injectTransparentStyles(iframeDoc);

                                            setTimeout(() => {
                                                try {
                                                    const height = Math.max(
                                                        iframeDoc.body.scrollHeight,
                                                        iframeDoc.documentElement.scrollHeight,
                                                        iframeDoc.body.offsetHeight,
                                                        iframeDoc.documentElement.offsetHeight,
                                                        400
                                                    );
                                                    iframe.style.height = height + 'px';
                                                    iframeContainer.style.minHeight = height + 'px';
                                                } catch (e) {
                                                    console.log('[iframe] æ— æ³•è®¿é—®iframeé«˜åº¦:', e);
                                                    iframe.style.height = '600px';
                                                }
                                            }, 100);
                                        }
                                    } catch (e) {
                                        console.log('[iframe] æ— æ³•è®¿é—®iframeæ–‡æ¡£:', e);
                                        iframe.style.height = '600px';
                                    }
                                });

                                iframeContainer.appendChild(iframe);
                                messageBubble.appendChild(iframeContainer);
                                messageBubble.className += ' p-0 overflow-hidden';
                            } else {
                                // å¦‚æœregexæ›¿æ¢ååŒ…å«HTMLæ ‡ç­¾,éœ€è¦ç‰¹æ®Šå¤„ç†<style>æ ‡ç­¾
                                // æ£€æŸ¥æ˜¯å¦åŒ…å«<style>æ ‡ç­¾
                                const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
                                const styles = [];
                                let match;

                                // æå–æ‰€æœ‰<style>æ ‡ç­¾å†…å®¹
                                while ((match = styleRegex.exec(finalContent)) !== null) {
                                    styles.push(match[1]);
                                }

                                if (styles.length > 0) {
                                    // å¦‚æœæœ‰æ ·å¼,ç§»é™¤åŸå†…å®¹ä¸­çš„<style>æ ‡ç­¾
                                    const contentWithoutStyles = finalContent.replace(styleRegex, '');

                                    // åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„æ ·å¼å®¹å™¨ID
                                    const styleId = `style-${id}`;

                                    // åˆ›å»ºå¹¶æ’å…¥<style>å…ƒç´ åˆ°æ–‡æ¡£å¤´éƒ¨
                                    const styleElement = document.createElement('style');
                                    styleElement.id = styleId;
                                    styleElement.textContent = styles.join('\n');
                                    document.head.appendChild(styleElement);

                                    // æ’å…¥ä¸å«<style>çš„HTMLå†…å®¹
                                    // å…ˆè½¬æ¢æ‰€æœ‰ç±»å‹çš„æ¢è¡Œç¬¦ä¸º<br>æ ‡ç­¾,ç¡®ä¿æ¢è¡Œè¢«ä¿ç•™
                                    // å¤„ç† \r\n (Windows), \n (Unix/Linux), \r (Mac)
                                    const contentWithBreaks = contentWithoutStyles
                                        .replace(/\r\n/g, '<br>')  // Windowsæ¢è¡Œ
                                        .replace(/\r/g, '<br>')    // Macæ¢è¡Œ
                                        .replace(/\n/g, '<br>');   // Unix/Linuxæ¢è¡Œ
                                    contentDiv.innerHTML = contentWithBreaks;
                                    contentDiv.setAttribute('data-style-id', styleId);
                                } else {
                                    // æ²¡æœ‰æ ·å¼,ç›´æ¥ä½¿ç”¨innerHTML
                                    // å…ˆè½¬æ¢æ‰€æœ‰ç±»å‹çš„æ¢è¡Œç¬¦ä¸º<br>æ ‡ç­¾,ç¡®ä¿æ¢è¡Œè¢«ä¿ç•™
                                    const contentWithBreaks = finalContent
                                        .replace(/\r\n/g, '<br>')  // Windowsæ¢è¡Œ
                                        .replace(/\r/g, '<br>')    // Macæ¢è¡Œ
                                        .replace(/\n/g, '<br>');   // Unix/Linuxæ¢è¡Œ
                                    contentDiv.innerHTML = contentWithBreaks;
                                }

                                messageBubble.appendChild(contentDiv);
                            }
                        }
                    } else {
                        // å¦åˆ™ä½¿ç”¨textContentä¿æŒçº¯æ–‡æœ¬,ä¿ç•™æ¢è¡Œ
                        contentDiv.textContent = finalContent;
                        messageBubble.appendChild(contentDiv);
                    }
                } else if (type === 'image') {
                    messageBubble.className += ' image-bubble';
                    // ä½¿ç”¨imageUrlæ˜¾ç¤ºå›¾ç‰‡ï¼ˆç¼©ç•¥å›¾ï¼‰ï¼Œå¹¶åœ¨ä¸‹æ–¹æ˜¾ç¤ºAIè¯†åˆ«çš„æè¿°
                    const imgSrc = imageUrl || content; // å…¼å®¹æ—§æ•°æ®
                    messageBubble.innerHTML += `
                        <div class="image-message">
                            <img src="${imgSrc}" alt="image" onclick="showImagePreview('${imgSrc}')">
                            ${description ? `<div style="padding: 8px; font-size: 13px; color: var(--text-secondary-color); border-top: 1px solid var(--border-color); margin-top: 8px; background: rgba(0,0,0,0.02);">
                                <i class="fas fa-robot" style="margin-right: 4px;"></i>${description}
                            </div>` : ''}
                        </div>
                    `;
                }

                messageContentContainer.appendChild(messageBubble);

                group.appendChild(messageContentContainer);
                chatMessages.appendChild(group);
            }

            async function deleteMessage(id) {
                const messageIndex = chatHistory.findIndex(m => m.id === id);
                if (messageIndex > -1) {
                    chatHistory.splice(messageIndex, 1);
                    const messageElement = document.getElementById(id);

                    // æ¸…ç†è¯¥æ¶ˆæ¯æ³¨å…¥çš„æ ·å¼
                    const styleId = `style-${id}`;
                    const styleElement = document.getElementById(styleId);
                    if (styleElement) {
                        styleElement.remove();
                    }

                    messageElement?.remove();

                    // ä¿å­˜æ›´æ–°åçš„èŠå¤©è®°å½•
                    if (char.activeCharacterId) {
                        await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                    }
                }
            }

            // æ¶ˆæ¯ç¼–è¾‘åŠŸèƒ½
            let currentEditingMessageId = null;

            function startEditMessage(messageId) {
                const message = chatHistory.find(m => m.id === messageId);
                if (!message || message.type !== 'text') return;

                currentEditingMessageId = messageId;

                // å¡«å……å¼¹çª—å†…å®¹
                document.getElementById('edit-message-textarea').value = message.content;

                // æ˜¾ç¤ºå¼¹çª—
                document.getElementById('message-edit-modal').classList.add('active');
            }

            function saveEditMessage(messageId, newContent) {
                if (!messageId) messageId = currentEditingMessageId;
                const message = chatHistory.find(m => m.id === messageId);
                if (!message) return;

                const trimmedContent = newContent.trim();
                if (!trimmedContent) {
                    alert('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                    return;
                }

                // æ›´æ–°å†å²è®°å½•
                message.content = trimmedContent;

                // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
                const messageElement = document.getElementById(messageId);
                if (messageElement) {
                    const bubble = messageElement.querySelector('.chat-bubble');
                    const contentDiv = bubble.querySelector('.message-content');

                    if (contentDiv) {
                        // åªå¯¹AIæ¶ˆæ¯åº”ç”¨regex
                        let processedContent = trimmedContent;
                        if (message.role === 'assistant') {
                            processedContent = applyRegex(trimmedContent);
                        }

                        // å¦‚æœåŒ…å«HTML,ä½¿ç”¨innerHTML;å¦åˆ™ä½¿ç”¨textContent
                        if (containsHTML(processedContent)) {
                            // è½¬æ¢æ‰€æœ‰ç±»å‹çš„æ¢è¡Œç¬¦ä¸º<br>æ ‡ç­¾
                            const contentWithBreaks = processedContent
                                .replace(/\r\n/g, '<br>')
                                .replace(/\r/g, '<br>')
                                .replace(/\n/g, '<br>');
                            contentDiv.innerHTML = contentWithBreaks;
                        } else {
                            contentDiv.textContent = processedContent;
                        }
                        contentDiv.className = 'message-content text-left whitespace-pre-wrap';
                    }
                }

                // å…³é—­å¼¹çª—
                document.getElementById('message-edit-modal').classList.remove('active');
                currentEditingMessageId = null;

                // å¦‚æœç¼–è¾‘çš„æ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œæç¤ºæ˜¯å¦é‡æ–°ç”ŸæˆAIå›å¤
                if (message.role === 'user') {
                    const messageIndex = chatHistory.findIndex(m => m.id === messageId);
                    const nextMessage = chatHistory[messageIndex + 1];

                    if (nextMessage && nextMessage.role === 'assistant') {
                        if (confirm('ç”¨æˆ·æ¶ˆæ¯å·²ä¿®æ”¹ï¼Œæ˜¯å¦é‡æ–°ç”ŸæˆAIå›å¤ï¼Ÿ')) {
                            regenerateMessage(nextMessage.id);
                        }
                    }
                }
            }

            function cancelEditMessage() {
                const modal = document.getElementById('message-edit-modal');
                modal.classList.remove('active');
                // é‡ç½®æ‰©å¤§çŠ¶æ€
                modal.classList.remove('expanded');
                const icon = document.querySelector('#toggle-expand-edit-message i');
                if (icon) {
                    icon.classList.remove('fa-compress');
                    icon.classList.add('fa-expand');
                }
                currentEditingMessageId = null;
            }

            // ç»‘å®šç¼–è¾‘å¼¹çª—äº‹ä»¶
            document.getElementById('save-edit-message').addEventListener('click', () => {
                const newContent = document.getElementById('edit-message-textarea').value;
                saveEditMessage(currentEditingMessageId, newContent);
            });

            document.getElementById('cancel-edit-message').addEventListener('click', cancelEditMessage);
            document.getElementById('close-edit-message').addEventListener('click', cancelEditMessage);

            // æ‰©å¤§/ç¼©å°ç¼–è¾‘å¼¹çª—
            document.getElementById('toggle-expand-edit-message').addEventListener('click', () => {
                const modal = document.getElementById('message-edit-modal');
                const icon = document.querySelector('#toggle-expand-edit-message i');

                if (modal.classList.contains('expanded')) {
                    modal.classList.remove('expanded');
                    icon.classList.remove('fa-compress');
                    icon.classList.add('fa-expand');
                } else {
                    modal.classList.add('expanded');
                    icon.classList.remove('fa-expand');
                    icon.classList.add('fa-compress');
                }
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            document.getElementById('message-edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'message-edit-modal') {
                    cancelEditMessage();
                }
            });

            async function regenerateMessage(id) {
                const messageIndex = chatHistory.findIndex(m => m.id === id);
                if (messageIndex > -1 && chatHistory[messageIndex].role === 'assistant') {
                    // Temporarily remove the message and any subsequent messages for the API call
                    chatHistory.splice(messageIndex);
                    // Re-render the UI to reflect this
                    const messagesToRemove = Array.from(chatMessages.children).slice(messageIndex);
                    messagesToRemove.forEach(el => el.remove());
                    // Send the shortened history to the API
                    await sendApiRequest();
                }
            }

            // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.startEditMessage = startEditMessage;
            window.saveEditMessage = saveEditMessage;
            window.cancelEditMessage = cancelEditMessage;
            
            async function constructFinalPrompt() {
                const character = char.activeCharacterId ? char.data[char.activeCharacterId] : null;
                const currentPresetName = document.querySelector('.preset-item.active')?.dataset.name || 'é»˜è®¤';
                const presets = await getPresets();
                const preset = presets[currentPresetName] || presets['é»˜è®¤'];

                // è·å–å½“å‰ç”¨æˆ·è®¾ç½®
                const currentUser = userManagement.getCurrentUser();

                let messages = [];
                let systemPromptParts = [];

                // 1. æ·»åŠ ç”¨æˆ·çš„ç³»ç»Ÿæç¤ºè¯ï¼ˆå¦‚æœæœ‰ï¼‰
                if (currentUser?.systemPrompt) {
                    systemPromptParts.push(currentUser.systemPrompt);
                }

                // 2. æ”¶é›†é¢„è®¾ä¸­çš„ç³»ç»Ÿæç¤ºè¯
                if (preset?.prompts) {
                    preset.prompts.forEach(prompt => {
                        if (prompt.enabled && prompt.role === 'system') {
                            if (prompt.identifier === 'main' && prompt.content) {
                                systemPromptParts.push(prompt.content);
                            } else if (prompt.identifier === 'personaDescription') {
                                // ä½¿ç”¨å½“å‰ç”¨æˆ·çš„æè¿°
                                if (currentUser?.description) {
                                    systemPromptParts.push(`User: ${currentUser.name}\n${currentUser.description}`);
                                }
                            } else if (prompt.identifier === 'charDescription' && character) {
                                systemPromptParts.push(`Character: ${character.name}\n${character.description || ''}`);
                            } else if (prompt.identifier === 'charPersonality' && character?.personality) {
                                systemPromptParts.push(`Personality: ${character.personality}`);
                            } else if (prompt.identifier === 'scenario' && character?.scenario) {
                                systemPromptParts.push(`Scenario: ${character.scenario}`);
                            } else if (prompt.content && !prompt.marker) {
                                systemPromptParts.push(prompt.content);
                            }
                        }
                    });
                }

                // 3. æ·»åŠ è§’è‰²åŸºæœ¬ä¿¡æ¯ï¼ˆå¦‚æœé¢„è®¾ä¸­æ²¡æœ‰ï¼‰
                if (character && systemPromptParts.length === 0) {
                    systemPromptParts.push(`You are ${character.name}. ${character.description || ''}`);
                }

                // 4. æ”¶é›†å¹¶åº”ç”¨ä¸–ç•Œä¹¦æ¡ç›®
                let worldInfoContent = [];

                // æ”¶é›†å…¨å±€ä¸–ç•Œä¹¦
                const selectedWorld = wi.worldSelect?.value;
                if (selectedWorld && selectedWorld !== 'char_book' && wi.data[selectedWorld]) {
                    const worldEntries = wi.data[selectedWorld];
                    worldEntries.forEach(entry => {
                        if (entry.enabled) {
                            // æ£€æŸ¥å…³é”®è¯åŒ¹é…
                            const keys = Array.isArray(entry.keys) ? entry.keys : (entry.keys || '').split(',').map(k => k.trim());
                            let shouldInclude = entry.constant || false; // constant æ¡ç›®æ€»æ˜¯åŒ…å«

                            if (!shouldInclude) {
                                // æ£€æŸ¥æ˜¯å¦æœ‰å…³é”®è¯åœ¨èŠå¤©å†å²ä¸­ï¼ˆè·³è¿‡éšè—çš„æ¶ˆæ¯ï¼‰
                                const recentMessages = chatHistory.filter(m => !m.hidden).slice(-10).map(m => m.content).join(' ');
                                const allContext = systemPromptParts.join(' ') + ' ' + recentMessages;

                                for (const key of keys) {
                                    if (key && allContext.toLowerCase().includes(key.toLowerCase())) {
                                        shouldInclude = true;
                                        break;
                                    }
                                }
                            }

                            if (shouldInclude && entry.content) {
                                worldInfoContent.push(entry.content);
                            }
                        }
                    });
                }

                // æ”¶é›†è§’è‰²ä¸–ç•Œä¹¦
                console.log('[ä¸–ç•Œä¹¦] æ£€æŸ¥è§’è‰²ä¸–ç•Œä¹¦:', {
                    hasCharacter: !!character,
                    hasCharacterBook: !!character?.data?.character_book,
                    hasEntries: !!character?.data?.character_book?.entries,
                    entriesCount: character?.data?.character_book?.entries?.length || 0
                });

                if (character?.data?.character_book?.entries) {
                    console.log('[ä¸–ç•Œä¹¦] è§’è‰²ä¸–ç•Œä¹¦æ¡ç›®:', character.data.character_book.entries);

                    character.data.character_book.entries.forEach((entry, index) => {
                        console.log(`[ä¸–ç•Œä¹¦] å¤„ç†æ¡ç›® ${index}:`, {
                            enabled: entry.enabled,
                            constant: entry.constant,
                            keys: entry.keys,
                            contentPreview: entry.content?.substring(0, 50)
                        });

                        if (entry.enabled !== false) {
                            const keys = Array.isArray(entry.keys) ? entry.keys : (entry.keys || '').split(',').map(k => k.trim());
                            let shouldInclude = entry.constant || false;

                            if (!shouldInclude) {
                                // æ£€æŸ¥æ˜¯å¦æœ‰å…³é”®è¯åœ¨èŠå¤©å†å²ä¸­ï¼ˆè·³è¿‡éšè—çš„æ¶ˆæ¯ï¼‰
                                const recentMessages = chatHistory.filter(m => !m.hidden).slice(-10).map(m => m.content).join(' ');
                                const allContext = systemPromptParts.join(' ') + ' ' + recentMessages;

                                for (const key of keys) {
                                    if (key && allContext.toLowerCase().includes(key.toLowerCase())) {
                                        console.log(`[ä¸–ç•Œä¹¦] æ¡ç›® ${index} åŒ¹é…å…³é”®è¯: ${key}`);
                                        shouldInclude = true;
                                        break;
                                    }
                                }
                            }

                            if (shouldInclude && entry.content) {
                                console.log(`[ä¸–ç•Œä¹¦] æ·»åŠ æ¡ç›® ${index} åˆ°æç¤ºè¯`);
                                worldInfoContent.push(entry.content);
                            } else {
                                console.log(`[ä¸–ç•Œä¹¦] è·³è¿‡æ¡ç›® ${index} (shouldInclude: ${shouldInclude}, hasContent: ${!!entry.content})`);
                            }
                        }
                    });
                }

                // 5. ç»„åˆç³»ç»Ÿæç¤ºè¯
                if (worldInfoContent.length > 0) {
                    console.log('[ä¸–ç•Œä¹¦] æ·»åŠ åˆ°ç³»ç»Ÿæç¤ºè¯ï¼Œæ€»è®¡æ¡ç›®æ•°:', worldInfoContent.length);
                    systemPromptParts.push('\nWorld Information:\n' + worldInfoContent.join('\n'));
                } else {
                    console.log('[ä¸–ç•Œä¹¦] æ²¡æœ‰ä¸–ç•Œä¹¦æ¡ç›®è¢«æ·»åŠ ');
                }

                if (systemPromptParts.length > 0) {
                    messages.push({ role: 'system', content: systemPromptParts.join('\n\n') });
                }

                // 6. å¦‚æœç”¨æˆ·è®¾ç½®äº†è‡ªåŠ¨å‘é€ç”¨æˆ·æè¿°ï¼Œåœ¨ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶å‘é€
                if (currentUser?.autoAnnounce && chatHistory.length === 0 && currentUser.description) {
                    messages.push({ role: 'user', content: `æˆ‘æ˜¯${currentUser.name}ã€‚${currentUser.description}` });
                }

                // 7. æ·»åŠ ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆå¦‚æœæ˜¯æ–°å¯¹è¯ï¼‰
                if (chatHistory.length === 1 && character?.first_mes && chatHistory[0].role === 'assistant') {
                    // ç¬¬ä¸€æ¡æ¶ˆæ¯å·²ç»åœ¨èŠå¤©å†å²ä¸­
                } else if (chatHistory.length === 0 && character?.first_mes) {
                    messages.push({ role: 'assistant', content: character.first_mes });
                }

                // 8. æ·»åŠ èŠå¤©å†å²ï¼ˆåº”ç”¨æ­£åˆ™æ›¿æ¢ï¼Œè·³è¿‡éšè—çš„æ¶ˆæ¯ï¼‰
                chatHistory.forEach(msg => {
                    // è·³è¿‡éšè—çš„æ¶ˆæ¯
                    if (msg.hidden) return;

                    // å¤„ç†å›¾ç‰‡æ¶ˆæ¯ - ä½¿ç”¨æè¿°æ–‡å­—æ›¿ä»£å›¾ç‰‡ï¼ˆä¸å‘é€base64æ•°æ®ï¼‰
                    if (msg.type === 'image') {
                        messages.push({
                            role: msg.role,
                            content: msg.description || '[å›¾ç‰‡å†…å®¹]'
                        });
                    } else {
                        // æ–‡æœ¬æ¶ˆæ¯
                        let processedContent = msg.content;

                        // åº”ç”¨æ­£åˆ™è¡¨è¾¾å¼
                        if (msg.role === 'user') {
                            // å¯¹ç”¨æˆ·è¾“å…¥åº”ç”¨æ­£åˆ™
                            processedContent = applyRegex(processedContent);
                        }

                        messages.push({
                            role: msg.role,
                            content: processedContent
                        });
                    }
                });

                // 9. ä¿å­˜æ„å»ºçš„æç¤ºè¯ä¾›æŸ¥çœ‹
                window.lastConstructedPrompt = messages;
                updatePromptPreview(messages);

                return messages;
            }

            async function sendApiRequest() {
                const apiConfig = getCurrentApiConfig();
                if (!apiConfig?.url || !apiConfig?.key || !apiConfig.model) {
                    addMessageToHistory({role: 'assistant', content: 'é”™è¯¯: API è®¾ç½®ä¸å®Œæ•´ã€‚è¯·åœ¨APIè®¾ç½®ä¸­é…ç½® URL, Key, å’Œæ¨¡å‹ã€‚', type: 'text'});
                    return;
                }

                const messages = await constructFinalPrompt();
                if (messages.length === 0) return;

                sendButton.disabled = true;
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    const urlObj = new URL(apiConfig.url);
                    let endpoint = `${apiConfig.url.replace(/\/$/, '')}/chat/completions`;
                    let headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiConfig.key}`
                    };

                    // è·å–å½“å‰é¢„è®¾å‚æ•°
                    const currentPreset = document.querySelector('.preset-item.active')?.dataset.name;
                    const presets = getPresets();
                    const preset = presets[currentPreset] || presets['é»˜è®¤'];

                    let body = {
                        model: apiConfig.model,
                        messages: messages,
                        stream: apiConfig.streaming || false,
                        temperature: preset?.temp || 0.7,
                        top_p: preset?.top_p || 1,
                        frequency_penalty: preset?.freq_pen || 0,
                        presence_penalty: preset?.pres_pen || 0,
                        max_tokens: preset?.max_tokens || 1024,
                    };

                    if(urlObj.hostname.includes('google')) {
                        endpoint = `${urlObj.origin}/v1beta/models/${apiConfig.model}:generateContent?key=${apiConfig.key}`;
                        delete headers.Authorization;

                        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯åˆ°ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
                        const systemMessage = messages.find(m => m.role === 'system');
                        const userMessages = messages.filter(m => m.role !== 'system');

                        if (systemMessage && userMessages.length > 0) {
                            userMessages[0].content = systemMessage.content + '\n\n' + userMessages[0].content;
                        }

                        body = {
                            contents: userMessages.map(m => ({
                                role: m.role === 'assistant' ? 'model' : 'user',
                                parts: [{ text: m.content }]
                            })),
                            generationConfig: {
                                temperature: preset?.temp || 0.7,
                                topP: preset?.top_p || 1,
                                maxOutputTokens: preset?.max_tokens || 1024,
                            }
                        };
                    }

                    // å¤„ç†æµå¼å“åº”
                    if (apiConfig.streaming && !urlObj.hostname.includes('google')) {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(body)
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error?.message || `HTTP Error ${response.status}`);
                        }

                        // åˆ›å»ºAIæ¶ˆæ¯å¹¶è·å–å…¶ID
                        const messageId = `msg_${Date.now()}`;
                        const aiMessage = { id: messageId, role: 'assistant', content: '', type: 'text' };
                        chatHistory.push(aiMessage);

                        // æ¸²æŸ“åˆå§‹çš„ç©ºæ¶ˆæ¯
                        renderMessage(aiMessage);
                        const messageElement = document.getElementById(messageId);
                        const contentDiv = messageElement.querySelector('.chat-bubble .message-content');
                        if (contentDiv) {
                            contentDiv.className = 'message-content text-left whitespace-pre-wrap';
                        }

                        // å¤„ç†æµå¼æ•°æ®
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let fullContent = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value, { stream: true });
                            const lines = chunk.split('\n').filter(line => line.trim() !== '');

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const data = line.slice(6);
                                    if (data === '[DONE]') continue;

                                    try {
                                        const json = JSON.parse(data);
                                        const delta = json.choices?.[0]?.delta?.content;
                                        if (delta) {
                                            fullContent += delta;
                                            contentDiv.textContent = fullContent;
                                            chatMessages.scrollTop = chatMessages.scrollHeight;
                                        }
                                    } catch (e) {
                                        // å¿½ç•¥è§£æé”™è¯¯
                                    }
                                }
                            }
                        }

                        // æ›´æ–°å†å²è®°å½•ä¸­çš„å†…å®¹
                        aiMessage.content = fullContent;

                        // æµå¼æ¸²æŸ“å®Œæˆå,é‡æ–°æ¸²æŸ“æ¶ˆæ¯ä»¥åº”ç”¨regexå’ŒHTMLå¤„ç†
                        if (messageElement) {
                            // ç§»é™¤æ—§çš„æ¶ˆæ¯å…ƒç´ 
                            messageElement.remove();
                            // é‡æ–°æ¸²æŸ“åº”ç”¨regexåçš„æ¶ˆæ¯
                            renderMessage(aiMessage);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }

                    } else {
                        // éæµå¼å“åº”
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(body)
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error?.message || `HTTP Error ${response.status}`);
                        }

                        const data = await response.json();
                        let aiContent = '';
                        if (data.choices) { // OpenAI format
                           aiContent = data.choices[0].message.content;
                        } else if (data.candidates) { // Gemini format
                           aiContent = data.candidates[0].content.parts[0].text;
                        }
                        addMessageToHistory({role: 'assistant', content: aiContent, type: 'text'});
                    }

                } catch (error) {
                    addMessageToHistory({role: 'assistant', content: `API Error: ${error.message}`, type: 'text'});
                    console.error("API Error:", error);
                } finally {
                    sendButton.disabled = false;
                    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                }
            }
            
            async function sendMessage() {
                const userInput = chatInput.value.trim();
                if (!userInput) return;
                
                if (!char.activeCharacterId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²!');
                    return;
                }
                
                addMessageToHistory({role: 'user', content: userInput, type: 'text', replyTo: currentReply});
                currentReply = null;
                document.getElementById('reply-status-container').innerHTML = '';
                
                chatInput.value = '';
                chatInput.style.height = 'auto'; // Reset height
                
                await sendApiRequest();
            }

            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = (chatInput.scrollHeight) + 'px';
            });
            
            window.regenerateMessage = regenerateMessage;
            window.deleteMessage = deleteMessage;
            window.showImagePreview = (src) => {
                 const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.inset = 0;
                modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '200';
                modal.innerHTML = `<img src="${src}" style="max-width: 90%; max-height: 90%;">`;
                modal.onclick = () => document.body.removeChild(modal);
                document.body.appendChild(modal);
            }

            // --- Chat Menu Logic ---
            const chatMenuBtn = document.getElementById('chat-menu-btn');
            const chatMenuPanel = document.getElementById('chat-menu-panel');
            const menuImageBtn = document.getElementById('menu-image-btn');
            const menuViewPromptBtn = document.getElementById('menu-view-prompt-btn');
            const menuNewChatBtn = document.getElementById('menu-new-chat-btn');
            const imageFileInput = document.getElementById('imageFileInput');

            // åˆ‡æ¢èœå•æ˜¾ç¤º
            chatMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                chatMenuPanel.classList.toggle('hidden');
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
            document.addEventListener('click', (e) => {
                if (!chatMenuPanel.contains(e.target) && e.target !== chatMenuBtn) {
                    chatMenuPanel.classList.add('hidden');
                }
            });

            // æŸ¥çœ‹æç¤ºè¯
            menuViewPromptBtn.addEventListener('click', () => {
                showPromptPreview();
                chatMenuPanel.classList.add('hidden');
            });

            // æ–°å¯¹è¯
            menuNewChatBtn.addEventListener('click', async () => {
                if (confirm('ç¡®å®šè¦å¼€å§‹æ–°å¯¹è¯å—ï¼Ÿå½“å‰èŠå¤©è®°å½•å°†è¢«æ¸…é™¤ã€‚')) {
                    console.log('[æ–°å¯¹è¯] å¼€å§‹æ¸…ç©ºèŠå¤©è®°å½•...');

                    // å…ˆä¿å­˜å½“å‰èŠå¤©è®°å½•
                    if (char.activeCharacterId && chatHistory.length > 0) {
                        await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                        console.log('[æ–°å¯¹è¯] å·²ä¿å­˜æ—§çš„èŠå¤©è®°å½•');
                    }

                    // æ¸…ç©ºèŠå¤©å¹¶é‡æ–°å¼€å§‹
                    startNewChat();
                    console.log('[æ–°å¯¹è¯] èŠå¤©å·²æ¸…ç©ºï¼Œå·²æ·»åŠ å¼€åœºç™½');

                    // ç«‹å³ä¿å­˜æ–°çš„ç©ºèŠå¤©è®°å½•
                    if (char.activeCharacterId) {
                        await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                        console.log('[æ–°å¯¹è¯] å·²ä¿å­˜æ–°çš„èŠå¤©è®°å½•');
                    }
                }
                chatMenuPanel.classList.add('hidden');
            });

            // å‘é€å›¾ç‰‡
            menuImageBtn.addEventListener('click', () => {
                imageFileInput.click();
                chatMenuPanel.classList.add('hidden');
            });

            imageFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const imageDataUrl = event.target.result;

                        // å…ˆæ·»åŠ å›¾ç‰‡æ¶ˆæ¯åˆ°å†å²(æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œä¿ç•™åŸå›¾ç”¨äºæ˜¾ç¤º)
                        const tempMessage = {
                            role: 'user',
                            content: '[å›¾ç‰‡]',
                            type: 'image',
                            imageUrl: imageDataUrl, // ä¿ç•™åŸå›¾URLç”¨äºå‰ç«¯æ˜¾ç¤º
                            description: 'æ­£åœ¨è¯†åˆ«å›¾ç‰‡...'
                        };
                        addMessageToHistory(tempMessage);

                        // è°ƒç”¨è¯†å›¾APIè·å–æè¿°
                        try {
                            console.log('[å›¾ç‰‡è¯†åˆ«] å¼€å§‹è°ƒç”¨è¯†å›¾API...');
                            const description = await analyzeImage(imageDataUrl);
                            console.log('[å›¾ç‰‡è¯†åˆ«] APIè¿”å›æˆåŠŸ:', description);

                            // æ›´æ–°æ¶ˆæ¯ï¼šåªä¿å­˜æè¿°å’Œæ˜¾ç¤ºç”¨çš„ç¼©ç•¥å›¾ï¼Œåˆ é™¤å¤§ä½“ç§¯çš„åŸå§‹base64
                            const lastMsg = chatHistory[chatHistory.length - 1];
                            if (!lastMsg) {
                                console.error('[å›¾ç‰‡è¯†åˆ«] æ— æ³•æ‰¾åˆ°æœ€åä¸€æ¡æ¶ˆæ¯');
                                return;
                            }

                            lastMsg.description = description;
                            lastMsg.content = `[å›¾ç‰‡] ${description}`; // å†…å®¹ç›´æ¥æ”¹ä¸ºæè¿°
                            // imageUrlä¿ç•™ç”¨äºæ˜¾ç¤ºï¼Œä½†æˆ‘ä»¬å°†åˆ›å»ºç¼©ç•¥å›¾ç‰ˆæœ¬
                            console.log('[å›¾ç‰‡è¯†åˆ«] å¼€å§‹åˆ›å»ºç¼©ç•¥å›¾...');
                            lastMsg.imageUrl = await createThumbnail(imageDataUrl, 300, 300);
                            console.log('[å›¾ç‰‡è¯†åˆ«] ç¼©ç•¥å›¾åˆ›å»ºå®Œæˆ');

                            await saveChat();

                            // é‡æ–°æ¸²æŸ“è¿™æ¡æ¶ˆæ¯
                            console.log('[å›¾ç‰‡è¯†åˆ«] é‡æ–°æ¸²æŸ“æ¶ˆæ¯...');
                            const messageElement = document.getElementById(lastMsg.id);
                            if (messageElement) {
                                messageElement.remove();
                            }
                            renderMessage(lastMsg);
                            chatMessages.scrollTop = chatMessages.scrollHeight;

                            console.log('[å›¾ç‰‡è¯†åˆ«] å®Œæ•´æµç¨‹æˆåŠŸ');
                        } catch (error) {
                            console.error('[å›¾ç‰‡è¯†åˆ«] å¤±è´¥:', error);
                            console.error('[å›¾ç‰‡è¯†åˆ«] é”™è¯¯è¯¦æƒ…:', error.message, error.stack);

                            const lastMsg = chatHistory[chatHistory.length - 1];
                            if (lastMsg) {
                                lastMsg.description = `å›¾ç‰‡è¯†åˆ«å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                                lastMsg.content = `å›¾ç‰‡è¯†åˆ«å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`;
                                lastMsg.imageUrl = await createThumbnail(imageDataUrl, 300, 300);
                                await saveChat();

                                // é‡æ–°æ¸²æŸ“è¿™æ¡æ¶ˆæ¯
                                const messageElement = document.getElementById(lastMsg.id);
                                if (messageElement) {
                                    messageElement.remove();
                                }
                                renderMessage(lastMsg);
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = ''; // é‡ç½®inputä»¥ä¾¿å¯ä»¥é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            });

            // åˆ›å»ºç¼©ç•¥å›¾å‡½æ•° - å‹ç¼©å›¾ç‰‡ä»¥å‡å°‘å­˜å‚¨ç©ºé—´
            async function createThumbnail(imageDataUrl, maxWidth = 300, maxHeight = 300) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // ä½¿ç”¨è¾ƒä½è´¨é‡å‹ç¼©ï¼Œè¿›ä¸€æ­¥å‡å°ä½“ç§¯
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = imageDataUrl;
                });
            }

            // å›¾ç‰‡è¯†åˆ«å‡½æ•° - å¸¦é‡è¯•å’Œè¯¦ç»†æ—¥å¿—
            async function analyzeImage(imageDataUrl, retryCount = 0) {
                const MAX_RETRIES = 2;
                console.log('[analyzeImage] å‡½æ•°å¼€å§‹æ‰§è¡Œï¼Œé‡è¯•æ¬¡æ•°:', retryCount);
                const apiConfig = getCurrentApiConfig();
                console.log('[analyzeImage] å½“å‰APIé…ç½®:', apiConfig);

                // æ£€æŸ¥è¯†å›¾APIé…ç½®
                if (!apiConfig?.visionUrl || !apiConfig?.visionKey || !apiConfig?.visionModel) {
                    const missingFields = [];
                    if (!apiConfig?.visionUrl) missingFields.push('è¯†å›¾API URL');
                    if (!apiConfig?.visionKey) missingFields.push('è¯†å›¾API Key');
                    if (!apiConfig?.visionModel) missingFields.push('è¯†å›¾æ¨¡å‹');
                    throw new Error(`è¯†å›¾APIé…ç½®ä¸å®Œæ•´ï¼Œç¼ºå°‘: ${missingFields.join(', ')}ã€‚\n\nè¯·åœ¨ä¾§è¾¹æ "APIè®¾ç½®"ä¸­é…ç½®è¯†å›¾APIã€‚`);
                }

                const endpoint = `${apiConfig.visionUrl.replace(/\/$/, '')}/chat/completions`;
                console.log('[analyzeImage] è¯·æ±‚ç«¯ç‚¹:', endpoint);
                console.log('[analyzeImage] åŸå§‹å›¾ç‰‡æ•°æ®é•¿åº¦:', imageDataUrl.length);

                // å¦‚æœå›¾ç‰‡å¤ªå¤§ï¼Œå…ˆå‹ç¼©ï¼ˆæŸäº›APIå¯¹base64å¤§å°æœ‰é™åˆ¶ï¼‰
                let processedImageUrl = imageDataUrl;
                if (imageDataUrl.length > 1024 * 1024) { // å¦‚æœè¶…è¿‡1MB
                    console.log('[analyzeImage] å›¾ç‰‡è¿‡å¤§ï¼Œå…ˆå‹ç¼©...');
                    processedImageUrl = await createThumbnail(imageDataUrl, 800, 800);
                    console.log('[analyzeImage] å‹ç¼©åå›¾ç‰‡æ•°æ®é•¿åº¦:', processedImageUrl.length);
                }

                const requestBody = {
                    model: apiConfig.visionModel,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: `Act as a professional image analyst. Your task is to write an exceptionally detailed visual description report for an image, avoiding all generalizations. Your description must be strictly based on the image's visual content, covering its subject, background, composition, lighting, and textures.

Ensure the final description is detailed, specific, and **at least 200 words long**.

You must structure your entire output strictly in the following format, without any additional introductory or concluding remarks:

ã€å›¾ç‰‡ä¿¡æ¯ã€‘
[Your detailed description here]`
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: processedImageUrl
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                };

                console.log('[analyzeImage] è¯·æ±‚ä½“ç»“æ„:', {
                    model: requestBody.model,
                    messagesCount: requestBody.messages.length,
                    contentCount: requestBody.messages[0].content.length,
                    imageUrlLength: processedImageUrl.length
                });

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiConfig.visionKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });

                    console.log('[analyzeImage] å“åº”çŠ¶æ€:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('[analyzeImage] APIé”™è¯¯å“åº”:', errorText);
                        let errorMsg = `HTTP ${response.status}`;
                        let shouldRetry = false;

                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMsg = errorJson.error?.message || errorJson.message || errorMsg;
                            console.error('[analyzeImage] è§£æåçš„é”™è¯¯:', errorJson);

                            // æ£€æŸ¥æ˜¯å¦åº”è¯¥é‡è¯•
                            if (response.status === 503 || response.status === 429 ||
                                (response.status === 500 && errorMsg.includes('overloaded'))) {
                                shouldRetry = true;
                            }
                        } catch (e) {
                            errorMsg += ': ' + errorText.substring(0, 200);
                        }

                        // å¦‚æœæ˜¯500é”™è¯¯ä¸”åŒ…å«ç‰¹å®šä¿¡æ¯ï¼Œè¯´æ˜APIä¸æ”¯æŒ
                        if (response.status === 500 && errorText.includes('map')) {
                            errorMsg = 'è¯¥APIæœåŠ¡ä¸æ”¯æŒè§†è§‰è¯†åˆ«åŠŸèƒ½ã€‚\n\nå»ºè®®ï¼š\n1. ä½¿ç”¨æ”¯æŒè§†è§‰çš„APIï¼ˆå¦‚ OpenAI gpt-4oï¼‰\n2. æˆ–è€…ä¸é…ç½®è¯†å›¾APIï¼ˆå›¾ç‰‡ä»å¯å‘é€ï¼Œä½†æ— AIæè¿°ï¼‰';
                            throw new Error(errorMsg);
                        }

                        // é‡è¯•é€»è¾‘
                        if (shouldRetry && retryCount < MAX_RETRIES) {
                            const delay = (retryCount + 1) * 2000; // 2ç§’ã€4ç§’
                            console.log(`[analyzeImage] å°†åœ¨${delay}msåé‡è¯•...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return analyzeImage(imageDataUrl, retryCount + 1);
                        }

                        throw new Error(errorMsg);
                    }

                    const data = await response.json();
                    console.log('[analyzeImage] APIå“åº”æ•°æ®:', data);

                    const content = data.choices?.[0]?.message?.content;
                    if (!content) {
                        console.error('[analyzeImage] æ— æ•ˆçš„å“åº”æ ¼å¼ï¼Œå®Œæ•´æ•°æ®:', JSON.stringify(data, null, 2));
                        throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæœªæ‰¾åˆ°contentå­—æ®µ');
                    }

                    return content;
                } catch (error) {
                    console.error('[analyzeImage] è¯·æ±‚å¼‚å¸¸:', error);
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥API URLæ˜¯å¦æ­£ç¡®');
                    }
                    throw error;
                }
            }

            // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
            function showImagePreview(imageSrc) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    cursor: pointer;
                    padding: 20px;
                `;

                const img = document.createElement('img');
                img.src = imageSrc;
                img.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                `;

                modal.appendChild(img);
                document.body.appendChild(modal);

                // ç‚¹å‡»å…³é—­
                modal.addEventListener('click', () => {
                    modal.remove();
                });

                // ESCé”®å…³é—­
                const closeOnEsc = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', closeOnEsc);
                    }
                };
                document.addEventListener('keydown', closeOnEsc);
            }

            // å¯¼å‡ºé…ç½®
            const menuExportConfigBtn = document.getElementById('menu-export-config-btn');
            menuExportConfigBtn.addEventListener('click', async () => {
                try {
                    console.log('å¼€å§‹å¯¼å‡ºé…ç½®...');

                    // æ”¶é›†æ‰€æœ‰é…ç½®æ•°æ®
                    const config = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        api: {
                            apiUrl: await idbStorage.getItem('api_url_v2') || '',
                            apiKey: await idbStorage.getItem('api_key_v2') || '',
                            model: await idbStorage.getItem('api_model_v2') || '',
                            visionUrl: await idbStorage.getItem('vision_url_v2') || '',
                            visionKey: await idbStorage.getItem('vision_key_v2') || '',
                            visionModel: await idbStorage.getItem('vision_model_v2') || ''
                        },
                        characters: char.data || {},
                        worldInfo: wi.data || {},
                        regex: regex.data || {},
                        presets: await getPresets() || {},
                        users: userManagement.users || {},
                        currentUserId: userManagement.currentUserId || null,
                        theme: {
                            primaryColor: await idbStorage.getItem('primary_color') || '',
                            customCSS: await idbStorage.getItem('custom_css') || ''
                        },
                        chatHistories: {}
                    };

                    console.log('é…ç½®æ•°æ®å·²æ”¶é›†');

                    // å¯¼å‡ºæ‰€æœ‰è§’è‰²çš„èŠå¤©è®°å½•
                    if (char.data && typeof char.data === 'object') {
                        for (const charId of Object.keys(char.data)) {
                            const history = await idbStorage.getItem(`chat_history_${charId}`);
                            if (history) {
                                try {
                                    config.chatHistories[charId] = JSON.parse(history);
                                } catch (e) {
                                    console.warn(`æ— æ³•è§£æè§’è‰² ${charId} çš„èŠå¤©è®°å½•:`, e);
                                }
                            }
                        }
                    }

                    console.log('èŠå¤©è®°å½•å·²æ”¶é›†');

                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chat-config-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();

                    // å»¶è¿Ÿç§»é™¤å’Œé‡Šæ”¾URL,ç¡®ä¿ä¸‹è½½å¼€å§‹
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);

                    console.log('é…ç½®å·²å¯¼å‡ºæˆåŠŸ');
                    alert('é…ç½®å·²å¯¼å‡ºæˆåŠŸï¼');
                } catch (error) {
                    console.error('å¯¼å‡ºé…ç½®å¤±è´¥:', error);
                    alert('å¯¼å‡ºé…ç½®å¤±è´¥: ' + error.message);
                } finally {
                    chatMenuPanel.classList.add('hidden');
                }
            });

            // å¯¼å…¥é…ç½®
            const menuImportConfigBtn = document.getElementById('menu-import-config-btn');
            const configFileInput = document.getElementById('config-file-input');

            menuImportConfigBtn.addEventListener('click', () => {
                configFileInput.click();
                chatMenuPanel.classList.add('hidden');
            });

            configFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const config = JSON.parse(event.target.result);

                            if (!confirm('ç¡®å®šè¦å¯¼å…¥é…ç½®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„æ‰€æœ‰è®¾ç½®ã€è§’è‰²å’ŒèŠå¤©è®°å½•ï¼')) {
                                return;
                            }

                            // å¯¼å…¥APIè®¾ç½®
                            if (config.api) {
                                if (config.api.apiUrl) await idbStorage.setItem('api_url_v2', config.api.apiUrl);
                                if (config.api.apiKey) await idbStorage.setItem('api_key_v2', config.api.apiKey);
                                if (config.api.model) await idbStorage.setItem('api_model_v2', config.api.model);
                                if (config.api.visionUrl) await idbStorage.setItem('vision_url_v2', config.api.visionUrl);
                                if (config.api.visionKey) await idbStorage.setItem('vision_key_v2', config.api.visionKey);
                                if (config.api.visionModel) await idbStorage.setItem('vision_model_v2', config.api.visionModel);
                            }

                            // å¯¼å…¥è§’è‰²æ•°æ®
                            if (config.characters) {
                                char.data = config.characters;
                                await saveCharacters();
                            }

                            // å¯¼å…¥ä¸–ç•Œä¹¦
                            if (config.worldInfo) {
                                wi.data = config.worldInfo;
                                await saveWiData(wi.data);
                            }

                            // å¯¼å…¥æ­£åˆ™è¡¨è¾¾å¼
                            if (config.regex) {
                                regex.data = config.regex;
                                await saveRegexData();
                            }

                            // å¯¼å…¥é¢„è®¾
                            if (config.presets) {
                                presets.data = config.presets;
                                await savePresets();
                            }

                            // å¯¼å…¥ç”¨æˆ·æ•°æ®ï¼ˆå…¼å®¹æ–°æ—§æ ¼å¼ï¼‰
                            if (config.users) {
                                userManagement.users = config.users;
                                if (config.currentUserId) {
                                    userManagement.currentUserId = config.currentUserId;
                                }
                                await userManagement.saveUsers();
                                userManagement.updateCurrentUserDisplay();
                            } else if (config.user) {
                                // å…¼å®¹æ—§æ ¼å¼
                                userManagement.users = config.user;
                                await userManagement.saveUsers();
                            }

                            // å¯¼å…¥ä¸»é¢˜è®¾ç½®
                            if (config.theme) {
                                if (config.theme.primaryColor) {
                                    await idbStorage.setItem('primary_color', config.theme.primaryColor);
                                }
                                if (config.theme.customCSS) {
                                    await idbStorage.setItem('custom_css', config.theme.customCSS);
                                }
                            }

                            // å¯¼å…¥èŠå¤©è®°å½•
                            if (config.chatHistories) {
                                for (const charId of Object.keys(config.chatHistories)) {
                                    await idbStorage.setItem(`chat_history_${charId}`, JSON.stringify(config.chatHistories[charId]));
                                }
                            }

                            alert('é…ç½®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ä»¥åº”ç”¨æ–°é…ç½®ã€‚');
                            location.reload();
                        } catch (error) {
                            console.error('å¯¼å…¥é…ç½®å¤±è´¥:', error);
                            alert('å¯¼å…¥é…ç½®å¤±è´¥: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
                e.target.value = '';
            });

            // å¯¼å‡ºèŠå¤©è®°å½•
            const menuExportChatBtn = document.getElementById('menu-export-chat-btn');
            menuExportChatBtn.addEventListener('click', () => {
                if (!char.activeCharacterId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼');
                    return;
                }

                if (chatHistory.length === 0) {
                    alert('å½“å‰æ²¡æœ‰èŠå¤©è®°å½•ï¼');
                    return;
                }

                try {
                    const character = char.data[char.activeCharacterId];
                    const chatData = {
                        characterName: character.name,
                        exportDate: new Date().toISOString(),
                        messages: chatHistory
                    };

                    const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chat-${character.name}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    alert('èŠå¤©è®°å½•å·²å¯¼å‡ºæˆåŠŸï¼');
                } catch (error) {
                    console.error('å¯¼å‡ºèŠå¤©è®°å½•å¤±è´¥:', error);
                    alert('å¯¼å‡ºèŠå¤©è®°å½•å¤±è´¥: ' + error.message);
                }
                chatMenuPanel.classList.add('hidden');
            });

            // å¯¼å…¥èŠå¤©è®°å½•
            const menuImportChatBtn = document.getElementById('menu-import-chat-btn');
            const chatFileInput = document.getElementById('chat-file-input');

            menuImportChatBtn.addEventListener('click', () => {
                if (!char.activeCharacterId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼');
                    return;
                }
                chatFileInput.click();
                chatMenuPanel.classList.add('hidden');
            });

            chatFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const chatData = JSON.parse(event.target.result);

                            if (!chatData.messages || !Array.isArray(chatData.messages)) {
                                alert('æ— æ•ˆçš„èŠå¤©è®°å½•æ–‡ä»¶æ ¼å¼ï¼');
                                return;
                            }

                            if (!confirm(`ç¡®å®šè¦å¯¼å…¥èŠå¤©è®°å½•å—ï¼Ÿå½“å‰èŠå¤©è®°å½•å°†è¢«æ›¿æ¢ã€‚\n\nè§’è‰²åç§°: ${chatData.characterName || 'æœªçŸ¥'}\nå¯¼å‡ºæ—¥æœŸ: ${chatData.exportDate ? new Date(chatData.exportDate).toLocaleString() : 'æœªçŸ¥'}\næ¶ˆæ¯æ•°é‡: ${chatData.messages.length}`)) {
                                return;
                            }

                            // æ›¿æ¢å½“å‰èŠå¤©è®°å½•
                            chatHistory = chatData.messages;

                            // ä¿å­˜åˆ°IndexedDB
                            if (char.activeCharacterId) {
                                await idbStorage.setItem(`chat_history_${char.activeCharacterId}`, JSON.stringify(chatHistory));
                            }

                            // é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
                            chatMessages.innerHTML = '';
                            document.querySelectorAll('style[id^="style-"]').forEach(style => {
                                style.remove();
                            });
                            chatHistory.forEach(message => {
                                renderMessage(message);
                            });
                            chatMessages.scrollTop = chatMessages.scrollHeight;

                            alert('èŠå¤©è®°å½•å¯¼å…¥æˆåŠŸï¼');
                        } catch (error) {
                            console.error('å¯¼å…¥èŠå¤©è®°å½•å¤±è´¥:', error);
                            alert('å¯¼å…¥èŠå¤©è®°å½•å¤±è´¥: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
                e.target.value = '';
            });


            // --- User Management Logic ---
            const userManagement = {
                users: {},
                currentUserId: null,

                async init() {
                    await this.loadUsers();
                    this.bindEvents();
                    this.renderUserList();
                },

                async loadUsers() {
                    const usersData = await idbStorage.getItem('user_profiles_v1');
                    this.users = usersData ? JSON.parse(usersData) : {};
                    this.currentUserId = await idbStorage.getItem('current_user_id_v1');

                    // åˆ›å»ºé»˜è®¤ç”¨æˆ·å¦‚æœæ²¡æœ‰
                    if (Object.keys(this.users).length === 0) {
                        const defaultUserId = 'user_default';
                        this.users[defaultUserId] = {
                            id: defaultUserId,
                            name: 'é»˜è®¤ç”¨æˆ·',
                            avatar: 'https://placehold.co/128x128/E4E6EB/1A1A1D?text=U',
                            status: 'åœ¨çº¿',
                            description: '',
                            systemPrompt: '',
                            autoAnnounce: false,
                            showTyping: true
                        };
                        this.currentUserId = defaultUserId;
                        await this.saveUsers();
                    }

                    if (!this.currentUserId || !this.users[this.currentUserId]) {
                        this.currentUserId = Object.keys(this.users)[0];
                    }

                    this.updateCurrentUserDisplay();
                    this.updateUserPreviewCard();
                },

                async saveUsers() {
                    await idbStorage.setItem('user_profiles_v1', JSON.stringify(this.users));
                    await idbStorage.setItem('current_user_id_v1', this.currentUserId);
                },

                renderUserList() {
                    const userList = document.getElementById('user-list');
                    if (!userList) return;

                    userList.innerHTML = '';

                    Object.values(this.users).forEach(user => {
                        const item = document.createElement('div');
                        item.className = 'user-item p-3 rounded-lg cursor-pointer border-2 transition-all';
                        item.dataset.userId = user.id;

                        if (user.id === this.currentUserId) {
                            item.className += ' border-primary-color bg-primary-color bg-opacity-10';
                        } else {
                            item.className += ' border-gray-200 hover:border-primary-color hover:bg-gray-50';
                        }

                        item.innerHTML = `
                            <div class="flex items-center gap-3">
                                <img src="${user.avatar || 'https://placehold.co/40x40/E4E6EB/1A1A1D?text=U'}"
                                     class="w-12 h-12 rounded-full object-cover border-2 ${user.id === this.currentUserId ? 'border-primary-color' : 'border-gray-300'}">
                                <div class="flex-1">
                                    <p class="font-bold text-base">${user.name}</p>
                                    <p class="text-xs text-gray-500">${user.status || 'ç¦»çº¿'}</p>
                                </div>
                                ${user.id === this.currentUserId ? '<i class="fas fa-check-circle text-primary-color text-xl"></i>' : ''}
                            </div>
                        `;

                        item.addEventListener('click', () => {
                            this.useUser(user.id);
                            this.selectUser(user.id);  // è‡ªåŠ¨è¿›å…¥ç¼–è¾‘çŠ¶æ€
                            this.closeUserSelector();
                        });
                        userList.appendChild(item);
                    });
                },

                openUserSelector() {
                    const modal = document.getElementById('user-selector-modal');
                    if (modal) {
                        this.renderUserList();
                        modal.classList.add('active');
                    }
                },

                closeUserSelector() {
                    const modal = document.getElementById('user-selector-modal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                },

                updateUserPreviewCard() {
                    const user = this.users[this.currentUserId];
                    if (!user) return;

                    const avatarEl = document.getElementById('current-user-avatar-preview');
                    const nameEl = document.getElementById('current-user-name-preview');
                    const statusEl = document.getElementById('current-user-status-preview');

                    if (avatarEl) avatarEl.src = user.avatar || 'https://placehold.co/48x48/E4E6EB/1A1A1D?text=U';
                    if (nameEl) nameEl.textContent = user.name || 'æœªå‘½åç”¨æˆ·';
                    if (statusEl) statusEl.textContent = user.status || 'ç¦»çº¿';
                },

                selectUser(userId) {
                    const user = this.users[userId];
                    if (!user) return;

                    // æ˜¾ç¤ºç¼–è¾‘å™¨
                    document.getElementById('user-editor-placeholder').classList.add('hidden');
                    document.getElementById('user-editor-content').classList.remove('hidden');

                    // å¡«å……è¡¨å•
                    document.getElementById('user-editing-id').value = user.id;
                    document.getElementById('user-editor-avatar').src = user.avatar || 'https://placehold.co/128x128/E4E6EB/1A1A1D?text=U';
                    document.getElementById('user-editor-name').value = user.name || '';
                    document.getElementById('user-editor-status').value = user.status || '';
                    document.getElementById('user-editor-description').value = user.description || '';
                    document.getElementById('user-editor-system-prompt').value = user.systemPrompt || '';
                    document.getElementById('user-auto-announce').checked = user.autoAnnounce || false;
                    document.getElementById('user-show-typing').checked = user.showTyping !== false;
                },

                createNewUser() {
                    const newUserId = `user_${Date.now()}`;
                    const newUser = {
                        id: newUserId,
                        name: 'æ–°ç”¨æˆ·',
                        avatar: 'https://placehold.co/128x128/E4E6EB/1A1A1D?text=NEW',
                        status: 'åœ¨çº¿',
                        description: '',
                        systemPrompt: '',
                        autoAnnounce: false,
                        showTyping: true
                    };

                    this.users[newUserId] = newUser;
                    this.saveUsers();
                    this.renderUserList();
                    this.selectUser(newUserId);
                },

                saveCurrentUser() {
                    const userId = document.getElementById('user-editing-id').value;
                    if (!userId || !this.users[userId]) return;

                    const user = this.users[userId];
                    user.name = document.getElementById('user-editor-name').value;
                    user.status = document.getElementById('user-editor-status').value;
                    user.description = document.getElementById('user-editor-description').value;
                    user.systemPrompt = document.getElementById('user-editor-system-prompt').value;
                    user.autoAnnounce = document.getElementById('user-auto-announce').checked;
                    user.showTyping = document.getElementById('user-show-typing').checked;

                    this.saveUsers();
                    this.renderUserList();

                    if (userId === this.currentUserId) {
                        this.updateCurrentUserDisplay();
                        this.updateUserPreviewCard();
                    }

                    alert(`ç”¨æˆ· "${user.name}" å·²ä¿å­˜ï¼`);
                },

                useUser(userId) {
                    if (!userId) {
                        userId = document.getElementById('user-editing-id').value;
                    }

                    if (!this.users[userId]) return;

                    this.currentUserId = userId;
                    this.saveUsers();
                    this.updateCurrentUserDisplay();
                    this.updateUserPreviewCard();
                    this.renderUserList();

                    alert(`å·²åˆ‡æ¢åˆ°ç”¨æˆ· "${this.users[userId].name}"`);
                },

                duplicateUser() {
                    const userId = document.getElementById('user-editing-id').value;
                    if (!userId || !this.users[userId]) return;

                    const originalUser = this.users[userId];
                    const newUserId = `user_${Date.now()}`;
                    const newUser = {
                        ...originalUser,
                        id: newUserId,
                        name: `${originalUser.name} (å¤åˆ¶)`
                    };

                    this.users[newUserId] = newUser;
                    this.saveUsers();
                    this.renderUserList();
                    this.selectUser(newUserId);
                },

                deleteUser() {
                    const userId = document.getElementById('user-editing-id').value;
                    if (!userId || !this.users[userId]) return;

                    if (userId === 'user_default') {
                        alert('ä¸èƒ½åˆ é™¤é»˜è®¤ç”¨æˆ·ï¼');
                        return;
                    }

                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${this.users[userId].name}" å—ï¼Ÿ`)) return;

                    delete this.users[userId];

                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç”¨æˆ·ï¼Œåˆ‡æ¢åˆ°é»˜è®¤ç”¨æˆ·
                    if (userId === this.currentUserId) {
                        this.currentUserId = Object.keys(this.users)[0];
                        this.updateCurrentUserDisplay();
                    }

                    this.saveUsers();
                    this.renderUserList();

                    // éšè—ç¼–è¾‘å™¨
                    document.getElementById('user-editor-placeholder').classList.remove('hidden');
                    document.getElementById('user-editor-content').classList.add('hidden');
                },

                uploadAvatar(file) {
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const avatar = e.target.result;
                        document.getElementById('user-editor-avatar').src = avatar;

                        const userId = document.getElementById('user-editing-id').value;
                        if (userId && this.users[userId]) {
                            this.users[userId].avatar = avatar;
                        }
                    };
                    reader.readAsDataURL(file);
                },

                updateCurrentUserDisplay() {
                    const user = this.users[this.currentUserId];
                    if (!user) return;

                    // æ›´æ–°èŠå¤©ç•Œé¢çš„ç”¨æˆ·å¤´åƒ
                    const userAvatars = document.querySelectorAll('.chat-message-group.justify-end img');
                    userAvatars.forEach(img => {
                        if (user.avatar) {
                            img.src = user.avatar;
                        }
                    });
                },

                uploadAvatar(file) {
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const avatar = e.target.result;
                        document.getElementById('user-editor-avatar').src = avatar;

                        const userId = document.getElementById('user-editing-id').value;
                        if (userId && this.users[userId]) {
                            this.users[userId].avatar = avatar;

                            if (userId === this.currentUserId) {
                                this.updateUserPreviewCard();
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                },

                getCurrentUser() {
                    return this.users[this.currentUserId];
                },

                bindEvents() {
                    // æ‰“å¼€ç”¨æˆ·é€‰æ‹©å™¨
                    const openSelectorBtn = document.getElementById('open-user-selector-btn');
                    const previewCard = document.getElementById('user-preview-card');

                    if (openSelectorBtn) {
                        openSelectorBtn.addEventListener('click', () => this.openUserSelector());
                    }

                    if (previewCard) {
                        previewCard.addEventListener('click', () => this.openUserSelector());
                    }

                    // å…³é—­ç”¨æˆ·é€‰æ‹©å™¨
                    const closeSelectorBtns = document.querySelectorAll('.close-user-selector-btn');
                    closeSelectorBtns.forEach(btn => {
                        btn.addEventListener('click', () => this.closeUserSelector());
                    });

                    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
                    const selectorModal = document.getElementById('user-selector-modal');
                    if (selectorModal) {
                        selectorModal.addEventListener('click', (e) => {
                            if (e.target === selectorModal) {
                                this.closeUserSelector();
                            }
                        });
                    }

                    // å…¶ä»–æŒ‰é’®äº‹ä»¶
                    const userNewBtn = document.getElementById('user-new-btn');
                    const userSaveBtn = document.getElementById('user-save-btn');
                    const userUseBtn = document.getElementById('user-use-btn');
                    const userDuplicateBtn = document.getElementById('user-duplicate-btn');
                    const userDeleteBtn = document.getElementById('user-delete-btn');
                    const userAvatarUpload = document.getElementById('user-avatar-upload');

                    if (userNewBtn) userNewBtn.addEventListener('click', () => this.createNewUser());
                    if (userSaveBtn) userSaveBtn.addEventListener('click', () => this.saveCurrentUser());
                    if (userUseBtn) userUseBtn.addEventListener('click', () => this.useUser());
                    if (userDuplicateBtn) userDuplicateBtn.addEventListener('click', () => this.duplicateUser());
                    if (userDeleteBtn) userDeleteBtn.addEventListener('click', () => this.deleteUser());

                    if (userAvatarUpload) {
                        userAvatarUpload.addEventListener('change', (e) => {
                            this.uploadAvatar(e.target.files[0]);
                        });
                    }

                    // Language selector event listener
                    const languageSelect = document.getElementById('language-select');
                    if (languageSelect) {
                        // Initialize language selector value from i18n.currentLang
                        languageSelect.value = i18n.currentLang;

                        // Add change event listener
                        languageSelect.addEventListener('change', (e) => {
                            i18n.setLanguage(e.target.value);
                        });
                    }
                }
            };

            // --- Preferences Logic ---
            const preferencesManager = {
                init() {
                    const savePreferencesBtn = document.getElementById('save-preferences-btn');
                    if (savePreferencesBtn) {
                        savePreferencesBtn.addEventListener('click', () => this.savePreferences());
                    }

                    // Initialize preferences modal when opened
                    const preferencesModal = document.getElementById('preferences-modal');
                    if (preferencesModal) {
                        preferencesModal.addEventListener('click', (e) => {
                            if (e.target === preferencesModal && preferencesModal.classList.contains('active')) {
                                this.loadPreferences();
                            }
                        });
                    }

                    // Initialize language selector
                    const languageSelectPref = document.getElementById('language-select-pref');
                    if (languageSelectPref) {
                        languageSelectPref.addEventListener('change', (e) => {
                            i18n.setLanguage(e.target.value);
                        });
                    }

                    // Load preferences when modal opens
                    const navButtons = document.querySelectorAll('[data-modal="preferences-modal"]');
                    navButtons.forEach(btn => {
                        btn.addEventListener('click', () => this.loadPreferences());
                    });
                },

                loadPreferences() {
                    const currentUser = userManager.getCurrentUser();
                    if (!currentUser) return;

                    // Load language
                    const languageSelectPref = document.getElementById('language-select-pref');
                    if (languageSelectPref) {
                        languageSelectPref.value = i18n.currentLang;
                    }

                    // Load user behavior settings
                    document.getElementById('user-auto-announce-pref').checked = currentUser.autoAnnounce || false;
                    document.getElementById('user-show-typing-pref').checked = currentUser.showTyping !== false;
                },

                savePreferences() {
                    const currentUser = userManager.getCurrentUser();
                    if (!currentUser) {
                        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·ï¼');
                        return;
                    }

                    // Save language (already saved by change event)
                    const languageSelectPref = document.getElementById('language-select-pref');
                    if (languageSelectPref) {
                        i18n.setLanguage(languageSelectPref.value);
                    }

                    // Save user behavior settings
                    currentUser.autoAnnounce = document.getElementById('user-auto-announce-pref').checked;
                    currentUser.showTyping = document.getElementById('user-show-typing-pref').checked;

                    // Also update the user settings modal checkboxes
                    document.getElementById('user-auto-announce').checked = currentUser.autoAnnounce;
                    document.getElementById('user-show-typing').checked = currentUser.showTyping;

                    userManager.saveUsers();
                    alert('åå¥½è®¾ç½®å·²ä¿å­˜ï¼');
                }
            };

            // --- Theme Logic ---
            const themeManager = {
                themes: {},
                currentTheme: null,
                customCss: '',
                defaultPresets: {
                    default: {
                        primaryColor: '#5E5B9D',
                        bgColor: '#f0f2f5',
                        userBubbleColor: '#5E5B9D',
                        aiBubbleColor: '#FFFFFF',
                        cardBgColor: '#ffffff',
                        textColor: '#1a1a1d',
                        borderColor: '#dcdfe3',
                        inputBgColor: '#e4e6eb'
                    },
                    dark: {
                        primaryColor: '#7875b3',
                        bgColor: '#1a1a1d',
                        userBubbleColor: '#7875b3',
                        aiBubbleColor: '#2d2d30',
                        cardBgColor: '#2d2d30',
                        textColor: '#e0e0e0',
                        borderColor: '#404040',
                        inputBgColor: '#404040'
                    },
                    blue: {
                        primaryColor: '#3498db',
                        bgColor: '#ecf0f1',
                        userBubbleColor: '#3498db',
                        aiBubbleColor: '#ffffff',
                        cardBgColor: '#ffffff',
                        textColor: '#2c3e50',
                        borderColor: '#bdc3c7',
                        inputBgColor: '#d5dbdb'
                    },
                    green: {
                        primaryColor: '#27ae60',
                        bgColor: '#f0fff4',
                        userBubbleColor: '#2ecc71',
                        aiBubbleColor: '#ffffff',
                        cardBgColor: '#ffffff',
                        textColor: '#27ae60',
                        borderColor: '#a9dfbf',
                        inputBgColor: '#d5f4e6'
                    },
                    purple: {
                        primaryColor: '#8e44ad',
                        bgColor: '#f9f6fb',
                        userBubbleColor: '#9b59b6',
                        aiBubbleColor: '#ffffff',
                        cardBgColor: '#ffffff',
                        textColor: '#6c3483',
                        borderColor: '#d2b4de',
                        inputBgColor: '#ebdef0'
                    },
                    pink: {
                        primaryColor: '#e91e63',
                        bgColor: '#fce4ec',
                        userBubbleColor: '#f06292',
                        aiBubbleColor: '#ffffff',
                        cardBgColor: '#ffffff',
                        textColor: '#880e4f',
                        borderColor: '#f8bbd0',
                        inputBgColor: '#f5d0db'
                    }
                },

                init() {
                    this.loadThemes();
                    this.bindEvents();
                    this.loadCustomCss();
                    this.renderSavedThemes();
                    this.applyCurrentTheme();
                    this.initColorInputs();
                },

                async loadThemes() {
                    const themesData = await idbStorage.getItem('saved_themes_v1');
                    this.themes = themesData ? JSON.parse(themesData) : {};
                    this.currentTheme = await idbStorage.getItem('current_theme_v1') || 'default';
                },

                async saveThemes() {
                    await idbStorage.setItem('saved_themes_v1', JSON.stringify(this.themes));
                    await idbStorage.setItem('current_theme_v1', this.currentTheme);
                },

                async loadCustomCss() {
                    this.customCss = await idbStorage.getItem('custom_css_v1') || '';
                    const editor = document.getElementById('custom-css-editor');
                    if (editor) editor.value = this.customCss;
                    this.applyCustomCss();
                },

                async saveCustomCss(css) {
                    this.customCss = css;
                    await idbStorage.setItem('custom_css_v1', css);
                    this.applyCustomCss();
                },

                applyCustomCss() {
                    let styleEl = document.getElementById('custom-theme-styles');
                    if (!styleEl) {
                        styleEl = document.createElement('style');
                        styleEl.id = 'custom-theme-styles';
                        document.head.appendChild(styleEl);
                    }
                    styleEl.textContent = this.customCss;
                },

                getCurrentThemeColors() {
                    const root = document.documentElement;
                    const computedStyle = getComputedStyle(root);
                    return {
                        primaryColor: computedStyle.getPropertyValue('--primary-color').trim() || '#5E5B9D',
                        bgColor: computedStyle.getPropertyValue('--bg-color').trim() || '#f0f2f5',
                        userBubbleColor: computedStyle.getPropertyValue('--user-bubble-color').trim() || '#5E5B9D',
                        aiBubbleColor: computedStyle.getPropertyValue('--ai-bubble-color').trim() || '#FFFFFF',
                        cardBgColor: computedStyle.getPropertyValue('--card-bg-color').trim() || '#ffffff',
                        textColor: computedStyle.getPropertyValue('--text-color').trim() || '#1a1a1d',
                        borderColor: computedStyle.getPropertyValue('--border-color').trim() || '#dcdfe3',
                        inputBgColor: computedStyle.getPropertyValue('--input-bg-color').trim() || '#e4e6eb'
                    };
                },

                applyTheme(themeData) {
                    const root = document.documentElement;

                    if (themeData.primaryColor) root.style.setProperty('--primary-color', themeData.primaryColor);
                    if (themeData.bgColor) root.style.setProperty('--bg-color', themeData.bgColor);
                    if (themeData.userBubbleColor) root.style.setProperty('--user-bubble-color', themeData.userBubbleColor);
                    if (themeData.aiBubbleColor) root.style.setProperty('--ai-bubble-color', themeData.aiBubbleColor);
                    if (themeData.cardBgColor) root.style.setProperty('--card-bg-color', themeData.cardBgColor);
                    if (themeData.textColor) root.style.setProperty('--text-color', themeData.textColor);
                    if (themeData.borderColor) root.style.setProperty('--border-color', themeData.borderColor);
                    if (themeData.inputBgColor) root.style.setProperty('--input-bg-color', themeData.inputBgColor);

                    // è®¡ç®—è¡ç”Ÿé¢œè‰²
                    root.style.setProperty('--primary-hover-color', this.adjustBrightness(themeData.primaryColor || '#5E5B9D', 20));
                    root.style.setProperty('--text-secondary-color', this.adjustBrightness(themeData.textColor || '#1a1a1d', 40));

                    if (themeData.customCss) {
                        this.saveCustomCss(themeData.customCss);
                    }

                    this.updateColorInputs();
                },

                applyCurrentTheme() {
                    // é¦–å…ˆå°è¯•åŠ è½½ä¿å­˜çš„ä¸»é¢˜
                    if (this.themes[this.currentTheme]) {
                        this.applyTheme(this.themes[this.currentTheme]);
                    }
                    // ç„¶åæ£€æŸ¥æ˜¯å¦æ˜¯é¢„è®¾ä¸»é¢˜
                    else if (this.defaultPresets[this.currentTheme]) {
                        this.applyTheme(this.defaultPresets[this.currentTheme]);
                    }
                },

                saveAsNewTheme(name) {
                    if (!name) {
                        name = prompt('è¯·è¾“å…¥ä¸»é¢˜åç§°ï¼š');
                        if (!name) return;
                    }

                    const themeData = {
                        ...this.getCurrentThemeColors(),
                        customCss: this.customCss,
                        createdAt: new Date().toISOString()
                    };

                    this.themes[name] = themeData;
                    this.currentTheme = name;
                    this.saveThemes();
                    this.renderSavedThemes();

                    alert(`ä¸»é¢˜ "${name}" å·²ä¿å­˜ï¼`);
                },

                deleteTheme(name) {
                    if (!this.themes[name]) return;

                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¸»é¢˜ "${name}" å—ï¼Ÿ`)) return;

                    delete this.themes[name];

                    if (this.currentTheme === name) {
                        this.currentTheme = 'default';
                        this.applyTheme(this.defaultPresets.default);
                    }

                    this.saveThemes();
                    this.renderSavedThemes();
                },

                exportTheme(name) {
                    const theme = name ? this.themes[name] : {
                        ...this.getCurrentThemeColors(),
                        customCss: this.customCss
                    };

                    if (!theme) {
                        alert('ä¸»é¢˜ä¸å­˜åœ¨ï¼');
                        return;
                    }

                    const exportData = {
                        name: name || 'custom-theme',
                        theme: theme,
                        version: '1.0',
                        exportedAt: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `theme-${name || 'custom'}.json`;
                    // ç§»åŠ¨ç«¯éœ€è¦å°†aæ ‡ç­¾æ·»åŠ åˆ°DOMä¸­æ‰èƒ½è§¦å‘ä¸‹è½½
                    document.body.appendChild(a);
                    a.click();
                    // å»¶è¿Ÿç§»é™¤å’Œé‡Šæ”¾URL,ç¡®ä¿ä¸‹è½½å¼€å§‹
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                },

                importTheme(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);

                            if (!data.theme) {
                                throw new Error('æ— æ•ˆçš„ä¸»é¢˜æ–‡ä»¶ï¼');
                            }

                            const name = data.name || prompt('è¯·è¾“å…¥ä¸»é¢˜åç§°ï¼š', data.name || 'imported-theme');
                            if (!name) return;

                            this.themes[name] = data.theme;
                            this.saveThemes();
                            this.renderSavedThemes();

                            if (confirm(`ä¸»é¢˜ "${name}" å·²å¯¼å…¥ï¼æ˜¯å¦ç«‹å³åº”ç”¨ï¼Ÿ`)) {
                                this.currentTheme = name;
                                this.applyTheme(data.theme);
                                this.saveThemes();
                            }
                        } catch (err) {
                            alert(`å¯¼å…¥å¤±è´¥ï¼š${err.message}`);
                        }
                    };
                    reader.readAsText(file);
                },

                renderSavedThemes() {
                    const list = document.getElementById('saved-themes-list');
                    const noThemes = document.getElementById('no-saved-themes');

                    if (!list) return;

                    list.innerHTML = '';

                    const themeNames = Object.keys(this.themes);

                    if (themeNames.length === 0) {
                        if (noThemes) noThemes.style.display = 'block';
                        list.style.display = 'none';
                    } else {
                        if (noThemes) noThemes.style.display = 'none';
                        list.style.display = 'block';

                        themeNames.forEach(name => {
                            const theme = this.themes[name];
                            const item = document.createElement('div');
                            item.className = 'theme-item p-3 rounded-lg border border-gray-200 hover:border-primary-color cursor-pointer';

                            if (name === this.currentTheme) {
                                item.classList.add('border-primary-color', 'bg-primary-color', 'bg-opacity-10');
                            }

                            item.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <h4 class="font-medium">${name}</h4>
                                        <div class="flex gap-2 mt-2">
                                            <span class="w-6 h-6 rounded border" style="background-color: ${theme.primaryColor}"></span>
                                            <span class="w-6 h-6 rounded border" style="background-color: ${theme.bgColor}"></span>
                                            <span class="w-6 h-6 rounded border" style="background-color: ${theme.userBubbleColor}"></span>
                                            <span class="w-6 h-6 rounded border" style="background-color: ${theme.aiBubbleColor}"></span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="apply-theme-btn px-3 py-1 btn-primary text-sm rounded" data-theme="${name}">åº”ç”¨</button>
                                        <button class="export-theme-btn px-3 py-1 btn-secondary text-sm rounded" data-theme="${name}"><i class="fas fa-download"></i></button>
                                        <button class="delete-theme-btn px-3 py-1 btn-secondary text-sm rounded hover:bg-red-100 hover:text-red-600" data-theme="${name}"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            `;

                            list.appendChild(item);
                        });

                        // ç»‘å®šä¸»é¢˜æ“ä½œæŒ‰é’®äº‹ä»¶
                        list.querySelectorAll('.apply-theme-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const themeName = btn.dataset.theme;
                                this.currentTheme = themeName;
                                this.applyTheme(this.themes[themeName]);
                                this.saveThemes();
                                this.renderSavedThemes();
                            });
                        });

                        list.querySelectorAll('.export-theme-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.exportTheme(btn.dataset.theme);
                            });
                        });

                        list.querySelectorAll('.delete-theme-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.deleteTheme(btn.dataset.theme);
                            });
                        });
                    }
                },

                adjustBrightness(color, percent) {
                    const num = parseInt(color.replace('#', ''), 16);
                    const amt = Math.round(2.55 * percent);
                    const R = (num >> 16) + amt;
                    const G = (num >> 8 & 0x00FF) + amt;
                    const B = (num & 0x0000FF) + amt;
                    return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                        (B < 255 ? B < 1 ? 0 : B : 255))
                        .toString(16).slice(1);
                },

                formatCss(css) {
                    // ç®€å•çš„CSSæ ¼å¼åŒ–
                    return css
                        .replace(/\s*{\s*/g, ' {\n    ')
                        .replace(/;\s*/g, ';\n    ')
                        .replace(/\s*}\s*/g, '\n}\n')
                        .replace(/\n\s*\n/g, '\n');
                },

                minifyCss(css) {
                    // ç®€å•çš„CSSå‹ç¼©
                    return css
                        .replace(/\/\*[\s\S]*?\*\//g, '')
                        .replace(/\s+/g, ' ')
                        .replace(/\s*{\s*/g, '{')
                        .replace(/;\s*/g, ';')
                        .replace(/\s*}\s*/g, '}')
                        .trim();
                },

                initColorInputs() {
                    const colorInputs = [
                        { color: 'primaryColor', text: 'primaryColorText' },
                        { color: 'bgColor', text: 'bgColorText' },
                        { color: 'userBubbleColor', text: 'userBubbleColorText' },
                        { color: 'aiBubbleColor', text: 'aiBubbleColorText' },
                        { color: 'cardBgColor', text: 'cardBgColorText' },
                        { color: 'textColor', text: 'textColorText' },
                        { color: 'borderColor', text: 'borderColorText' },
                        { color: 'inputBgColor', text: 'inputBgColorText' }
                    ];

                    colorInputs.forEach(({ color, text }) => {
                        const colorInput = document.getElementById(`${color}Input`);
                        const textInput = document.getElementById(`${text}`);

                        if (colorInput && textInput) {
                            // åŒæ­¥é¢œè‰²é€‰æ‹©å™¨å’Œæ–‡æœ¬è¾“å…¥
                            colorInput.addEventListener('input', (e) => {
                                textInput.value = e.target.value;
                            });

                            textInput.addEventListener('input', (e) => {
                                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                                    colorInput.value = e.target.value;
                                }
                            });
                        }
                    });

                    this.updateColorInputs();
                },

                updateColorInputs() {
                    const colors = this.getCurrentThemeColors();

                    Object.entries(colors).forEach(([key, value]) => {
                        const colorInput = document.getElementById(`${key}Input`);
                        const textInput = document.getElementById(`${key}Text`);

                        if (colorInput) colorInput.value = value;
                        if (textInput) textInput.value = value;
                    });
                },

                bindEvents() {
                    // é¢„è®¾ä¸»é¢˜æŒ‰é’®
                    document.querySelectorAll('.theme-preset-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const themeName = btn.dataset.theme;
                            if (this.defaultPresets[themeName]) {
                                this.applyTheme(this.defaultPresets[themeName]);
                                this.currentTheme = themeName;
                                this.saveThemes();

                                document.querySelectorAll('.theme-preset-btn').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                            }
                        });
                    });

                    // åº”ç”¨æŒ‰é’®
                    const applyBtn = document.getElementById('applyThemeBtn');
                    if (applyBtn) {
                        applyBtn.addEventListener('click', () => {
                            const colors = {};
                            ['primaryColor', 'bgColor', 'userBubbleColor', 'aiBubbleColor', 'cardBgColor', 'textColor', 'borderColor', 'inputBgColor'].forEach(key => {
                                const input = document.getElementById(`${key}Input`);
                                if (input) colors[key] = input.value;
                            });

                            this.applyTheme(colors);

                            // ä¿å­˜è‡ªå®šä¹‰CSS
                            const cssEditor = document.getElementById('custom-css-editor');
                            if (cssEditor) {
                                this.saveCustomCss(cssEditor.value);
                            }
                        });
                    }

                    // å¦å­˜ä¸ºæŒ‰é’®
                    const saveAsBtn = document.getElementById('saveAsThemeBtn');
                    if (saveAsBtn) {
                        saveAsBtn.addEventListener('click', () => this.saveAsNewTheme());
                    }

                    // å¯¼å‡ºæŒ‰é’®
                    const exportBtn = document.getElementById('exportThemeBtn');
                    if (exportBtn) {
                        exportBtn.addEventListener('click', () => this.exportTheme());
                    }

                    // å¯¼å…¥æŒ‰é’®
                    const importBtn = document.getElementById('importThemeBtn');
                    const importFile = document.getElementById('themeImportFile');
                    if (importBtn && importFile) {
                        importBtn.addEventListener('click', () => importFile.click());
                        importFile.addEventListener('change', (e) => {
                            if (e.target.files[0]) {
                                this.importTheme(e.target.files[0]);
                                e.target.value = '';
                            }
                        });
                    }

                    // é‡ç½®æŒ‰é’®
                    const resetBtn = document.getElementById('resetThemeBtn');
                    if (resetBtn) {
                        resetBtn.addEventListener('click', () => {
                            this.currentTheme = 'default';
                            this.applyTheme(this.defaultPresets.default);
                            this.saveCustomCss('');
                            this.saveThemes();
                            document.getElementById('custom-css-editor').value = '';
                        });
                    }

                    // CSSç¼–è¾‘å™¨æŒ‰é’®
                    const formatBtn = document.getElementById('css-format-btn');
                    const minifyBtn = document.getElementById('css-minify-btn');
                    const previewBtn = document.getElementById('css-preview-btn');
                    const cssEditor = document.getElementById('custom-css-editor');

                    if (formatBtn && cssEditor) {
                        formatBtn.addEventListener('click', () => {
                            cssEditor.value = this.formatCss(cssEditor.value);
                        });
                    }

                    if (minifyBtn && cssEditor) {
                        minifyBtn.addEventListener('click', () => {
                            cssEditor.value = this.minifyCss(cssEditor.value);
                        });
                    }

                    if (previewBtn && cssEditor) {
                        previewBtn.addEventListener('click', () => {
                            this.saveCustomCss(cssEditor.value);
                            alert('CSSå·²åº”ç”¨é¢„è§ˆï¼');
                        });
                    }

                    // ä¿å­˜å½“å‰ä¸»é¢˜æŒ‰é’®
                    const saveCurrentBtn = document.getElementById('save-current-theme-btn');
                    if (saveCurrentBtn) {
                        saveCurrentBtn.addEventListener('click', () => this.saveAsNewTheme());
                    }
                }
            };

            // ä¸»é¢˜æ ‡ç­¾é¡µåˆ‡æ¢
            window.switchThemeTab = function(tab) {
                document.querySelectorAll('.theme-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                document.querySelectorAll('#theme-settings-modal .border-b button').forEach(btn => {
                    btn.classList.remove('border-b-2', 'border-primary-color', 'font-medium');
                    btn.classList.add('text-gray-500');
                });

                const content = document.getElementById(`theme-${tab}-content`);
                if (content) content.classList.remove('hidden');

                const tabBtn = document.getElementById(`theme-tab-${tab}`);
                if (tabBtn) {
                    tabBtn.classList.add('border-b-2', 'border-primary-color', 'font-medium');
                    tabBtn.classList.remove('text-gray-500');
                }

                // å¦‚æœåˆ‡æ¢åˆ°ä¿å­˜çš„ä¸»é¢˜é¡µ,åˆ·æ–°åˆ—è¡¨
                if (tab === 'saved' && typeof themeManager !== 'undefined' && themeManager.renderSavedThemes) {
                    themeManager.renderSavedThemes();
                }
            };

            // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†
            themeManager.init();
            preferencesManager.init();


            // --- Initial Load ---
            // å¼‚æ­¥åˆå§‹åŒ–å‡½æ•°
            async function initializeApp() {
                await userManagement.init();
                loadApiConfigs();
                loadPresetsList();
                await loadCharacters(); // This now handles loading character data and then triggers WI/Regex loads.
            }

            // æ‰§è¡Œåˆå§‹åŒ–
            initializeApp();

            // æ›´æ–°é¢„è®¾Tokenç»Ÿè®¡
            function updatePresetTokenEstimate() {
                const preset = getPresets()[document.querySelector('.preset-item.active')?.dataset.name || 'é»˜è®¤'];
                if (!preset?.prompts) return;

                let totalTokens = 0;
                preset.prompts.forEach(prompt => {
                    if (prompt.enabled && prompt.content) {
                        totalTokens += estimateTokens(prompt.content);
                    }
                });

                document.getElementById('preset-token-estimate').textContent = totalTokens;

                // æ›´æ–°ä¸Šä¸‹æ–‡ä½¿ç”¨æƒ…å†µ
                const contextSize = parseInt(document.getElementById('param-context-size').value) || 4096;
                const maxTokens = parseInt(document.getElementById('param-max-tokens').value) || 1024;
                const remaining = contextSize - totalTokens - maxTokens;

                document.getElementById('remaining-context').textContent = `${remaining} / ${contextSize}`;

                const usagePercent = ((totalTokens + maxTokens) / contextSize) * 100;
                document.getElementById('context-usage-bar').style.width = `${Math.min(100, usagePercent)}%`;

                if (usagePercent > 90) {
                    document.getElementById('context-usage-bar').className = 'bg-red-500 h-2 rounded-full';
                } else if (usagePercent > 70) {
                    document.getElementById('context-usage-bar').className = 'bg-yellow-500 h-2 rounded-full';
                } else {
                    document.getElementById('context-usage-bar').className = 'bg-primary-color h-2 rounded-full';
                }
            }

            // ç›‘å¬é¢„è®¾å‚æ•°å˜åŒ–
            document.getElementById('param-context-size')?.addEventListener('input', updatePresetTokenEstimate);
            document.getElementById('param-max-tokens')?.addEventListener('input', updatePresetTokenEstimate);

            // åœ¨åˆ‡æ¢é¢„è®¾æ—¶æ›´æ–°Tokenç»Ÿè®¡
            const originalSelectPreset = selectPreset;
            selectPreset = function(name) {
                originalSelectPreset(name);
                setTimeout(updatePresetTokenEstimate, 100);
            };

            // --- æ€»ç»“èŠå¤©åŠŸèƒ½ ---
            const summarizeConfig = {
                apiUrl: document.getElementById('summarize-api-url'),
                apiKey: document.getElementById('summarize-api-key'),
                apiModel: document.getElementById('summarize-api-model'),
                apiModelSelect: document.getElementById('summarize-api-model-select'),
                floorCount: document.getElementById('summarize-floor-count'),
                prompt: document.getElementById('summarize-prompt'),
                autoHide: document.getElementById('summarize-auto-hide'),
                autoEnable: document.getElementById('summarize-auto-enable'),
                templatesSelect: document.getElementById('summarize-prompt-templates'),
                modal: document.getElementById('summarize-modal')
            };

            // éªŒè¯æ‰€æœ‰å¿…éœ€çš„å…ƒç´ éƒ½å­˜åœ¨
            const missingElements = Object.entries(summarizeConfig).filter(([key, el]) => !el).map(([key]) => key);
            if (missingElements.length > 0) {
                console.warn('[æ€»ç»“é…ç½®] ç¼ºå°‘ä»¥ä¸‹å…ƒç´ :', missingElements);
            }

            // åŠ è½½æç¤ºè¯æ¨¡æ¿åˆ—è¡¨
            async function loadPromptTemplates() {
                const templatesData = await idbStorage.getItem('summarize_prompt_templates');
                const templates = templatesData ? JSON.parse(templatesData) : {};
                summarizeConfig.templatesSelect.innerHTML = '<option value="">é€‰æ‹©æ¨¡æ¿...</option>';

                Object.keys(templates).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    summarizeConfig.templatesSelect.appendChild(option);
                });
            }

            // ä¿å­˜æç¤ºè¯æ¨¡æ¿
            document.getElementById('save-prompt-template-btn').addEventListener('click', async () => {
                const templateName = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°:');
                if (!templateName || !templateName.trim()) return;

                const templatesData = await idbStorage.getItem('summarize_prompt_templates');
                const templates = templatesData ? JSON.parse(templatesData) : {};
                templates[templateName.trim()] = summarizeConfig.prompt.value;
                await idbStorage.setItem('summarize_prompt_templates', JSON.stringify(templates));

                await loadPromptTemplates();
                summarizeConfig.templatesSelect.value = templateName.trim();
                alert(`æ¨¡æ¿ "${templateName}" å·²ä¿å­˜ï¼`);
            });

            // åŠ è½½æç¤ºè¯æ¨¡æ¿
            document.getElementById('load-prompt-template-btn').addEventListener('click', async () => {
                const selectedTemplate = summarizeConfig.templatesSelect.value;
                if (!selectedTemplate) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿ï¼');
                    return;
                }

                const templatesData = await idbStorage.getItem('summarize_prompt_templates');
                const templates = templatesData ? JSON.parse(templatesData) : {};
                if (templates[selectedTemplate]) {
                    summarizeConfig.prompt.value = templates[selectedTemplate];
                    alert(`å·²åŠ è½½æ¨¡æ¿ "${selectedTemplate}"`);
                }
            });

            // åˆ é™¤æç¤ºè¯æ¨¡æ¿
            document.getElementById('delete-prompt-template-btn').addEventListener('click', async () => {
                const selectedTemplate = summarizeConfig.templatesSelect.value;
                if (!selectedTemplate) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿ï¼');
                    return;
                }

                if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${selectedTemplate}" å—ï¼Ÿ`)) return;

                const templatesData = await idbStorage.getItem('summarize_prompt_templates');
                const templates = templatesData ? JSON.parse(templatesData) : {};
                delete templates[selectedTemplate];
                await idbStorage.setItem('summarize_prompt_templates', JSON.stringify(templates));

                await loadPromptTemplates();
                alert(`æ¨¡æ¿ "${selectedTemplate}" å·²åˆ é™¤ï¼`);
            });

            // æ¨¡å‹é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
            summarizeConfig.apiModelSelect.addEventListener('change', () => {
                const selected = summarizeConfig.apiModelSelect.value;
                if (selected === 'custom') {
                    summarizeConfig.apiModel.classList.remove('hidden');
                    summarizeConfig.apiModel.value = '';
                    summarizeConfig.apiModel.focus();
                } else if (selected) {
                    summarizeConfig.apiModel.classList.add('hidden');
                    summarizeConfig.apiModel.value = selected;
                }
            });

            // ä»APIè·å–æ¨¡å‹åˆ—è¡¨
            document.getElementById('fetch-models-btn').addEventListener('click', async () => {
                const btn = document.getElementById('fetch-models-btn');
                const resultDiv = document.getElementById('summarize-api-test-result');
                const icon = btn.querySelector('i');

                if (!summarizeConfig.apiUrl.value) {
                    resultDiv.innerHTML = 'è¯·å…ˆå¡«å†™APIåœ°å€ï¼';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                    return;
                }

                if (!summarizeConfig.apiKey.value) {
                    resultDiv.innerHTML = 'è¯·å…ˆå¡«å†™APIå¯†é’¥ï¼';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                    return;
                }

                try {
                    resultDiv.innerHTML = 'åŠ è½½ä¸­...';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-yellow-500';
                    icon.classList.add('fa-spin');
                    btn.disabled = true;

                    // å‚è€ƒä¸»APIå®ç°
                    const urlObj = new URL(summarizeConfig.apiUrl.value);
                    let modelsUrl;
                    let headers = {};

                    if (urlObj.hostname.includes('google')) {
                        modelsUrl = `${urlObj.origin}/v1beta/models?key=${summarizeConfig.apiKey.value}`;
                    } else {
                        const baseUrl = summarizeConfig.apiUrl.value.replace(/\/chat\/completions.*$/, '');
                        modelsUrl = `${baseUrl}/models`;
                        headers['Authorization'] = `Bearer ${summarizeConfig.apiKey.value}`;
                    }

                    const response = await fetch(modelsUrl, {
                        method: 'GET',
                        headers: headers
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        throw new Error(`HTTP ${response.status}: ${error.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    let models = [];

                    if (data.data) {
                        models = data.data; // OpenAIæ ¼å¼
                    } else if (data.models) {
                        models = data.models.map(m => ({ id: m.name.replace('models/', '') })); // Googleæ ¼å¼
                    }

                    if (models.length > 0) {
                        // æ¸…ç©ºç°æœ‰é€‰é¡¹
                        summarizeConfig.apiModelSelect.innerHTML = '<option value="">é€‰æ‹©æ¨¡å‹...</option>';

                        // æ·»åŠ è·å–åˆ°çš„æ¨¡å‹
                        models
                            .sort((a, b) => a.id.localeCompare(b.id))
                            .forEach(model => {
                                const option = document.createElement('option');
                                option.value = model.id;
                                option.textContent = model.id;
                                summarizeConfig.apiModelSelect.appendChild(option);
                            });

                        // æ·»åŠ è‡ªå®šä¹‰é€‰é¡¹
                        const customOption = document.createElement('option');
                        customOption.value = 'custom';
                        customOption.textContent = 'è‡ªå®šä¹‰...';
                        summarizeConfig.apiModelSelect.appendChild(customOption);

                        // å¦‚æœä¹‹å‰æœ‰é€‰ä¸­çš„æ¨¡å‹ï¼Œå°è¯•ä¿æŒé€‰ä¸­
                        const currentModel = summarizeConfig.apiModel.value;
                        const matchingOption = Array.from(summarizeConfig.apiModelSelect.options).find(opt => opt.value === currentModel);
                        if (matchingOption) {
                            summarizeConfig.apiModelSelect.value = currentModel;
                        }

                        resultDiv.innerHTML = `æˆåŠŸåŠ è½½ ${models.length} ä¸ªæ¨¡å‹ï¼`;
                        resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-green-500';
                    } else {
                        throw new Error('æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹');
                    }
                } catch (error) {
                    resultDiv.innerHTML = `è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${error.message}`;
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                } finally {
                    icon.classList.remove('fa-spin');
                    btn.disabled = false;
                }
            });

            // ä¿å­˜APIé…ç½®
            document.getElementById('save-summarize-api-config-btn').addEventListener('click', () => {
                saveSummarizeConfig();
                alert('APIé…ç½®å·²ä¿å­˜ï¼');
            });

            // åŠ è½½APIé…ç½®
            document.getElementById('load-summarize-api-config-btn').addEventListener('click', () => {
                loadSummarizeConfig();
                alert('APIé…ç½®å·²åŠ è½½ï¼');
            });

            // åŠ è½½æ€»ç»“é…ç½®
            async function loadSummarizeConfig() {
                const saved = await idbStorage.getItem('summarize_config');
                if (saved) {
                    const config = JSON.parse(saved);
                    summarizeConfig.apiUrl.value = config.apiUrl || '';
                    summarizeConfig.apiKey.value = config.apiKey || '';

                    // è®¾ç½®æ¨¡å‹
                    const modelValue = config.apiModel || 'gpt-4o-mini';
                    summarizeConfig.apiModel.value = modelValue;

                    // æ£€æŸ¥ä¸‹æ‹‰åˆ—è¡¨ä¸­æ˜¯å¦æœ‰è¿™ä¸ªæ¨¡å‹
                    const options = Array.from(summarizeConfig.apiModelSelect.options);
                    const matchingOption = options.find(opt => opt.value === modelValue);

                    if (matchingOption) {
                        summarizeConfig.apiModelSelect.value = modelValue;
                        summarizeConfig.apiModel.classList.add('hidden');
                    } else {
                        // å¦‚æœä¸‹æ‹‰åˆ—è¡¨ä¸­æ²¡æœ‰ï¼Œé€‰æ‹©"è‡ªå®šä¹‰"
                        summarizeConfig.apiModelSelect.value = 'custom';
                        summarizeConfig.apiModel.classList.remove('hidden');
                    }

                    summarizeConfig.floorCount.value = config.floorCount || 10;
                    summarizeConfig.prompt.value = config.prompt || summarizeConfig.prompt.value;
                    summarizeConfig.autoHide.checked = config.autoHide !== false;
                    summarizeConfig.autoEnable.checked = config.autoEnable || false;
                }
                await loadPromptTemplates();
            }

            // ä¿å­˜æ€»ç»“é…ç½®
            async function saveSummarizeConfig() {
                // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ¨¡å‹å€¼
                const selectedModel = summarizeConfig.apiModelSelect.value;
                if (selectedModel && selectedModel !== 'custom') {
                    summarizeConfig.apiModel.value = selectedModel;
                }

                const config = {
                    apiUrl: summarizeConfig.apiUrl.value,
                    apiKey: summarizeConfig.apiKey.value,
                    apiModel: summarizeConfig.apiModel.value,
                    floorCount: parseInt(summarizeConfig.floorCount.value) || 10,
                    prompt: summarizeConfig.prompt.value,
                    autoHide: summarizeConfig.autoHide.checked,
                    autoEnable: summarizeConfig.autoEnable.checked
                };
                await idbStorage.setItem('summarize_config', JSON.stringify(config));
            }

            // æ‰§è¡Œæ€»ç»“çš„æ ¸å¿ƒå‡½æ•°
            async function performSummarize(isAuto = false) {
                try {
                    const configData = await idbStorage.getItem('summarize_config');
                    const config = configData ? JSON.parse(configData) : {};

                    if (!config.apiUrl || !config.apiKey || !config.apiModel) {
                        if (!isAuto) alert('è¯·å…ˆé…ç½®å®Œæ•´çš„APIè®¾ç½®ï¼ˆURLã€å¯†é’¥ã€æ¨¡å‹ï¼‰ï¼');
                        return false;
                    }

                    const floorCount = parseInt(config.floorCount) || 10;
                    const visibleMessages = chatHistory.filter(m => !m.hidden);
                    // ä»ç¬¬1æ¡å¼€å§‹å¾€åå–,è€Œä¸æ˜¯ä»åå¾€å‰å–
                    const messagesToSummarize = visibleMessages.slice(0, Math.min(floorCount, visibleMessages.length));

                    if (messagesToSummarize.length === 0) {
                        if (!isAuto) alert('æ²¡æœ‰å¯æ€»ç»“çš„æ¶ˆæ¯ï¼');
                        return false;
                    }

                    console.log(`[æ€»ç»“] ${isAuto ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'}æ€»ç»“ ${messagesToSummarize.length} æ¡æ¶ˆæ¯`);

                    // æ„å»ºæ€»ç»“è¯·æ±‚ - å‚è€ƒä¸»APIçš„å®ç°
                    const conversationText = messagesToSummarize.map(msg =>
                        `${msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹'}: ${msg.content}`
                    ).join('\n\n');

                    // å‚è€ƒä¸»APIæ„å»ºendpointå’Œheaders
                    const urlObj = new URL(config.apiUrl);
                    let endpoint = `${config.apiUrl.replace(/\/$/, '')}`;
                    // å¦‚æœURLä¸åŒ…å«chat/completionsï¼Œæ·»åŠ å®ƒ
                    if (!endpoint.includes('/chat/completions')) {
                        endpoint = `${endpoint}/chat/completions`;
                    }

                    let headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    };

                    let body = {
                        model: config.apiModel,
                        messages: [
                            {
                                role: 'system',
                                content: config.prompt || 'è¯·ç®€æ˜æ‰¼è¦åœ°æ€»ç»“ä»¥ä¸‹å¯¹è¯å†…å®¹ã€‚'
                            },
                            {
                                role: 'user',
                                content: conversationText
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 500
                    };

                    // æ”¯æŒGoogle APIæ ¼å¼
                    if (urlObj.hostname.includes('google')) {
                        endpoint = `${urlObj.origin}/v1beta/models/${config.apiModel}:generateContent?key=${config.apiKey}`;
                        delete headers.Authorization;

                        body = {
                            contents: [
                                {
                                    role: 'user',
                                    parts: [{ text: `${config.prompt}\n\n${conversationText}` }]
                                }
                            ],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 500,
                            }
                        };
                    }

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        throw new Error(error.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    let summary = '';

                    // å¤„ç†ä¸åŒæ ¼å¼çš„å“åº”
                    if (result.choices) {
                        // OpenAIæ ¼å¼
                        summary = result.choices[0].message.content;
                    } else if (result.candidates) {
                        // Googleæ ¼å¼
                        summary = result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('æ— æ³•è§£æAPIå“åº”æ ¼å¼');
                    }

                    console.log('[æ€»ç»“] æ€»ç»“ç»“æœ:', summary);

                    // æ·»åŠ æ€»ç»“åˆ°è§’è‰²ä¸–ç•Œä¹¦
                    const activeChar = char.data[char.activeCharacterId];
                    if (activeChar) {
                        if (!activeChar.data.character_book) {
                            activeChar.data.character_book = {
                                name: `${activeChar.name}çš„è®°å¿†`,
                                entries: []
                            };
                        }

                        // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨æ€»ç»“æ¡ç›®
                        let summaryEntry = activeChar.data.character_book.entries.find(
                            entry => entry.keys && entry.keys.includes('æ€»ç»“')
                        );

                        if (summaryEntry) {
                            // å·²å­˜åœ¨æ€»ç»“æ¡ç›®,è¿½åŠ æ–°å†…å®¹
                            const timestamp = new Date().toLocaleString();
                            summaryEntry.content += `\n\n---[${isAuto ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'}æ€»ç»“ ${timestamp}]---\n${summary}`;
                            summaryEntry.name = `èŠå¤©æ€»ç»“ (æœ€åæ›´æ–°: ${timestamp})`;
                            console.log('[æ€»ç»“] å·²è¿½åŠ åˆ°ç°æœ‰æ€»ç»“æ¡ç›®');
                        } else {
                            // ä¸å­˜åœ¨æ€»ç»“æ¡ç›®,åˆ›å»ºæ–°çš„
                            summaryEntry = {
                                id: `summary_${Date.now()}`,
                                enabled: true,
                                name: `èŠå¤©æ€»ç»“ (åˆ›å»º: ${new Date().toLocaleString()})`,
                                keys: ['æ€»ç»“', 'è®°å¿†', 'å›å¿†'],
                                content: summary,
                                case_sensitive: false,
                                whole_word: false,
                                position: 0,
                                role: 0,
                                scan_depth: 100,
                                use_regex: false
                            };
                            activeChar.data.character_book.entries.push(summaryEntry);
                            console.log('[æ€»ç»“] å·²åˆ›å»ºæ–°çš„æ€»ç»“æ¡ç›®');
                        }

                        saveCharacters();
                        console.log('[æ€»ç»“] å·²ä¿å­˜åˆ°è§’è‰²ä¸–ç•Œä¹¦');
                    }

                    // éšè—å·²æ€»ç»“çš„æ¶ˆæ¯
                    if (config.autoHide) {
                        messagesToSummarize.forEach(msg => {
                            msg.hidden = true;
                        });
                        saveChat();
                        renderMessages();
                        console.log(`[æ€»ç»“] å·²éšè— ${messagesToSummarize.length} æ¡æ¶ˆæ¯`);
                    }

                    if (!isAuto) {
                        alert(`æ€»ç»“æˆåŠŸï¼\n\nå·²æ€»ç»“ ${messagesToSummarize.length} æ¡æ¶ˆæ¯ï¼Œå¹¶æ·»åŠ åˆ°è§’è‰²ä¸–ç•Œä¹¦ã€‚\n\n${config.autoHide ? 'å·²éšè—æ€»ç»“è¿‡çš„æ¶ˆæ¯ã€‚' : ''}`);
                    }

                    return true;
                } catch (error) {
                    console.error('[æ€»ç»“] å¤±è´¥:', error);
                    if (!isAuto) {
                        alert(`æ€»ç»“å¤±è´¥: ${error.message}`);
                    }
                    return false;
                }
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨æ€»ç»“
            async function checkAutoSummarize() {
                const configData = await idbStorage.getItem('summarize_config');
                const config = configData ? JSON.parse(configData) : {};

                if (!config.autoEnable) return;
                if (!config.apiUrl || !config.apiKey) return;

                const floorCount = parseInt(config.floorCount) || 10;
                const visibleMessages = chatHistory.filter(m => !m.hidden);

                if (visibleMessages.length >= floorCount) {
                    console.log('[è‡ªåŠ¨æ€»ç»“] è¾¾åˆ°è§¦å‘æ¡ä»¶ï¼Œå¼€å§‹æ€»ç»“...');
                    await performSummarize(true);
                }
            }

            // æ‰“å¼€æ€»ç»“æ¨¡æ€æ¡†
            document.getElementById('menu-summarize-btn').addEventListener('click', () => {
                loadSummarizeConfig();
                if (summarizeConfig.modal) {
                    summarizeConfig.modal.classList.add('active');
                }
                const menuDropdown = document.getElementById('menu-dropdown');
                if (menuDropdown) {
                    menuDropdown.classList.remove('active');
                }
            });

            // æ€»ç»“èŠå¤©å¼¹çª—å…³é—­æŒ‰é’®
            document.getElementById('summarize-modal-close').addEventListener('click', () => {
                const modal = document.getElementById('summarize-modal');
                if (modal) {
                    modal.classList.remove('active');
                }
            });

            // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
            document.getElementById('summarize-modal').addEventListener('click', (e) => {
                if (e.target.id === 'summarize-modal') {
                    e.target.classList.remove('active');
                }
            });

            // æµ‹è¯•API - å‘é€æµ‹è¯•æ¶ˆæ¯
            document.getElementById('test-summarize-api-btn').addEventListener('click', async () => {
                const btn = document.getElementById('test-summarize-api-btn');
                const resultDiv = document.getElementById('summarize-api-test-result');
                const originalHtml = btn.innerHTML;

                // å…ˆä¿å­˜é…ç½®
                saveSummarizeConfig();

                // éªŒè¯å¿…å¡«é¡¹
                if (!summarizeConfig.apiUrl.value || !summarizeConfig.apiKey.value) {
                    resultDiv.innerHTML = 'è¯·å…ˆå¡«å†™APIåœ°å€å’Œå¯†é’¥ï¼';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                    return;
                }

                if (!summarizeConfig.apiModel.value) {
                    resultDiv.innerHTML = 'è¯·å…ˆé€‰æ‹©æ¨¡å‹ï¼';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                    return;
                }

                try {
                    resultDiv.innerHTML = 'æµ‹è¯•ä¸­...';
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-yellow-500';
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æµ‹è¯•ä¸­...';
                    btn.disabled = true;

                    // å‚è€ƒä¸»APIçš„å®ç°æ„å»ºè¯·æ±‚
                    const urlObj = new URL(summarizeConfig.apiUrl.value);
                    let endpoint = `${summarizeConfig.apiUrl.value.replace(/\/$/, '')}`;
                    if (!endpoint.includes('/chat/completions')) {
                        endpoint = `${endpoint}/chat/completions`;
                    }

                    let headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${summarizeConfig.apiKey.value}`
                    };

                    let body = {
                        model: summarizeConfig.apiModel.value,
                        messages: [{
                            role: 'user',
                            content: 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªAPIè¿æ¥æµ‹è¯•ï¼Œè¯·ç®€å•å›å¤"è¿æ¥æˆåŠŸ"ã€‚'
                        }],
                        max_tokens: 50
                    };

                    // æ”¯æŒGoogle API
                    if (urlObj.hostname.includes('google')) {
                        endpoint = `${urlObj.origin}/v1beta/models/${summarizeConfig.apiModel.value}:generateContent?key=${summarizeConfig.apiKey.value}`;
                        delete headers.Authorization;

                        body = {
                            contents: [{
                                role: 'user',
                                parts: [{ text: 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªAPIè¿æ¥æµ‹è¯•ï¼Œè¯·ç®€å•å›å¤"è¿æ¥æˆåŠŸ"ã€‚' }]
                            }],
                            generationConfig: {
                                maxOutputTokens: 50
                            }
                        };
                    }

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(body)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        let reply = '';

                        if (data.choices) {
                            reply = data.choices[0].message.content;
                        } else if (data.candidates) {
                            reply = data.candidates[0].content.parts[0].text;
                        }

                        resultDiv.innerHTML = `æµ‹è¯•æˆåŠŸï¼å›å¤: ${reply.substring(0, 50)}...`;
                        resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-green-500';
                    } else {
                        const error = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        throw new Error(`HTTP ${response.status}: ${error.error?.message || response.statusText}`);
                    }
                } catch (error) {
                    resultDiv.innerHTML = `æµ‹è¯•å¤±è´¥: ${error.message}`;
                    resultDiv.className = 'text-sm mt-2 text-center h-auto min-h-[1rem] text-red-500';
                } finally {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            });

            // å¼€å§‹æ€»ç»“
            document.getElementById('start-summarize-btn').addEventListener('click', async () => {
                const btn = document.getElementById('start-summarize-btn');
                const originalHtml = btn.innerHTML;

                try {
                    // ä¿å­˜é…ç½®
                    saveSummarizeConfig();

                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æ€»ç»“ä¸­...';
                    btn.disabled = true;

                    const success = await performSummarize(false);

                    if (success) {
                        summarizeConfig.modal.classList.remove('active');
                    }
                } finally {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }
            });

            // åœ¨å‘é€æ¶ˆæ¯åæ£€æŸ¥è‡ªåŠ¨æ€»ç»“
            const originalSendMessage = sendMessage;
            sendMessage = async function(...args) {
                await originalSendMessage.apply(this, args);

                // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿æ¶ˆæ¯å·²æ·»åŠ 
                setTimeout(() => {
                    checkAutoSummarize();
                }, 1000);
            };

            // --- Native Bridge (WebView2) ---
            if (window.chrome && window.chrome.webview) {
                const nativeState = { pendingId: null };

                const originalAddMessageToHistory = addMessageToHistory;
                addMessageToHistory = async function(messageData) {
                    await originalAddMessageToHistory(messageData);
                    if (nativeState.pendingId && messageData.role === 'assistant') {
                        window.chrome.webview.postMessage({
                            type: 'reply',
                            id: nativeState.pendingId,
                            content: messageData.content
                        });
                        nativeState.pendingId = null;
                    }
                };

                window.chrome.webview.addEventListener('message', async (event) => {
                    try {
                        const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                        if (data.type === 'send') {
                            const userInput = (data.text || '').trim();
                            if (!userInput) return;

                            if (!char.activeCharacterId) {
                                window.chrome.webview.postMessage({
                                    type: 'error',
                                    id: data.id || null,
                                    message: 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²!'
                                });
                                return;
                            }

                            const apiConfig = getCurrentApiConfig();
                            if (!apiConfig?.url || !apiConfig?.key || !apiConfig.model) {
                                window.chrome.webview.postMessage({
                                    type: 'error',
                                    id: data.id || null,
                                    message: 'API è®¾ç½®ä¸å®Œæ•´ã€‚è¯·åœ¨APIè®¾ç½®ä¸­é…ç½® URL, Key, å’Œæ¨¡å‹ã€‚'
                                });
                                return;
                            }

                            nativeState.pendingId = data.id || null;
                            const prevStreaming = apiConfig.streaming;
                            apiConfig.streaming = false;

                            addMessageToHistory({role: 'user', content: userInput, type: 'text', replyTo: null});
                            await sendApiRequest();

                            apiConfig.streaming = prevStreaming;
                        }
                    } catch (e) {
                        window.chrome.webview.postMessage({
                            type: 'error',
                            id: null,
                            message: e.message || 'Native bridge error'
                        });
                    }
                });
            }

            // åˆå§‹åŒ–
            loadSummarizeConfig();

        });
    </script>

    <!-- ä¿å­˜æç¤ºToast -->
    <div id="save-toast" class="save-toast">
        <div class="icon">
            <i class="fas fa-check"></i>
        </div>
        <div class="message">å·²è‡ªåŠ¨ä¿å­˜</div>
    </div>

</body>
</html>